<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>LogCabin: Server/RaftConsensus.cc Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">LogCabin
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">Server/RaftConsensus.cc</div>  </div>
</div><!--header-->
<div class="contents">
<a href="RaftConsensus_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* Copyright (c) 2012 Stanford University</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (c) 2015 Diego Ongaro</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Permission to use, copy, modify, and distribute this software for any</span>
<a name="l00005"></a>00005 <span class="comment"> * purpose with or without fee is hereby granted, provided that the above</span>
<a name="l00006"></a>00006 <span class="comment"> * copyright notice and this permission notice appear in all copies.</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR(S) DISCLAIM ALL WARRANTIES</span>
<a name="l00009"></a>00009 <span class="comment"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<a name="l00010"></a>00010 <span class="comment"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL AUTHORS BE LIABLE FOR</span>
<a name="l00011"></a>00011 <span class="comment"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<a name="l00012"></a>00012 <span class="comment"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<a name="l00013"></a>00013 <span class="comment"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<a name="l00014"></a>00014 <span class="comment"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<a name="l00015"></a>00015 <span class="comment"> */</span>
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;algorithm&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;limits&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;sys/file.h&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;build/Protocol/Raft.pb.h&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;build/Server/SnapshotMetadata.pb.h&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="Buffer_8h.html">Core/Buffer.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="Core_2Debug_8h.html">Core/Debug.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="Core_2ProtoBuf_8h.html" title="Utilities for dealing with protocol buffers.">Core/ProtoBuf.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="Random_8h.html">Core/Random.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="StringUtil_8h.html">Core/StringUtil.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="ThreadId_8h.html">Core/ThreadId.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="Core_2Util_8h.html" title="Common utilities and definitions.">Core/Util.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="Common_8h.html" title="This file contains declarations useful to all LogCabin RPCs.">Protocol/Common.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="ClientRPC_8h.html">RPC/ClientRPC.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="ClientSession_8h.html">RPC/ClientSession.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="ServerRPC_8h.html">RPC/ServerRPC.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="RaftConsensus_8h.html">Server/RaftConsensus.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="Globals_8h.html">Server/Globals.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="LogFactory_8h.html">Storage/LogFactory.h</a>&quot;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="keyword">namespace </span>LogCabin {
<a name="l00044"></a>00044 <span class="keyword">namespace </span>Server {
<a name="l00045"></a>00045 
<a name="l00046"></a><a class="code" href="namespaceLogCabin_1_1Server.html#a6e97183c2664581697720b1158ad75a2">00046</a> <span class="keyword">typedef</span> <a class="code" href="classLogCabin_1_1Storage_1_1Log.html" title="This interface is used by RaftConsensus to store log entries and metadata.">Storage::Log</a> <a class="code" href="namespaceLogCabin_1_1Server.html#a6e97183c2664581697720b1158ad75a2">Log</a>;
<a name="l00047"></a>00047 
<a name="l00048"></a><a class="code" href="namespaceLogCabin_1_1Server_1_1RaftConsensusInternal.html">00048</a> <span class="keyword">namespace </span>RaftConsensusInternal {
<a name="l00049"></a>00049 
<a name="l00050"></a><a class="code" href="namespaceLogCabin_1_1Server_1_1RaftConsensusInternal.html#aa3a20ec5673f7f239631c204201a57e0">00050</a> <span class="keywordtype">bool</span> <a class="code" href="namespaceLogCabin_1_1Server_1_1RaftConsensusInternal.html#aa3a20ec5673f7f239631c204201a57e0" title="True if this should actually spawn threads, false otherwise.">startThreads</a> = <span class="keyword">true</span>;
<a name="l00051"></a>00051 <span class="comment"></span>
<a name="l00052"></a>00052 <span class="comment">////////// Server //////////</span>
<a name="l00053"></a>00053 <span class="comment"></span>
<a name="l00054"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#a89339f6c3b0d20e114d6b110ff638ee8">00054</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#a89339f6c3b0d20e114d6b110ff638ee8" title="Constructor.">Server::Server</a>(uint64_t serverId)
<a name="l00055"></a>00055     : serverId(serverId)
<a name="l00056"></a>00056     , addresses()
<a name="l00057"></a>00057     , haveStateMachineSupportedVersions(false)
<a name="l00058"></a>00058     , minStateMachineVersion(std::numeric_limits&lt;uint16_t&gt;::max())
<a name="l00059"></a>00059     , maxStateMachineVersion(0)
<a name="l00060"></a>00060     , gcFlag(false)
<a name="l00061"></a>00061 {
<a name="l00062"></a>00062 }
<a name="l00063"></a>00063 
<a name="l00064"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#ae9fd29479452761eeba68d7e577f34d8">00064</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#ae9fd29479452761eeba68d7e577f34d8" title="Destructor.">Server::~Server</a>()
<a name="l00065"></a>00065 {
<a name="l00066"></a>00066 }
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 std::ostream&amp;
<a name="l00069"></a><a class="code" href="namespaceLogCabin_1_1Server_1_1RaftConsensusInternal.html#ae6c452fe910faa2e4aee2efaeaaf0fd3">00069</a> <a class="code" href="namespaceLogCabin_1_1Server_1_1RaftConsensusInternal.html#ae6c452fe910faa2e4aee2efaeaaf0fd3">operator&lt;&lt;</a>(std::ostream&amp; os, <span class="keyword">const</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html" title="A base class for known servers in the cluster, including this process (see LocalServer) and others (s...">Server</a>&amp; server)
<a name="l00070"></a>00070 {
<a name="l00071"></a>00071     <span class="keywordflow">return</span> server.dumpToStream(os);
<a name="l00072"></a>00072 }
<a name="l00073"></a>00073 <span class="comment"></span>
<a name="l00074"></a>00074 <span class="comment">////////// LocalServer //////////</span>
<a name="l00075"></a>00075 <span class="comment"></span>
<a name="l00076"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#a04ba6976e9e92986869fe14a3da65166">00076</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#a04ba6976e9e92986869fe14a3da65166">LocalServer::LocalServer</a>(uint64_t serverId, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html" title="An implementation of the Raft consensus algorithm.">RaftConsensus</a>&amp; consensus)
<a name="l00077"></a>00077     : <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html" title="A base class for known servers in the cluster, including this process (see LocalServer) and others (s...">Server</a>(serverId)
<a name="l00078"></a>00078     , consensus(consensus)
<a name="l00079"></a>00079     , lastSyncedIndex(0)
<a name="l00080"></a>00080 {
<a name="l00081"></a>00081 }
<a name="l00082"></a>00082 
<a name="l00083"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#af8e946ae3c1e53dfd90c9796b02930e5">00083</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#af8e946ae3c1e53dfd90c9796b02930e5">LocalServer::~LocalServer</a>()
<a name="l00084"></a>00084 {
<a name="l00085"></a>00085 }
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="keywordtype">void</span>
<a name="l00088"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#ac3e344c14b56bde9c89ce29b8d4ae4f9">00088</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#ac3e344c14b56bde9c89ce29b8d4ae4f9" title="Begin requesting the Server&#39;s vote in the current election.">LocalServer::beginRequestVote</a>()
<a name="l00089"></a>00089 {
<a name="l00090"></a>00090 }
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 <span class="keywordtype">void</span>
<a name="l00093"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#a59663bf7fc26786c1ef25c90ece3bfa5">00093</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#a59663bf7fc26786c1ef25c90ece3bfa5" title="Begin replicating to the Server in the current term.">LocalServer::beginLeadership</a>()
<a name="l00094"></a>00094 {
<a name="l00095"></a>00095     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#afb49b56a95bb00a9e51c40565ab57bf5" title="The index of the last log entry that has been flushed to disk.">lastSyncedIndex</a> = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#acb15fa69e6a58e5b11e0b18454f679ea">consensus</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex();
<a name="l00096"></a>00096 }
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 <span class="keywordtype">void</span>
<a name="l00099"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#acbbe0af35379c8891b25994424e5abe5">00099</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#acbbe0af35379c8891b25994424e5abe5" title="Inform any threads belonging to this Server to exit.">LocalServer::exit</a>()
<a name="l00100"></a>00100 {
<a name="l00101"></a>00101 }
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 uint64_t
<a name="l00104"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#ad36cd81c3d4ae8293f4a5219d0c6d121">00104</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#ad36cd81c3d4ae8293f4a5219d0c6d121" title="Return the latest time this Server acknowledged our current term.">LocalServer::getLastAckEpoch</a>()<span class="keyword"> const</span>
<a name="l00105"></a>00105 <span class="keyword"></span>{
<a name="l00106"></a>00106     <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#acb15fa69e6a58e5b11e0b18454f679ea">consensus</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1ab1473657769c339579f02f7e454513" title="A logical clock used to confirm leadership and connectivity.">currentEpoch</a>;
<a name="l00107"></a>00107 }
<a name="l00108"></a>00108 
<a name="l00109"></a>00109 uint64_t
<a name="l00110"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#a0a6c42fe404b4a624b6b3660b505fe62">00110</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#a0a6c42fe404b4a624b6b3660b505fe62" title="Return the largest entry ID for which this Server is known to share the same entries up to and includ...">LocalServer::getLastAgreeIndex</a>()<span class="keyword"> const</span>
<a name="l00111"></a>00111 <span class="keyword"></span>{
<a name="l00112"></a>00112     <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#afb49b56a95bb00a9e51c40565ab57bf5" title="The index of the last log entry that has been flushed to disk.">lastSyncedIndex</a>;
<a name="l00113"></a>00113 }
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 <span class="keywordtype">bool</span>
<a name="l00116"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#a7791d0dedf53d637f6a2df75caa4b36c">00116</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#a7791d0dedf53d637f6a2df75caa4b36c" title="Return true if this Server has awarded us its vote for this term.">LocalServer::haveVote</a>()<span class="keyword"> const</span>
<a name="l00117"></a>00117 <span class="keyword"></span>{
<a name="l00118"></a>00118     <span class="keywordflow">return</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#acb15fa69e6a58e5b11e0b18454f679ea">consensus</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1add1a4497b990f9f4b053266459b59d" title="The server ID that this server voted for during this term&#39;s election, if any.">votedFor</a> == <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#ac1b2d6d134b4c41baf0220a0c6e587b7" title="The ID of this server.">serverId</a>);
<a name="l00119"></a>00119 }
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 <span class="keywordtype">void</span>
<a name="l00122"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#a702ef4e87b2389c19c3540875af24b05">00122</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#a702ef4e87b2389c19c3540875af24b05" title="Cancel any outstanding RPCs to this Server.">LocalServer::interrupt</a>()
<a name="l00123"></a>00123 {
<a name="l00124"></a>00124 }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126 <span class="keywordtype">bool</span>
<a name="l00127"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#a4a30d84e679c9df0e57b61ee404dd766">00127</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#a4a30d84e679c9df0e57b61ee404dd766" title="Return true once this Server is ready to be added to the cluster.">LocalServer::isCaughtUp</a>()<span class="keyword"> const</span>
<a name="l00128"></a>00128 <span class="keyword"></span>{
<a name="l00129"></a>00129     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00130"></a>00130 }
<a name="l00131"></a>00131 
<a name="l00132"></a>00132 <span class="keywordtype">void</span>
<a name="l00133"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#a3ce146d3470eac69cfc9baf9ca378df8">00133</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#a3ce146d3470eac69cfc9baf9ca378df8" title="Make the next heartbeat RPC happen soon.">LocalServer::scheduleHeartbeat</a>()
<a name="l00134"></a>00134 {
<a name="l00135"></a>00135 }
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 std::ostream&amp;
<a name="l00138"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#aeae52f0bcdd34d29f22a67bf194a2438">00138</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#aeae52f0bcdd34d29f22a67bf194a2438" title="Virtual method for operator&lt;&lt;.">LocalServer::dumpToStream</a>(std::ostream&amp; os)<span class="keyword"> const</span>
<a name="l00139"></a>00139 <span class="keyword"></span>{
<a name="l00140"></a>00140     <span class="comment">// Nothing interesting to dump.</span>
<a name="l00141"></a>00141     <span class="keywordflow">return</span> os;
<a name="l00142"></a>00142 }
<a name="l00143"></a>00143 
<a name="l00144"></a>00144 <span class="keywordtype">void</span>
<a name="l00145"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#a103571cec603a72cee1a1135df41fd67">00145</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#a103571cec603a72cee1a1135df41fd67" title="Write this Server&#39;s state into the given structure.">LocalServer::updatePeerStats</a>(Protocol::ServerStats::Raft::Peer&amp; peerStats,
<a name="l00146"></a>00146                              <a class="code" href="classLogCabin_1_1Core_1_1Time_1_1SteadyTimeConverter.html" title="Used to convert one or more SteadyClock::time_point values into values of the SystemClock.">Core::Time::SteadyTimeConverter</a>&amp; time)<span class="keyword"> const</span>
<a name="l00147"></a>00147 <span class="keyword"></span>{
<a name="l00148"></a>00148     <span class="keywordflow">switch</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#acb15fa69e6a58e5b11e0b18454f679ea">consensus</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a>) {
<a name="l00149"></a>00149         <span class="keywordflow">case</span> RaftConsensus::State::FOLLOWER:
<a name="l00150"></a>00150             <span class="keywordflow">break</span>;
<a name="l00151"></a>00151         <span class="keywordflow">case</span> RaftConsensus::State::CANDIDATE:
<a name="l00152"></a>00152             <span class="keywordflow">break</span>;
<a name="l00153"></a>00153         <span class="keywordflow">case</span> RaftConsensus::State::LEADER:
<a name="l00154"></a>00154             peerStats.set_last_synced_index(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html#afb49b56a95bb00a9e51c40565ab57bf5" title="The index of the last log entry that has been flushed to disk.">lastSyncedIndex</a>);
<a name="l00155"></a>00155             <span class="keywordflow">break</span>;
<a name="l00156"></a>00156     }
<a name="l00157"></a>00157 }
<a name="l00158"></a>00158 <span class="comment"></span>
<a name="l00159"></a>00159 <span class="comment">////////// Peer //////////</span>
<a name="l00160"></a>00160 <span class="comment"></span>
<a name="l00161"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#ab658a5a52b9183a271843a5279d31ac9">00161</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#ab658a5a52b9183a271843a5279d31ac9" title="Constructor.">Peer::Peer</a>(uint64_t serverId, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html" title="An implementation of the Raft consensus algorithm.">RaftConsensus</a>&amp; consensus)
<a name="l00162"></a>00162     : <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html" title="A base class for known servers in the cluster, including this process (see LocalServer) and others (s...">Server</a>(serverId)
<a name="l00163"></a>00163     , consensus(consensus)
<a name="l00164"></a>00164     , eventLoop(consensus.globals.eventLoop)
<a name="l00165"></a>00165     , exiting(false)
<a name="l00166"></a>00166     , requestVoteDone(false)
<a name="l00167"></a>00167     , haveVote_(false)
<a name="l00168"></a>00168     , forceHeartbeat(true)
<a name="l00169"></a>00169       <span class="comment">// It&#39;s somewhat important to set nextIndex correctly here, since peers</span>
<a name="l00170"></a>00170       <span class="comment">// that are added to the configuration won&#39;t go through beginLeadership()</span>
<a name="l00171"></a>00171       <span class="comment">// on the current leader. I say somewhat important because, if nextIndex</span>
<a name="l00172"></a>00172       <span class="comment">// is set incorrectly, it&#39;s self-correcting, so it&#39;s just a potential</span>
<a name="l00173"></a>00173       <span class="comment">// performance issue.</span>
<a name="l00174"></a>00174     , nextIndex(consensus.<a class="code" href="namespaceLogCabin_1_1Core_1_1Debug.html#ac6edb3bfbfca4fc5ae5a98a0c36ffdda" title="Unconditionally log the given message to stderr.">log</a>-&gt;getLastLogIndex() + 1)
<a name="l00175"></a>00175     , lastAgreeIndex(0)
<a name="l00176"></a>00176     , lastAckEpoch(0)
<a name="l00177"></a>00177     , nextHeartbeatTime(<a class="code" href="namespaceLogCabin_1_1Server_1_1RaftConsensusInternal.html#a9b2ddcfb6434331d10e3ed84c66e14e3" title="Some point in time relative to the Clock&#39;s epoch.">TimePoint</a>::min())
<a name="l00178"></a>00178     , backoffUntil(<a class="code" href="namespaceLogCabin_1_1Server_1_1RaftConsensusInternal.html#a9b2ddcfb6434331d10e3ed84c66e14e3" title="Some point in time relative to the Clock&#39;s epoch.">TimePoint</a>::min())
<a name="l00179"></a>00179     , rpcFailuresSinceLastWarning(0)
<a name="l00180"></a>00180     , lastCatchUpIterationMs(~0UL)
<a name="l00181"></a>00181     , thisCatchUpIterationStart(<a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html" title="Reads the current time.">Clock</a>::now())
<a name="l00182"></a>00182     , thisCatchUpIterationGoalId(~0UL)
<a name="l00183"></a>00183     , isCaughtUp_(false)
<a name="l00184"></a>00184     , snapshotFile()
<a name="l00185"></a>00185     , snapshotFileOffset(0)
<a name="l00186"></a>00186     , lastSnapshotIndex(0)
<a name="l00187"></a>00187     , session()
<a name="l00188"></a>00188     , rpc()
<a name="l00189"></a>00189 {
<a name="l00190"></a>00190 }
<a name="l00191"></a>00191 
<a name="l00192"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a33cb93c3fc8e2aefe48e832b46d27b8f">00192</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a33cb93c3fc8e2aefe48e832b46d27b8f" title="Destructor.">Peer::~Peer</a>()
<a name="l00193"></a>00193 {
<a name="l00194"></a>00194 }
<a name="l00195"></a>00195 
<a name="l00196"></a>00196 <span class="keywordtype">void</span>
<a name="l00197"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#aa7a24ef9188194eefe118684d66a2ec5">00197</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#aa7a24ef9188194eefe118684d66a2ec5" title="Begin requesting the Server&#39;s vote in the current election.">Peer::beginRequestVote</a>()
<a name="l00198"></a>00198 {
<a name="l00199"></a>00199     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#ac4a82cf70a21989f2f59505281647c3f" title="Set to true if the server has responded to our RequestVote request in the current term...">requestVoteDone</a> = <span class="keyword">false</span>;
<a name="l00200"></a>00200     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a57b21af23dcbefa804c9c962591e5025" title="See haveVote().">haveVote_</a> = <span class="keyword">false</span>;
<a name="l00201"></a>00201 }
<a name="l00202"></a>00202 
<a name="l00203"></a>00203 <span class="keywordtype">void</span>
<a name="l00204"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#ad5ba27d28751c0c5c12e3670f7055afd">00204</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#ad5ba27d28751c0c5c12e3670f7055afd" title="Begin replicating to the Server in the current term.">Peer::beginLeadership</a>()
<a name="l00205"></a>00205 {
<a name="l00206"></a>00206     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a681aed27116449b0ec7705e85f09fd07" title="The index of the next entry to send to the follower.">nextIndex</a> = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#aab8969e0bf7d7c361908ad13073a6d2d" title="Used in startThread.">consensus</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex() + 1;
<a name="l00207"></a>00207     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a2af3be3d3ac5cfb2c79270d084f01e21" title="See getLastAgreeIndex().">lastAgreeIndex</a> = 0;
<a name="l00208"></a>00208     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a50d0b442ca40959e135e45107a8c6c76" title="Indicates that nextIndex is still a (poor) guess: the leader should send heartbeats to save bandwidth...">forceHeartbeat</a> = <span class="keyword">true</span>;
<a name="l00209"></a>00209     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#ad26b3c377e98b3ae5f0818b7b76908fd" title="A snapshot file to be sent to the follower, or NULL.">snapshotFile</a>.reset();
<a name="l00210"></a>00210     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a71e8fe01080a5c648184fcada409c56a" title="The number of bytes of &#39;snapshotFile&#39; that have been acknowledged by the follower already...">snapshotFileOffset</a> = 0;
<a name="l00211"></a>00211     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a4a814e3469c1609f999488037a01087c" title="The last log index that &#39;snapshotFile&#39; corresponds to.">lastSnapshotIndex</a> = 0;
<a name="l00212"></a>00212 }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214 <span class="keywordtype">void</span>
<a name="l00215"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a46d99021b75d28c44c31cbe4fe221001">00215</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a46d99021b75d28c44c31cbe4fe221001" title="Inform any threads belonging to this Server to exit.">Peer::exit</a>()
<a name="l00216"></a>00216 {
<a name="l00217"></a>00217     <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Flagging peer %lu to exit&quot;</span>, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#ac1b2d6d134b4c41baf0220a0c6e587b7" title="The ID of this server.">serverId</a>);
<a name="l00218"></a>00218     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#afcc06ccb9c33a32eee1503aa5b1ee205" title="Set to true when thread should exit.">exiting</a> = <span class="keyword">true</span>;
<a name="l00219"></a>00219 }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221 uint64_t
<a name="l00222"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a2a60ec5adc78780464eff2eaaf625d86">00222</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a2a60ec5adc78780464eff2eaaf625d86" title="Return the latest time this Server acknowledged our current term.">Peer::getLastAckEpoch</a>()<span class="keyword"> const</span>
<a name="l00223"></a>00223 <span class="keyword"></span>{
<a name="l00224"></a>00224     <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a3ac99d0f0a94203643ac72cf4e4c0e69" title="See getLastAckEpoch().">lastAckEpoch</a>;
<a name="l00225"></a>00225 }
<a name="l00226"></a>00226 
<a name="l00227"></a>00227 uint64_t
<a name="l00228"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a74f6a5c2c9950c94cf61c1c302f9d84f">00228</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a74f6a5c2c9950c94cf61c1c302f9d84f" title="Return the largest entry ID for which this Server is known to share the same entries up to and includ...">Peer::getLastAgreeIndex</a>()<span class="keyword"> const</span>
<a name="l00229"></a>00229 <span class="keyword"></span>{
<a name="l00230"></a>00230     <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a2af3be3d3ac5cfb2c79270d084f01e21" title="See getLastAgreeIndex().">lastAgreeIndex</a>;
<a name="l00231"></a>00231 }
<a name="l00232"></a>00232 
<a name="l00233"></a>00233 <span class="keywordtype">bool</span>
<a name="l00234"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a31e4de7206ec311e2bd8e9f912a284d0">00234</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a31e4de7206ec311e2bd8e9f912a284d0" title="Return true if this Server has awarded us its vote for this term.">Peer::haveVote</a>()<span class="keyword"> const</span>
<a name="l00235"></a>00235 <span class="keyword"></span>{
<a name="l00236"></a>00236     <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a57b21af23dcbefa804c9c962591e5025" title="See haveVote().">haveVote_</a>;
<a name="l00237"></a>00237 }
<a name="l00238"></a>00238 
<a name="l00239"></a>00239 <span class="keywordtype">void</span>
<a name="l00240"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a5daf374d78d59b74c639acef42f8b1e5">00240</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a5daf374d78d59b74c639acef42f8b1e5" title="Cancel any outstanding RPCs to this Server.">Peer::interrupt</a>()
<a name="l00241"></a>00241 {
<a name="l00242"></a>00242     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a6152a1441ad8d36900beae23b8adb231" title="callRPC() places its RPC here so that interrupt() may cancel it.">rpc</a>.<a class="code" href="classLogCabin_1_1RPC_1_1ClientRPC.html#a70a114004ad27fac8bbc41dda1a27e1c" title="Abort the RPC.">cancel</a>();
<a name="l00243"></a>00243 }
<a name="l00244"></a>00244 
<a name="l00245"></a>00245 <span class="keywordtype">bool</span>
<a name="l00246"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a81973f60b1302672c5d0c582a4638f4b">00246</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a81973f60b1302672c5d0c582a4638f4b" title="Return true once this Server is ready to be added to the cluster.">Peer::isCaughtUp</a>()<span class="keyword"> const</span>
<a name="l00247"></a>00247 <span class="keyword"></span>{
<a name="l00248"></a>00248     <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#aa35915b9016d63af612039b1eea9c9bf" title="See isCaughtUp().">isCaughtUp_</a>;
<a name="l00249"></a>00249 }
<a name="l00250"></a>00250 
<a name="l00251"></a>00251 <span class="keywordtype">void</span>
<a name="l00252"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a8cf12a4c6290d1ea99c3e4074fced205">00252</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a8cf12a4c6290d1ea99c3e4074fced205" title="Make the next heartbeat RPC happen soon.">Peer::scheduleHeartbeat</a>()
<a name="l00253"></a>00253 {
<a name="l00254"></a>00254     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#af3115d040af27bfe093f1881fd243716" title="When the next heartbeat should be sent to the follower.">nextHeartbeatTime</a> = <a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a13f545c6020dd190e13d21e2577cc59b">Clock::now</a>();
<a name="l00255"></a>00255 }
<a name="l00256"></a>00256 
<a name="l00257"></a>00257 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a0548ee7eb046a903349a22ff0a3c7bda" title="Returned by callRPC().">Peer::CallStatus</a>
<a name="l00258"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a4305e63041b96ea33cb28deaf2378b1c">00258</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a4305e63041b96ea33cb28deaf2378b1c" title="Execute a remote procedure call on the server&#39;s RaftService.">Peer::callRPC</a>(Protocol::Raft::OpCode opCode,
<a name="l00259"></a>00259               <span class="keyword">const</span> google::protobuf::Message&amp; request,
<a name="l00260"></a>00260               google::protobuf::Message&amp; response,
<a name="l00261"></a>00261               std::unique_lock&lt;Mutex&gt;&amp; lockGuard)
<a name="l00262"></a>00262 {
<a name="l00263"></a>00263     <span class="keyword">typedef</span> <a class="code" href="classLogCabin_1_1RPC_1_1ClientRPC.html#a7732b104e0010f946c5420ec05ec65a3" title="The return type of waitForReply().">RPC::ClientRPC::Status</a> RPCStatus;
<a name="l00264"></a>00264     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a6152a1441ad8d36900beae23b8adb231" title="callRPC() places its RPC here so that interrupt() may cancel it.">rpc</a> = <a class="code" href="classLogCabin_1_1RPC_1_1ClientRPC.html" title="This class represents an asynchronous remote procedure call.">RPC::ClientRPC</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a3e688557bfc2d99836ae83fe7ccd8145" title="Get the current session for this server.">getSession</a>(lockGuard),
<a name="l00265"></a>00265                          <a class="code" href="namespaceLogCabin_1_1Protocol_1_1Common_1_1ServiceId.html#ae8d017d5dec1044c245d7073d70fc2caae4c9c4ef8aa160c1ecef9fa5b27fc955" title="The service that LogCabin servers use to communicate with each other.">Protocol::Common::ServiceId::RAFT_SERVICE</a>,
<a name="l00266"></a>00266                          <span class="comment">/* serviceSpecificErrorVersion = */</span> 0,
<a name="l00267"></a>00267                          opCode,
<a name="l00268"></a>00268                          request);
<a name="l00269"></a>00269     <span class="comment">// release lock for concurrency</span>
<a name="l00270"></a>00270     <a class="code" href="classLogCabin_1_1Core_1_1MutexUnlock.html" title="Release a mutex upon construction, reacquires it upon destruction.">Core::MutexUnlock&lt;Mutex&gt;</a> unlockGuard(lockGuard);
<a name="l00271"></a>00271     <span class="keywordflow">switch</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a6152a1441ad8d36900beae23b8adb231" title="callRPC() places its RPC here so that interrupt() may cancel it.">rpc</a>.<a class="code" href="classLogCabin_1_1RPC_1_1ClientRPC.html#a5824f288f6066eae256f67b267943cd1" title="Wait for a reply to the RPC or an error.">waitForReply</a>(&amp;response, NULL, TimePoint::max())) {
<a name="l00272"></a>00272         <span class="keywordflow">case</span> <a class="code" href="namespaceLogCabin_1_1Client.html#a4326ade2a152c568b8a7b7daafadf9b4a7324f75352386fdbcd0e25d926866ad7" title="The operation completed successfully.">RPCStatus::OK</a>:
<a name="l00273"></a>00273             <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#af384128771f7e60f485b837114f56788" title="Counts RPC failures to issue fewer warnings.">rpcFailuresSinceLastWarning</a> &gt; 0) {
<a name="l00274"></a>00274                 <a class="code" href="Core_2Debug_8h.html#ad51176fec84ca79bd96163c9cb5a7c32" title="Log a WARNING message.">WARNING</a>(<span class="stringliteral">&quot;RPC to server succeeded after %lu failures&quot;</span>,
<a name="l00275"></a>00275                         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#af384128771f7e60f485b837114f56788" title="Counts RPC failures to issue fewer warnings.">rpcFailuresSinceLastWarning</a>);
<a name="l00276"></a>00276                 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#af384128771f7e60f485b837114f56788" title="Counts RPC failures to issue fewer warnings.">rpcFailuresSinceLastWarning</a> = 0;
<a name="l00277"></a>00277             }
<a name="l00278"></a>00278             <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a0548ee7eb046a903349a22ff0a3c7bdaa904537cc252e0045bf3f61d3aead21fc" title="The RPC succeeded and the response was filled in.">CallStatus::OK</a>;
<a name="l00279"></a>00279         <span class="keywordflow">case</span> <a class="code" href="namespaceLogCabin_1_1RPC_1_1Protocol.html#a85fb11a499988e97be6f566df469a694a3808388a3c1e6c97bdb3dd5e5ecee8f3" title="An error specific to the particular service.">RPCStatus::SERVICE_SPECIFIC_ERROR</a>:
<a name="l00280"></a>00280             <a class="code" href="Core_2Debug_8h.html#ad84b0f521394f4d9214c9d185711a8c3" title="Log an ERROR message and abort the process.">PANIC</a>(<span class="stringliteral">&quot;unexpected service-specific error&quot;</span>);
<a name="l00281"></a>00281         <span class="keywordflow">case</span> <a class="code" href="namespaceLogCabin_1_1Client.html#a4326ade2a152c568b8a7b7daafadf9b4ab990fd14d55b44d8753e7aa00a8575bf" title="A timeout specified by Tree::setTimeout() elapsed while waiting for an operation to complete...">RPCStatus::TIMEOUT</a>:
<a name="l00282"></a>00282             <a class="code" href="Core_2Debug_8h.html#ad84b0f521394f4d9214c9d185711a8c3" title="Log an ERROR message and abort the process.">PANIC</a>(<span class="stringliteral">&quot;unexpected RPC timeout&quot;</span>);
<a name="l00283"></a>00283         <span class="keywordflow">case</span> RPCStatus::RPC_FAILED:
<a name="l00284"></a>00284             ++<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#af384128771f7e60f485b837114f56788" title="Counts RPC failures to issue fewer warnings.">rpcFailuresSinceLastWarning</a>;
<a name="l00285"></a>00285             <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#af384128771f7e60f485b837114f56788" title="Counts RPC failures to issue fewer warnings.">rpcFailuresSinceLastWarning</a> == 1) {
<a name="l00286"></a>00286                 <a class="code" href="Core_2Debug_8h.html#ad51176fec84ca79bd96163c9cb5a7c32" title="Log a WARNING message.">WARNING</a>(<span class="stringliteral">&quot;RPC to server failed: %s&quot;</span>,
<a name="l00287"></a>00287                         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a6152a1441ad8d36900beae23b8adb231" title="callRPC() places its RPC here so that interrupt() may cancel it.">rpc</a>.<a class="code" href="classLogCabin_1_1RPC_1_1ClientRPC.html#ac05c315769570fb5c612cc96a292aba2" title="If an RPC failure occurred, return a message describing that error.">getErrorMessage</a>().c_str());
<a name="l00288"></a>00288             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#af384128771f7e60f485b837114f56788" title="Counts RPC failures to issue fewer warnings.">rpcFailuresSinceLastWarning</a> % 100 == 0) {
<a name="l00289"></a>00289                 <a class="code" href="Core_2Debug_8h.html#ad51176fec84ca79bd96163c9cb5a7c32" title="Log a WARNING message.">WARNING</a>(<span class="stringliteral">&quot;Last %lu RPCs to server failed. This failure: %s&quot;</span>,
<a name="l00290"></a>00290                         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#af384128771f7e60f485b837114f56788" title="Counts RPC failures to issue fewer warnings.">rpcFailuresSinceLastWarning</a>,
<a name="l00291"></a>00291                         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a6152a1441ad8d36900beae23b8adb231" title="callRPC() places its RPC here so that interrupt() may cancel it.">rpc</a>.<a class="code" href="classLogCabin_1_1RPC_1_1ClientRPC.html#ac05c315769570fb5c612cc96a292aba2" title="If an RPC failure occurred, return a message describing that error.">getErrorMessage</a>().c_str());
<a name="l00292"></a>00292             }
<a name="l00293"></a>00293             <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a0548ee7eb046a903349a22ff0a3c7bdaa15398142dc9aee5b6d4c20406dce7f23" title="No reply was received from the server.">CallStatus::FAILED</a>;
<a name="l00294"></a>00294         <span class="keywordflow">case</span> RPCStatus::RPC_CANCELED:
<a name="l00295"></a>00295             <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a0548ee7eb046a903349a22ff0a3c7bdaa15398142dc9aee5b6d4c20406dce7f23" title="No reply was received from the server.">CallStatus::FAILED</a>;
<a name="l00296"></a>00296         <span class="keywordflow">case</span> <a class="code" href="namespaceLogCabin_1_1RPC_1_1Protocol.html#a85fb11a499988e97be6f566df469a694a57b3feada853764683c0dda7595cbac5" title="The server does not have the requested service.">RPCStatus::INVALID_SERVICE</a>:
<a name="l00297"></a>00297             <a class="code" href="Core_2Debug_8h.html#ad84b0f521394f4d9214c9d185711a8c3" title="Log an ERROR message and abort the process.">PANIC</a>(<span class="stringliteral">&quot;The server isn&#39;t running the RaftService&quot;</span>);
<a name="l00298"></a>00298         <span class="keywordflow">case</span> <a class="code" href="namespaceLogCabin_1_1RPC_1_1Protocol.html#a85fb11a499988e97be6f566df469a694aff3e9fbb7614ab1714ea489e399f19ea" title="The server did not like the RPC request.">RPCStatus::INVALID_REQUEST</a>:
<a name="l00299"></a>00299             <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a0548ee7eb046a903349a22ff0a3c7bdaa77027979367e3f0c7e37350de77676b6" title="The server does not support this RPC or didn&#39;t like the arguments given.">CallStatus::INVALID_REQUEST</a>;
<a name="l00300"></a>00300     }
<a name="l00301"></a>00301     <a class="code" href="Core_2Debug_8h.html#ad84b0f521394f4d9214c9d185711a8c3" title="Log an ERROR message and abort the process.">PANIC</a>(<span class="stringliteral">&quot;Unexpected RPC status&quot;</span>);
<a name="l00302"></a>00302 }
<a name="l00303"></a>00303 
<a name="l00304"></a>00304 <span class="keywordtype">void</span>
<a name="l00305"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a64724bf0a6f9aa79c0e5dfc973d8a195">00305</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a64724bf0a6f9aa79c0e5dfc973d8a195" title="Launch this Peer&#39;s thread, which should run RaftConsensus::peerThreadMain.">Peer::startThread</a>(std::shared_ptr&lt;Peer&gt; <span class="keyword">self</span>)
<a name="l00306"></a>00306 {
<a name="l00307"></a>00307     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#aee6a46284ffbb597bdaaf4171cca5b6a">thisCatchUpIterationStart</a> = <a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a13f545c6020dd190e13d21e2577cc59b">Clock::now</a>();
<a name="l00308"></a>00308     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a0b1063ab72094143e3e1acdfb531b355">thisCatchUpIterationGoalId</a> = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#aab8969e0bf7d7c361908ad13073a6d2d" title="Used in startThread.">consensus</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex();
<a name="l00309"></a>00309     ++<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#aab8969e0bf7d7c361908ad13073a6d2d" title="Used in startThread.">consensus</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b784132bbc03e602f0a8233d6e570f" title="The number of Peer::thread threads that are still using this RaftConsensus object.">numPeerThreads</a>;
<a name="l00310"></a>00310     <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Starting peer thread for server %lu&quot;</span>, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#ac1b2d6d134b4c41baf0220a0c6e587b7" title="The ID of this server.">serverId</a>);
<a name="l00311"></a>00311     std::thread(&amp;<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acb5c8d3c4f827cfb7f01ef4128f435a4" title="Initiate RPCs to a specific server as necessary.">RaftConsensus::peerThreadMain</a>, &amp;<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#aab8969e0bf7d7c361908ad13073a6d2d" title="Used in startThread.">consensus</a>, <span class="keyword">self</span>).detach();
<a name="l00312"></a>00312 }
<a name="l00313"></a>00313 
<a name="l00314"></a>00314 std::shared_ptr&lt;RPC::ClientSession&gt;
<a name="l00315"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a3e688557bfc2d99836ae83fe7ccd8145">00315</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a3e688557bfc2d99836ae83fe7ccd8145" title="Get the current session for this server.">Peer::getSession</a>(std::unique_lock&lt;Mutex&gt;&amp; lockGuard)
<a name="l00316"></a>00316 {
<a name="l00317"></a>00317     <span class="keywordflow">if</span> (!<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a16744a8ac76825923b7bd86625aa26c8" title="Caches the result of getSession().">session</a> || !<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a16744a8ac76825923b7bd86625aa26c8" title="Caches the result of getSession().">session</a>-&gt;getErrorMessage().empty()) {
<a name="l00318"></a>00318         <span class="comment">// release lock for concurrency</span>
<a name="l00319"></a>00319         <a class="code" href="classLogCabin_1_1Core_1_1MutexUnlock.html" title="Release a mutex upon construction, reacquires it upon destruction.">Core::MutexUnlock&lt;Mutex&gt;</a> unlockGuard(lockGuard);
<a name="l00320"></a>00320         <a class="code" href="classLogCabin_1_1RPC_1_1Address.html" title="This class resolves user-friendly addresses for services into socket-level addresses.">RPC::Address</a> target(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#a47cb3021d164ce1bbb1e9875591df632" title="The network addresses at which this server may be available (comma-delimited)">addresses</a>, <a class="code" href="namespaceLogCabin_1_1Protocol_1_1Common.html#a22c6438e512e84fa30d19c2fad7eba9caa9728f693e5b04009f08df50d73e9662">Protocol::Common::DEFAULT_PORT</a>);
<a name="l00321"></a>00321         target.<a class="code" href="classLogCabin_1_1RPC_1_1Address.html#a862df7c77ff8748a64dfde7696df9b76" title="Convert (a random one of) the host(s) and port(s) to a sockaddr.">refresh</a>(RPC::Address::TimePoint::max());
<a name="l00322"></a>00322         <a class="code" href="classLogCabin_1_1Client_1_1SessionManager_1_1LockedAssignment.html" title="Gets and sets a value while holding a mutex.">Client::SessionManager::ServerId</a> peerId(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#ac1b2d6d134b4c41baf0220a0c6e587b7" title="The ID of this server.">serverId</a>);
<a name="l00323"></a>00323         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a16744a8ac76825923b7bd86625aa26c8" title="Caches the result of getSession().">session</a> = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#aab8969e0bf7d7c361908ad13073a6d2d" title="Used in startThread.">consensus</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a4d16a25856a2ba0c739fdfde0db05d89" title="Used to create new sessions.">sessionManager</a>.<a class="code" href="classLogCabin_1_1Client_1_1SessionManager.html#af0fe6bc87c2fb3486ae3b2972bab5757" title="Connect to the given address.">createSession</a>(
<a name="l00324"></a>00324             target,
<a name="l00325"></a>00325             RPC::ClientSession::TimePoint::max(),
<a name="l00326"></a>00326             &amp;<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#aab8969e0bf7d7c361908ad13073a6d2d" title="Used in startThread.">consensus</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a18a8fc189422f6eb3f5f0497e4e102b1" title="The LogCabin daemon&#39;s top-level objects.">globals</a>.<a class="code" href="classLogCabin_1_1Server_1_1Globals.html#a4608a23757d8b526c9a7c0ed7113dfdc" title="A unique ID for the cluster that this server may connect to.">clusterUUID</a>,
<a name="l00327"></a>00327             &amp;peerId);
<a name="l00328"></a>00328     }
<a name="l00329"></a>00329     <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a16744a8ac76825923b7bd86625aa26c8" title="Caches the result of getSession().">session</a>;
<a name="l00330"></a>00330 }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332 std::ostream&amp;
<a name="l00333"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#ad76e79f05ed4e34288bf168ed931a6cd">00333</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#ad76e79f05ed4e34288bf168ed931a6cd" title="Virtual method for operator&lt;&lt;.">Peer::dumpToStream</a>(std::ostream&amp; os)<span class="keyword"> const</span>
<a name="l00334"></a>00334 <span class="keyword"></span>{
<a name="l00335"></a>00335     os &lt;&lt; <span class="stringliteral">&quot;Peer &quot;</span> &lt;&lt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#ac1b2d6d134b4c41baf0220a0c6e587b7" title="The ID of this server.">serverId</a> &lt;&lt; std::endl;
<a name="l00336"></a>00336     os &lt;&lt; <span class="stringliteral">&quot;addresses: &quot;</span> &lt;&lt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#a47cb3021d164ce1bbb1e9875591df632" title="The network addresses at which this server may be available (comma-delimited)">addresses</a> &lt;&lt; std::endl;
<a name="l00337"></a>00337     <span class="keywordflow">switch</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#aab8969e0bf7d7c361908ad13073a6d2d" title="Used in startThread.">consensus</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a>) {
<a name="l00338"></a>00338         <span class="keywordflow">case</span> RaftConsensus::State::FOLLOWER:
<a name="l00339"></a>00339             <span class="keywordflow">break</span>;
<a name="l00340"></a>00340         <span class="keywordflow">case</span> RaftConsensus::State::CANDIDATE:
<a name="l00341"></a>00341             os &lt;&lt; <span class="stringliteral">&quot;vote: &quot;</span>;
<a name="l00342"></a>00342             <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#ac4a82cf70a21989f2f59505281647c3f" title="Set to true if the server has responded to our RequestVote request in the current term...">requestVoteDone</a>) {
<a name="l00343"></a>00343                 <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a57b21af23dcbefa804c9c962591e5025" title="See haveVote().">haveVote_</a>)
<a name="l00344"></a>00344                     os &lt;&lt; <span class="stringliteral">&quot;granted&quot;</span>;
<a name="l00345"></a>00345                 <span class="keywordflow">else</span>
<a name="l00346"></a>00346                     os &lt;&lt; <span class="stringliteral">&quot;not granted&quot;</span>;
<a name="l00347"></a>00347             } <span class="keywordflow">else</span> {
<a name="l00348"></a>00348                 os &lt;&lt; <span class="stringliteral">&quot;no response&quot;</span>;
<a name="l00349"></a>00349             }
<a name="l00350"></a>00350             os &lt;&lt; std::endl;
<a name="l00351"></a>00351             <span class="keywordflow">break</span>;
<a name="l00352"></a>00352         <span class="keywordflow">case</span> RaftConsensus::State::LEADER:
<a name="l00353"></a>00353             os &lt;&lt; <span class="stringliteral">&quot;forceHeartbeat: &quot;</span> &lt;&lt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a50d0b442ca40959e135e45107a8c6c76" title="Indicates that nextIndex is still a (poor) guess: the leader should send heartbeats to save bandwidth...">forceHeartbeat</a> &lt;&lt; std::endl;
<a name="l00354"></a>00354             os &lt;&lt; <span class="stringliteral">&quot;nextIndex: &quot;</span> &lt;&lt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a681aed27116449b0ec7705e85f09fd07" title="The index of the next entry to send to the follower.">nextIndex</a> &lt;&lt; std::endl;
<a name="l00355"></a>00355             os &lt;&lt; <span class="stringliteral">&quot;lastAgreeIndex: &quot;</span> &lt;&lt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a2af3be3d3ac5cfb2c79270d084f01e21" title="See getLastAgreeIndex().">lastAgreeIndex</a> &lt;&lt; std::endl;
<a name="l00356"></a>00356             <span class="keywordflow">break</span>;
<a name="l00357"></a>00357     }
<a name="l00358"></a>00358     <span class="keywordflow">return</span> os;
<a name="l00359"></a>00359 }
<a name="l00360"></a>00360 
<a name="l00361"></a>00361 <span class="keywordtype">void</span>
<a name="l00362"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a8b3a632d179de95c2adafaa5964a411a">00362</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a8b3a632d179de95c2adafaa5964a411a" title="Write this Server&#39;s state into the given structure.">Peer::updatePeerStats</a>(Protocol::ServerStats::Raft::Peer&amp; peerStats,
<a name="l00363"></a>00363                       <a class="code" href="classLogCabin_1_1Core_1_1Time_1_1SteadyTimeConverter.html" title="Used to convert one or more SteadyClock::time_point values into values of the SystemClock.">Core::Time::SteadyTimeConverter</a>&amp; time)<span class="keyword"> const</span>
<a name="l00364"></a>00364 <span class="keyword"></span>{
<a name="l00365"></a>00365     <span class="keywordflow">switch</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#aab8969e0bf7d7c361908ad13073a6d2d" title="Used in startThread.">consensus</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a>) {
<a name="l00366"></a>00366         <span class="keywordflow">case</span> RaftConsensus::State::FOLLOWER:
<a name="l00367"></a>00367             <span class="keywordflow">break</span>;
<a name="l00368"></a>00368         <span class="keywordflow">case</span> RaftConsensus::State::CANDIDATE:
<a name="l00369"></a>00369             <span class="keywordflow">break</span>;
<a name="l00370"></a>00370         <span class="keywordflow">case</span> RaftConsensus::State::LEADER:
<a name="l00371"></a>00371             peerStats.set_force_heartbeat(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a50d0b442ca40959e135e45107a8c6c76" title="Indicates that nextIndex is still a (poor) guess: the leader should send heartbeats to save bandwidth...">forceHeartbeat</a>);
<a name="l00372"></a>00372             peerStats.set_next_index(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a681aed27116449b0ec7705e85f09fd07" title="The index of the next entry to send to the follower.">nextIndex</a>);
<a name="l00373"></a>00373             peerStats.set_last_agree_index(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a2af3be3d3ac5cfb2c79270d084f01e21" title="See getLastAgreeIndex().">lastAgreeIndex</a>);
<a name="l00374"></a>00374             peerStats.set_is_caught_up(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#aa35915b9016d63af612039b1eea9c9bf" title="See isCaughtUp().">isCaughtUp_</a>);
<a name="l00375"></a>00375             peerStats.set_next_heartbeat_at(time.<a class="code" href="classLogCabin_1_1Core_1_1Time_1_1SteadyTimeConverter.html#aa967e929bf170e2fe251eb06ad8b3dd7" title="Return the given time in nanoseconds since the Unix epoch according the system clock (assuming no tim...">unixNanos</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#af3115d040af27bfe093f1881fd243716" title="When the next heartbeat should be sent to the follower.">nextHeartbeatTime</a>));
<a name="l00376"></a>00376             <span class="keywordflow">break</span>;
<a name="l00377"></a>00377     }
<a name="l00378"></a>00378 
<a name="l00379"></a>00379     <span class="keywordflow">switch</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#aab8969e0bf7d7c361908ad13073a6d2d" title="Used in startThread.">consensus</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a>) {
<a name="l00380"></a>00380         <span class="keywordflow">case</span> RaftConsensus::State::FOLLOWER:
<a name="l00381"></a>00381             <span class="keywordflow">break</span>;
<a name="l00382"></a>00382         <span class="keywordflow">case</span> RaftConsensus::State::CANDIDATE: <span class="comment">// fallthrough</span>
<a name="l00383"></a>00383         <span class="keywordflow">case</span> RaftConsensus::State::LEADER:
<a name="l00384"></a>00384             peerStats.set_request_vote_done(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#ac4a82cf70a21989f2f59505281647c3f" title="Set to true if the server has responded to our RequestVote request in the current term...">requestVoteDone</a>);
<a name="l00385"></a>00385             peerStats.set_have_vote(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a57b21af23dcbefa804c9c962591e5025" title="See haveVote().">haveVote_</a>);
<a name="l00386"></a>00386             peerStats.set_backoff_until(time.<a class="code" href="classLogCabin_1_1Core_1_1Time_1_1SteadyTimeConverter.html#aa967e929bf170e2fe251eb06ad8b3dd7" title="Return the given time in nanoseconds since the Unix epoch according the system clock (assuming no tim...">unixNanos</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a8b6511933a555747a4edf9e4cb9f385c" title="The minimum time at which the next RPC should be sent.">backoffUntil</a>));
<a name="l00387"></a>00387             <span class="keywordflow">break</span>;
<a name="l00388"></a>00388     }
<a name="l00389"></a>00389 }
<a name="l00390"></a>00390 <span class="comment"></span>
<a name="l00391"></a>00391 <span class="comment">////////// Configuration::SimpleConfiguration //////////</span>
<a name="l00392"></a>00392 <span class="comment"></span>
<a name="l00393"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#aefd1222c1b81600f7a7c410cafab918e">00393</a> <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#aefd1222c1b81600f7a7c410cafab918e">Configuration::SimpleConfiguration::SimpleConfiguration</a>()
<a name="l00394"></a>00394     : servers()
<a name="l00395"></a>00395 {
<a name="l00396"></a>00396 }
<a name="l00397"></a>00397 
<a name="l00398"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#ae3a92594fedb94d3c52f939f1e333d18">00398</a> <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#ae3a92594fedb94d3c52f939f1e333d18">Configuration::SimpleConfiguration::~SimpleConfiguration</a>()
<a name="l00399"></a>00399 {
<a name="l00400"></a>00400 }
<a name="l00401"></a>00401 
<a name="l00402"></a>00402 <span class="keywordtype">bool</span>
<a name="l00403"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#a38f344f005b20fdfc6df8a583ccf6d3a">00403</a> <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#a38f344f005b20fdfc6df8a583ccf6d3a">Configuration::SimpleConfiguration::all</a>(<span class="keyword">const</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ab03a45ca76847baf9dd1f673a1d4a0bf">Predicate</a>&amp; predicate)<span class="keyword"> const</span>
<a name="l00404"></a>00404 <span class="keyword"></span>{
<a name="l00405"></a>00405     <span class="keywordflow">for</span> (<span class="keyword">auto</span> it = servers.begin(); it != servers.end(); ++it) {
<a name="l00406"></a>00406         <span class="keywordflow">if</span> (!predicate(**it))
<a name="l00407"></a>00407             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00408"></a>00408     }
<a name="l00409"></a>00409     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00410"></a>00410 }
<a name="l00411"></a>00411 
<a name="l00412"></a>00412 <span class="keywordtype">bool</span>
<a name="l00413"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#ad41230e2dec35359e3d3f936c7f4d60e">00413</a> <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#ad41230e2dec35359e3d3f936c7f4d60e">Configuration::SimpleConfiguration::contains</a>(std::shared_ptr&lt;Server&gt; server)<span class="keyword"></span>
<a name="l00414"></a>00414 <span class="keyword">                                                                          const</span>
<a name="l00415"></a>00415 <span class="keyword"></span>{
<a name="l00416"></a>00416     <span class="keywordflow">for</span> (<span class="keyword">auto</span> it = servers.begin(); it != servers.end(); ++it) {
<a name="l00417"></a>00417         <span class="keywordflow">if</span> (*it == server)
<a name="l00418"></a>00418             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00419"></a>00419     }
<a name="l00420"></a>00420     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00421"></a>00421 }
<a name="l00422"></a>00422 
<a name="l00423"></a>00423 <span class="keywordtype">void</span>
<a name="l00424"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#a50f2e1ee2be8bb6779e0b1dd792e7d9b">00424</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a5d735080020e1ec576316005e685327a" title="Apply a function to every known server, including the local, old, new, and staging servers...">Configuration::SimpleConfiguration::forEach</a>(<span class="keyword">const</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#abf2bb86fbae1483909a8889762df58a5">SideEffect</a>&amp; sideEffect)
<a name="l00425"></a>00425 {
<a name="l00426"></a>00426     <span class="keywordflow">for</span> (<span class="keyword">auto</span> it = servers.begin(); it != servers.end(); ++it)
<a name="l00427"></a>00427         sideEffect(**it);
<a name="l00428"></a>00428 }
<a name="l00429"></a>00429 
<a name="l00430"></a>00430 uint64_t
<a name="l00431"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#a36a72e776d92239b8106fc9f66361b52">00431</a> <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#a36a72e776d92239b8106fc9f66361b52">Configuration::SimpleConfiguration::min</a>(<span class="keyword">const</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ab6e3815e59f806e23768ae2750a0fd73">GetValue</a>&amp; getValue)<span class="keyword"> const</span>
<a name="l00432"></a>00432 <span class="keyword"></span>{
<a name="l00433"></a>00433     <span class="keywordflow">if</span> (servers.empty())
<a name="l00434"></a>00434         <span class="keywordflow">return</span> 0;
<a name="l00435"></a>00435     uint64_t smallest = ~0UL;
<a name="l00436"></a>00436     <span class="keywordflow">for</span> (<span class="keyword">auto</span> it = servers.begin(); it != servers.end(); ++it)
<a name="l00437"></a>00437         smallest = std::min(smallest, getValue(**it));
<a name="l00438"></a>00438     <span class="keywordflow">return</span> smallest;
<a name="l00439"></a>00439 }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441 <span class="keywordtype">bool</span>
<a name="l00442"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#ac6cb4987028dc5522acca25ad8af4bb9">00442</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a326d5cbde57c0c09fa0ae8fe8f23cbad" title="Return true if there exists a quorum for which every server satisfies the predicate, false otherwise.">Configuration::SimpleConfiguration::quorumAll</a>(<span class="keyword">const</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ab03a45ca76847baf9dd1f673a1d4a0bf">Predicate</a>&amp; predicate)<span class="keyword"> const</span>
<a name="l00443"></a>00443 <span class="keyword"></span>{
<a name="l00444"></a>00444     <span class="keywordflow">if</span> (servers.empty())
<a name="l00445"></a>00445         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00446"></a>00446     uint64_t count = 0;
<a name="l00447"></a>00447     <span class="keywordflow">for</span> (<span class="keyword">auto</span> it = servers.begin(); it != servers.end(); ++it)
<a name="l00448"></a>00448         <span class="keywordflow">if</span> (predicate(**it))
<a name="l00449"></a>00449             ++count;
<a name="l00450"></a>00450     <span class="keywordflow">return</span> (count &gt;= servers.size() / 2 + 1);
<a name="l00451"></a>00451 }
<a name="l00452"></a>00452 
<a name="l00453"></a>00453 uint64_t
<a name="l00454"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#a405d53e3854ba61d9792a715812053fc">00454</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a4e76f11b8478114a4309b6565d9c62d0" title="Return the smallest value of any server in the quorum of servers that have the largest values...">Configuration::SimpleConfiguration::quorumMin</a>(<span class="keyword">const</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ab6e3815e59f806e23768ae2750a0fd73">GetValue</a>&amp; getValue)<span class="keyword"> const</span>
<a name="l00455"></a>00455 <span class="keyword"></span>{
<a name="l00456"></a>00456     <span class="keywordflow">if</span> (servers.empty())
<a name="l00457"></a>00457         <span class="keywordflow">return</span> 0;
<a name="l00458"></a>00458     std::vector&lt;uint64_t&gt; values;
<a name="l00459"></a>00459     <span class="keywordflow">for</span> (<span class="keyword">auto</span> it = servers.begin(); it != servers.end(); ++it)
<a name="l00460"></a>00460         values.push_back(getValue(**it));
<a name="l00461"></a>00461     std::sort(values.begin(), values.end());
<a name="l00462"></a>00462     <span class="keywordflow">return</span> values.at((values.size() - 1)/ 2);
<a name="l00463"></a>00463 }
<a name="l00464"></a>00464 <span class="comment"></span>
<a name="l00465"></a>00465 <span class="comment">////////// Configuration //////////</span>
<a name="l00466"></a>00466 <span class="comment"></span>
<a name="l00467"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a53c4fae24598befa701c67a7bfcc3344">00467</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a53c4fae24598befa701c67a7bfcc3344" title="Constructor.">Configuration::Configuration</a>(uint64_t serverId, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html" title="An implementation of the Raft consensus algorithm.">RaftConsensus</a>&amp; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#af08504e6a6ba80678a5edf0f6252686a" title="Used for constructing Server instances.">consensus</a>)
<a name="l00468"></a>00468     : consensus(consensus)
<a name="l00469"></a>00469     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adc97b0a5dee772e4c7b3e37ac1230f9b" title="A map from server ID to Server of every server, including the local, previous, new, and staging servers.">knownServers</a>()
<a name="l00470"></a>00470     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ab4ddea6874ae1a4c7a6fe22fc752d6af" title="This server.">localServer</a>()
<a name="l00471"></a>00471     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#abba01502b5eb5e710d3bdfb57d79dde9" title="Specifies the meaning of oldServers and newServers.">state</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a602e7e486778ba0fda4c2ffceeeeb5ca" title="See state.">State</a>::<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a602e7e486778ba0fda4c2ffceeeeb5caa8fa02148721ea0a9e39dff1c5b3baa00" title="The configuration specifies no servers.">BLANK</a>)
<a name="l00472"></a>00472     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a5f68072bd5c041c6dc836d1a17bd15f3" title="The ID of the current configuration.">id</a>(0)
<a name="l00473"></a>00473     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a18b5ea1ff0070a8f98260947f420a838" title="A description of the current configuration.">description</a>()
<a name="l00474"></a>00474     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ae498d5d3cf04ad0141941ad8d3e86bbb" title="A majority of these servers are necessary for a quorum under STABLE, STAGING, and TRANSITIONAL config...">oldServers</a>()
<a name="l00475"></a>00475     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a0a131fa2c4a9aabc0186b1c2c91f8661" title="A majority of these servers are necessary for a quorum under TRANSITIONAL configurations.">newServers</a>()
<a name="l00476"></a>00476 {
<a name="l00477"></a>00477     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ab4ddea6874ae1a4c7a6fe22fc752d6af" title="This server.">localServer</a>.reset(<span class="keyword">new</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1LocalServer.html" title="A type of Server for the local process.">LocalServer</a>(serverId, consensus));
<a name="l00478"></a>00478     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adc97b0a5dee772e4c7b3e37ac1230f9b" title="A map from server ID to Server of every server, including the local, previous, new, and staging servers.">knownServers</a>[serverId] = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ab4ddea6874ae1a4c7a6fe22fc752d6af" title="This server.">localServer</a>;
<a name="l00479"></a>00479 }
<a name="l00480"></a>00480 
<a name="l00481"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a70852b392d571b34d2f3f9d363dc0d49">00481</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a70852b392d571b34d2f3f9d363dc0d49" title="Destructor.">Configuration::~Configuration</a>()
<a name="l00482"></a>00482 {
<a name="l00483"></a>00483 }
<a name="l00484"></a>00484 
<a name="l00485"></a>00485 <span class="keywordtype">void</span>
<a name="l00486"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a5d735080020e1ec576316005e685327a">00486</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a5d735080020e1ec576316005e685327a" title="Apply a function to every known server, including the local, old, new, and staging servers...">Configuration::forEach</a>(<span class="keyword">const</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#abf2bb86fbae1483909a8889762df58a5">SideEffect</a>&amp; sideEffect)
<a name="l00487"></a>00487 {
<a name="l00488"></a>00488     <span class="keywordflow">for</span> (<span class="keyword">auto</span> it = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adc97b0a5dee772e4c7b3e37ac1230f9b" title="A map from server ID to Server of every server, including the local, previous, new, and staging servers.">knownServers</a>.begin(); it != <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adc97b0a5dee772e4c7b3e37ac1230f9b" title="A map from server ID to Server of every server, including the local, previous, new, and staging servers.">knownServers</a>.end(); ++it)
<a name="l00489"></a>00489         sideEffect(*it-&gt;second);
<a name="l00490"></a>00490 }
<a name="l00491"></a>00491 
<a name="l00492"></a>00492 <span class="keywordtype">bool</span>
<a name="l00493"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a812356fdf9362a25b19b8d0af2b0ccc9">00493</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a812356fdf9362a25b19b8d0af2b0ccc9" title="Return true if the given server may be part of a quorum, false otherwise.">Configuration::hasVote</a>(std::shared_ptr&lt;Server&gt; server)<span class="keyword"> const</span>
<a name="l00494"></a>00494 <span class="keyword"></span>{
<a name="l00495"></a>00495     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#abba01502b5eb5e710d3bdfb57d79dde9" title="Specifies the meaning of oldServers and newServers.">state</a> == State::TRANSITIONAL) {
<a name="l00496"></a>00496         <span class="keywordflow">return</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ae498d5d3cf04ad0141941ad8d3e86bbb" title="A majority of these servers are necessary for a quorum under STABLE, STAGING, and TRANSITIONAL config...">oldServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#ad41230e2dec35359e3d3f936c7f4d60e">contains</a>(server) ||
<a name="l00497"></a>00497                 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a0a131fa2c4a9aabc0186b1c2c91f8661" title="A majority of these servers are necessary for a quorum under TRANSITIONAL configurations.">newServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#ad41230e2dec35359e3d3f936c7f4d60e">contains</a>(server));
<a name="l00498"></a>00498     } <span class="keywordflow">else</span> {
<a name="l00499"></a>00499         <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ae498d5d3cf04ad0141941ad8d3e86bbb" title="A majority of these servers are necessary for a quorum under STABLE, STAGING, and TRANSITIONAL config...">oldServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#ad41230e2dec35359e3d3f936c7f4d60e">contains</a>(server);
<a name="l00500"></a>00500     }
<a name="l00501"></a>00501 }
<a name="l00502"></a>00502 
<a name="l00503"></a>00503 std::string
<a name="l00504"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a15c982d387f546a202b016f724dcdc56">00504</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a15c982d387f546a202b016f724dcdc56" title="Lookup the network addresses for a particular server (comma-delimited).">Configuration::lookupAddress</a>(uint64_t serverId)<span class="keyword"> const</span>
<a name="l00505"></a>00505 <span class="keyword"></span>{
<a name="l00506"></a>00506     <span class="keyword">auto</span> it = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adc97b0a5dee772e4c7b3e37ac1230f9b" title="A map from server ID to Server of every server, including the local, previous, new, and staging servers.">knownServers</a>.find(serverId);
<a name="l00507"></a>00507     <span class="keywordflow">if</span> (it != <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adc97b0a5dee772e4c7b3e37ac1230f9b" title="A map from server ID to Server of every server, including the local, previous, new, and staging servers.">knownServers</a>.end())
<a name="l00508"></a>00508         <span class="keywordflow">return</span> it-&gt;second-&gt;addresses;
<a name="l00509"></a>00509     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00510"></a>00510 }
<a name="l00511"></a>00511 
<a name="l00512"></a>00512 <span class="keywordtype">bool</span>
<a name="l00513"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a326d5cbde57c0c09fa0ae8fe8f23cbad">00513</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a326d5cbde57c0c09fa0ae8fe8f23cbad" title="Return true if there exists a quorum for which every server satisfies the predicate, false otherwise.">Configuration::quorumAll</a>(<span class="keyword">const</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ab03a45ca76847baf9dd1f673a1d4a0bf">Predicate</a>&amp; predicate)<span class="keyword"> const</span>
<a name="l00514"></a>00514 <span class="keyword"></span>{
<a name="l00515"></a>00515     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#abba01502b5eb5e710d3bdfb57d79dde9" title="Specifies the meaning of oldServers and newServers.">state</a> == State::TRANSITIONAL) {
<a name="l00516"></a>00516         <span class="keywordflow">return</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ae498d5d3cf04ad0141941ad8d3e86bbb" title="A majority of these servers are necessary for a quorum under STABLE, STAGING, and TRANSITIONAL config...">oldServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#ac6cb4987028dc5522acca25ad8af4bb9">quorumAll</a>(predicate) &amp;&amp;
<a name="l00517"></a>00517                 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a0a131fa2c4a9aabc0186b1c2c91f8661" title="A majority of these servers are necessary for a quorum under TRANSITIONAL configurations.">newServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#ac6cb4987028dc5522acca25ad8af4bb9">quorumAll</a>(predicate));
<a name="l00518"></a>00518     } <span class="keywordflow">else</span> {
<a name="l00519"></a>00519         <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ae498d5d3cf04ad0141941ad8d3e86bbb" title="A majority of these servers are necessary for a quorum under STABLE, STAGING, and TRANSITIONAL config...">oldServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#ac6cb4987028dc5522acca25ad8af4bb9">quorumAll</a>(predicate);
<a name="l00520"></a>00520     }
<a name="l00521"></a>00521 }
<a name="l00522"></a>00522 
<a name="l00523"></a>00523 uint64_t
<a name="l00524"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a4e76f11b8478114a4309b6565d9c62d0">00524</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a4e76f11b8478114a4309b6565d9c62d0" title="Return the smallest value of any server in the quorum of servers that have the largest values...">Configuration::quorumMin</a>(<span class="keyword">const</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ab6e3815e59f806e23768ae2750a0fd73">GetValue</a>&amp; getValue)<span class="keyword"> const</span>
<a name="l00525"></a>00525 <span class="keyword"></span>{
<a name="l00526"></a>00526     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#abba01502b5eb5e710d3bdfb57d79dde9" title="Specifies the meaning of oldServers and newServers.">state</a> == State::TRANSITIONAL) {
<a name="l00527"></a>00527         <span class="keywordflow">return</span> std::min(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ae498d5d3cf04ad0141941ad8d3e86bbb" title="A majority of these servers are necessary for a quorum under STABLE, STAGING, and TRANSITIONAL config...">oldServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#a405d53e3854ba61d9792a715812053fc">quorumMin</a>(getValue),
<a name="l00528"></a>00528                         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a0a131fa2c4a9aabc0186b1c2c91f8661" title="A majority of these servers are necessary for a quorum under TRANSITIONAL configurations.">newServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#a405d53e3854ba61d9792a715812053fc">quorumMin</a>(getValue));
<a name="l00529"></a>00529     } <span class="keywordflow">else</span> {
<a name="l00530"></a>00530         <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ae498d5d3cf04ad0141941ad8d3e86bbb" title="A majority of these servers are necessary for a quorum under STABLE, STAGING, and TRANSITIONAL config...">oldServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#a405d53e3854ba61d9792a715812053fc">quorumMin</a>(getValue);
<a name="l00531"></a>00531     }
<a name="l00532"></a>00532 }
<a name="l00533"></a>00533 
<a name="l00534"></a>00534 <span class="keywordtype">void</span>
<a name="l00535"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a95d3c2e1662aa9286a1d12c656a9be2f">00535</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a95d3c2e1662aa9286a1d12c656a9be2f" title="Remove the staging servers, if any.">Configuration::resetStagingServers</a>()
<a name="l00536"></a>00536 {
<a name="l00537"></a>00537     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#abba01502b5eb5e710d3bdfb57d79dde9" title="Specifies the meaning of oldServers and newServers.">state</a> == State::STAGING) {
<a name="l00538"></a>00538         <span class="comment">// staging servers could have changed other servers&#39; addresses, so roll</span>
<a name="l00539"></a>00539         <span class="comment">// back to old description with old addresses</span>
<a name="l00540"></a>00540         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adee8a93ec9068cfaadf94db7b9c69bb8" title="Set the configuration.">setConfiguration</a>(<span class="keywordtype">id</span>, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a18b5ea1ff0070a8f98260947f420a838" title="A description of the current configuration.">description</a>);
<a name="l00541"></a>00541     }
<a name="l00542"></a>00542 }
<a name="l00543"></a>00543 
<a name="l00544"></a><a class="code" href="namespaceLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_03.html">00544</a> <span class="keyword">namespace </span>{
<a name="l00545"></a><a class="code" href="namespaceLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_03.html#acfb4213b394e2e0181747be3fba62726">00545</a> <span class="keywordtype">void</span> <a class="code" href="namespaceLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_03.html#acfb4213b394e2e0181747be3fba62726">setGCFlag</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html" title="A base class for known servers in the cluster, including this process (see LocalServer) and others (s...">Server</a>&amp; server)
<a name="l00546"></a>00546 {
<a name="l00547"></a>00547     server.gcFlag = <span class="keyword">true</span>;
<a name="l00548"></a>00548 }
<a name="l00549"></a>00549 } <span class="comment">// anonymous namespace</span>
<a name="l00550"></a>00550 
<a name="l00551"></a>00551 <span class="keywordtype">void</span>
<a name="l00552"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a5b807b039c33d1b7042fce45f2e18520">00552</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a5b807b039c33d1b7042fce45f2e18520" title="Set the state of this object as if it had just been constructed.">Configuration::reset</a>()
<a name="l00553"></a>00553 {
<a name="l00554"></a>00554     <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Resetting to blank configuration&quot;</span>);
<a name="l00555"></a>00555     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#abba01502b5eb5e710d3bdfb57d79dde9" title="Specifies the meaning of oldServers and newServers.">state</a> = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a602e7e486778ba0fda4c2ffceeeeb5caa8fa02148721ea0a9e39dff1c5b3baa00" title="The configuration specifies no servers.">State::BLANK</a>;
<a name="l00556"></a>00556     <span class="keywordtype">id</span> = 0;
<a name="l00557"></a>00557     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a18b5ea1ff0070a8f98260947f420a838" title="A description of the current configuration.">description</a> = {};
<a name="l00558"></a>00558     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ae498d5d3cf04ad0141941ad8d3e86bbb" title="A majority of these servers are necessary for a quorum under STABLE, STAGING, and TRANSITIONAL config...">oldServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#a9c4f16bc352add69d9094f0405c98b3a">servers</a>.clear();
<a name="l00559"></a>00559     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a0a131fa2c4a9aabc0186b1c2c91f8661" title="A majority of these servers are necessary for a quorum under TRANSITIONAL configurations.">newServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#a9c4f16bc352add69d9094f0405c98b3a">servers</a>.clear();
<a name="l00560"></a>00560     <span class="keywordflow">for</span> (<span class="keyword">auto</span> it = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adc97b0a5dee772e4c7b3e37ac1230f9b" title="A map from server ID to Server of every server, including the local, previous, new, and staging servers.">knownServers</a>.begin(); it != <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adc97b0a5dee772e4c7b3e37ac1230f9b" title="A map from server ID to Server of every server, including the local, previous, new, and staging servers.">knownServers</a>.end(); ++it)
<a name="l00561"></a>00561         it-&gt;second-&gt;exit();
<a name="l00562"></a>00562     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adc97b0a5dee772e4c7b3e37ac1230f9b" title="A map from server ID to Server of every server, including the local, previous, new, and staging servers.">knownServers</a>.clear();
<a name="l00563"></a>00563     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adc97b0a5dee772e4c7b3e37ac1230f9b" title="A map from server ID to Server of every server, including the local, previous, new, and staging servers.">knownServers</a>[<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ab4ddea6874ae1a4c7a6fe22fc752d6af" title="This server.">localServer</a>-&gt;serverId] = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ab4ddea6874ae1a4c7a6fe22fc752d6af" title="This server.">localServer</a>;
<a name="l00564"></a>00564 }
<a name="l00565"></a>00565 
<a name="l00566"></a>00566 <span class="keywordtype">void</span>
<a name="l00567"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adee8a93ec9068cfaadf94db7b9c69bb8">00567</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adee8a93ec9068cfaadf94db7b9c69bb8" title="Set the configuration.">Configuration::setConfiguration</a>(
<a name="l00568"></a>00568         uint64_t newId,
<a name="l00569"></a>00569         <span class="keyword">const</span> <a class="code" href="namespaceLogCabin_1_1Client.html#a99e2b7ff4ee9b74bcf9dec83b6565fa2" title="Defines the members of the cluster.">Protocol::Raft::Configuration</a>&amp; newDescription)
<a name="l00570"></a>00570 {
<a name="l00571"></a>00571     <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Activating configuration %lu:\n%s&quot;</span>, newId,
<a name="l00572"></a>00572            <a class="code" href="namespaceLogCabin_1_1Core_1_1ProtoBuf.html#a755e28f38764f420f33d7008aedced34" title="Dumps a protocol buffer message.">Core::ProtoBuf::dumpString</a>(newDescription).c_str());
<a name="l00573"></a>00573 
<a name="l00574"></a>00574     <span class="keywordflow">if</span> (newDescription.next_configuration().servers().size() == 0)
<a name="l00575"></a>00575         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#abba01502b5eb5e710d3bdfb57d79dde9" title="Specifies the meaning of oldServers and newServers.">state</a> = State::STABLE;
<a name="l00576"></a>00576     <span class="keywordflow">else</span>
<a name="l00577"></a>00577         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#abba01502b5eb5e710d3bdfb57d79dde9" title="Specifies the meaning of oldServers and newServers.">state</a> = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a602e7e486778ba0fda4c2ffceeeeb5caac38160e1f5fa0d64e6caf4f216c45ffc" title="The configuration specifies two lists of servers: a quorum requires any majority of the first list an...">State::TRANSITIONAL</a>;
<a name="l00578"></a>00578     <span class="keywordtype">id</span> = newId;
<a name="l00579"></a>00579     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a18b5ea1ff0070a8f98260947f420a838" title="A description of the current configuration.">description</a> = newDescription;
<a name="l00580"></a>00580     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ae498d5d3cf04ad0141941ad8d3e86bbb" title="A majority of these servers are necessary for a quorum under STABLE, STAGING, and TRANSITIONAL config...">oldServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#a9c4f16bc352add69d9094f0405c98b3a">servers</a>.clear();
<a name="l00581"></a>00581     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a0a131fa2c4a9aabc0186b1c2c91f8661" title="A majority of these servers are necessary for a quorum under TRANSITIONAL configurations.">newServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#a9c4f16bc352add69d9094f0405c98b3a">servers</a>.clear();
<a name="l00582"></a>00582 
<a name="l00583"></a>00583     <span class="comment">// Build up the list of old servers</span>
<a name="l00584"></a>00584     <span class="keywordflow">for</span> (<span class="keyword">auto</span> confIt = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a18b5ea1ff0070a8f98260947f420a838" title="A description of the current configuration.">description</a>.prev_configuration().servers().begin();
<a name="l00585"></a>00585          confIt != <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a18b5ea1ff0070a8f98260947f420a838" title="A description of the current configuration.">description</a>.prev_configuration().servers().end();
<a name="l00586"></a>00586          ++confIt) {
<a name="l00587"></a>00587         std::shared_ptr&lt;Server&gt; server = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a546755a466da0a62d27b5848b193e983" title="If no server by the given ID is known, construct a new one.">getServer</a>(confIt-&gt;server_id());
<a name="l00588"></a>00588         server-&gt;addresses = confIt-&gt;addresses();
<a name="l00589"></a>00589         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ae498d5d3cf04ad0141941ad8d3e86bbb" title="A majority of these servers are necessary for a quorum under STABLE, STAGING, and TRANSITIONAL config...">oldServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#a9c4f16bc352add69d9094f0405c98b3a">servers</a>.push_back(server);
<a name="l00590"></a>00590     }
<a name="l00591"></a>00591 
<a name="l00592"></a>00592     <span class="comment">// Build up the list of new servers</span>
<a name="l00593"></a>00593     <span class="keywordflow">for</span> (<span class="keyword">auto</span> confIt = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a18b5ea1ff0070a8f98260947f420a838" title="A description of the current configuration.">description</a>.next_configuration().servers().begin();
<a name="l00594"></a>00594          confIt != <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a18b5ea1ff0070a8f98260947f420a838" title="A description of the current configuration.">description</a>.next_configuration().servers().end();
<a name="l00595"></a>00595          ++confIt) {
<a name="l00596"></a>00596         std::shared_ptr&lt;Server&gt; server = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a546755a466da0a62d27b5848b193e983" title="If no server by the given ID is known, construct a new one.">getServer</a>(confIt-&gt;server_id());
<a name="l00597"></a>00597         server-&gt;addresses = confIt-&gt;addresses();
<a name="l00598"></a>00598         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a0a131fa2c4a9aabc0186b1c2c91f8661" title="A majority of these servers are necessary for a quorum under TRANSITIONAL configurations.">newServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#a9c4f16bc352add69d9094f0405c98b3a">servers</a>.push_back(server);
<a name="l00599"></a>00599     }
<a name="l00600"></a>00600 
<a name="l00601"></a>00601     <span class="comment">// Servers not in the current configuration need to be told to exit</span>
<a name="l00602"></a>00602     <a class="code" href="namespaceLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_03.html#acfb4213b394e2e0181747be3fba62726">setGCFlag</a>(*<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ab4ddea6874ae1a4c7a6fe22fc752d6af" title="This server.">localServer</a>);
<a name="l00603"></a>00603     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ae498d5d3cf04ad0141941ad8d3e86bbb" title="A majority of these servers are necessary for a quorum under STABLE, STAGING, and TRANSITIONAL config...">oldServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#a50f2e1ee2be8bb6779e0b1dd792e7d9b">forEach</a>(<a class="code" href="namespaceLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_03.html#acfb4213b394e2e0181747be3fba62726">setGCFlag</a>);
<a name="l00604"></a>00604     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a0a131fa2c4a9aabc0186b1c2c91f8661" title="A majority of these servers are necessary for a quorum under TRANSITIONAL configurations.">newServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#a50f2e1ee2be8bb6779e0b1dd792e7d9b">forEach</a>(<a class="code" href="namespaceLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_03.html#acfb4213b394e2e0181747be3fba62726">setGCFlag</a>);
<a name="l00605"></a>00605     <span class="keyword">auto</span> it = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adc97b0a5dee772e4c7b3e37ac1230f9b" title="A map from server ID to Server of every server, including the local, previous, new, and staging servers.">knownServers</a>.begin();
<a name="l00606"></a>00606     <span class="keywordflow">while</span> (it != <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adc97b0a5dee772e4c7b3e37ac1230f9b" title="A map from server ID to Server of every server, including the local, previous, new, and staging servers.">knownServers</a>.end()) {
<a name="l00607"></a>00607         std::shared_ptr&lt;Server&gt; server = it-&gt;second;
<a name="l00608"></a>00608         <span class="keywordflow">if</span> (!server-&gt;gcFlag) {
<a name="l00609"></a>00609             server-&gt;exit();
<a name="l00610"></a>00610             it = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adc97b0a5dee772e4c7b3e37ac1230f9b" title="A map from server ID to Server of every server, including the local, previous, new, and staging servers.">knownServers</a>.erase(it);
<a name="l00611"></a>00611         } <span class="keywordflow">else</span> {
<a name="l00612"></a>00612             server-&gt;gcFlag = <span class="keyword">false</span>; <span class="comment">// clear flag for next time</span>
<a name="l00613"></a>00613             ++it;
<a name="l00614"></a>00614         }
<a name="l00615"></a>00615     }
<a name="l00616"></a>00616 }
<a name="l00617"></a>00617 
<a name="l00618"></a>00618 <span class="keywordtype">void</span>
<a name="l00619"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a9ea27af565429597bab5194b8456e59b">00619</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a9ea27af565429597bab5194b8456e59b" title="Add servers that are to mirror the log but that may not have a vote (listeners).">Configuration::setStagingServers</a>(
<a name="l00620"></a>00620         <span class="keyword">const</span> Protocol::Raft::SimpleConfiguration&amp; stagingServers)
<a name="l00621"></a>00621 {
<a name="l00622"></a>00622     assert(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#abba01502b5eb5e710d3bdfb57d79dde9" title="Specifies the meaning of oldServers and newServers.">state</a> == State::STABLE);
<a name="l00623"></a>00623     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#abba01502b5eb5e710d3bdfb57d79dde9" title="Specifies the meaning of oldServers and newServers.">state</a> = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a602e7e486778ba0fda4c2ffceeeeb5caa819299bacd31ee00aa09d0b611c3daf1" title="The configuration specifies two lists of servers: a quorum requires any majority of the first list...">State::STAGING</a>;
<a name="l00624"></a>00624     <span class="keywordflow">for</span> (<span class="keyword">auto</span> it = stagingServers.servers().begin();
<a name="l00625"></a>00625          it != stagingServers.servers().end();
<a name="l00626"></a>00626          ++it) {
<a name="l00627"></a>00627         std::shared_ptr&lt;Server&gt; server = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a546755a466da0a62d27b5848b193e983" title="If no server by the given ID is known, construct a new one.">getServer</a>(it-&gt;server_id());
<a name="l00628"></a>00628         server-&gt;addresses = it-&gt;addresses();
<a name="l00629"></a>00629         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a0a131fa2c4a9aabc0186b1c2c91f8661" title="A majority of these servers are necessary for a quorum under TRANSITIONAL configurations.">newServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#a9c4f16bc352add69d9094f0405c98b3a">servers</a>.push_back(server);
<a name="l00630"></a>00630     }
<a name="l00631"></a>00631 }
<a name="l00632"></a>00632 
<a name="l00633"></a>00633 <span class="keywordtype">bool</span>
<a name="l00634"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a7667fcb7dcf17212bcac56743d053866">00634</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a7667fcb7dcf17212bcac56743d053866" title="Return true if every server in the staging set satisfies the predicate, false otherwise.">Configuration::stagingAll</a>(<span class="keyword">const</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ab03a45ca76847baf9dd1f673a1d4a0bf">Predicate</a>&amp; predicate)<span class="keyword"> const</span>
<a name="l00635"></a>00635 <span class="keyword"></span>{
<a name="l00636"></a>00636     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#abba01502b5eb5e710d3bdfb57d79dde9" title="Specifies the meaning of oldServers and newServers.">state</a> == State::STAGING)
<a name="l00637"></a>00637         <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a0a131fa2c4a9aabc0186b1c2c91f8661" title="A majority of these servers are necessary for a quorum under TRANSITIONAL configurations.">newServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#a38f344f005b20fdfc6df8a583ccf6d3a">all</a>(predicate);
<a name="l00638"></a>00638     <span class="keywordflow">else</span>
<a name="l00639"></a>00639         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00640"></a>00640 }
<a name="l00641"></a>00641 
<a name="l00642"></a>00642 uint64_t
<a name="l00643"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a44f0b548123994c68dff1e4a76ee61cd">00643</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a44f0b548123994c68dff1e4a76ee61cd" title="Return the smallest value of any server in the staging set.">Configuration::stagingMin</a>(<span class="keyword">const</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ab6e3815e59f806e23768ae2750a0fd73">GetValue</a>&amp; getValue)<span class="keyword"> const</span>
<a name="l00644"></a>00644 <span class="keyword"></span>{
<a name="l00645"></a>00645     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#abba01502b5eb5e710d3bdfb57d79dde9" title="Specifies the meaning of oldServers and newServers.">state</a> == State::STAGING)
<a name="l00646"></a>00646         <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a0a131fa2c4a9aabc0186b1c2c91f8661" title="A majority of these servers are necessary for a quorum under TRANSITIONAL configurations.">newServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#a36a72e776d92239b8106fc9f66361b52">min</a>(getValue);
<a name="l00647"></a>00647     <span class="keywordflow">else</span>
<a name="l00648"></a>00648         <span class="keywordflow">return</span> 0;
<a name="l00649"></a>00649 }
<a name="l00650"></a>00650 
<a name="l00651"></a>00651 <span class="keywordtype">void</span>
<a name="l00652"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a4187caa09b20d3258cf3e6c7f6e7e848">00652</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a4187caa09b20d3258cf3e6c7f6e7e848" title="Write the configuration servers&#39; state into the given structure.">Configuration::updateServerStats</a>(Protocol::ServerStats&amp; serverStats,
<a name="l00653"></a>00653                                  <a class="code" href="classLogCabin_1_1Core_1_1Time_1_1SteadyTimeConverter.html" title="Used to convert one or more SteadyClock::time_point values into values of the SystemClock.">Core::Time::SteadyTimeConverter</a>&amp; time)<span class="keyword"> const</span>
<a name="l00654"></a>00654 <span class="keyword"></span>{
<a name="l00655"></a>00655     <span class="keywordflow">for</span> (<span class="keyword">auto</span> it = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adc97b0a5dee772e4c7b3e37ac1230f9b" title="A map from server ID to Server of every server, including the local, previous, new, and staging servers.">knownServers</a>.begin();
<a name="l00656"></a>00656          it != <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adc97b0a5dee772e4c7b3e37ac1230f9b" title="A map from server ID to Server of every server, including the local, previous, new, and staging servers.">knownServers</a>.end();
<a name="l00657"></a>00657          ++it) {
<a name="l00658"></a>00658         Protocol::ServerStats::Raft::Peer&amp; peerStats =
<a name="l00659"></a>00659             *serverStats.mutable_raft()-&gt;add_peer();
<a name="l00660"></a>00660         peerStats.set_server_id(it-&gt;first);
<a name="l00661"></a>00661         <span class="keyword">const</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#aa59cb8c3759ba19620d16bd6a71bdb02">ServerRef</a>&amp; peer = it-&gt;second;
<a name="l00662"></a>00662         peerStats.set_addresses(peer-&gt;addresses);
<a name="l00663"></a>00663         peerStats.set_old_member(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#ae498d5d3cf04ad0141941ad8d3e86bbb" title="A majority of these servers are necessary for a quorum under STABLE, STAGING, and TRANSITIONAL config...">oldServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#ad41230e2dec35359e3d3f936c7f4d60e">contains</a>(peer));
<a name="l00664"></a>00664         peerStats.set_new_member(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#abba01502b5eb5e710d3bdfb57d79dde9" title="Specifies the meaning of oldServers and newServers.">state</a> == State::TRANSITIONAL &amp;&amp;
<a name="l00665"></a>00665                                  <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a0a131fa2c4a9aabc0186b1c2c91f8661" title="A majority of these servers are necessary for a quorum under TRANSITIONAL configurations.">newServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#ad41230e2dec35359e3d3f936c7f4d60e">contains</a>(peer));
<a name="l00666"></a>00666         peerStats.set_staging_member(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#abba01502b5eb5e710d3bdfb57d79dde9" title="Specifies the meaning of oldServers and newServers.">state</a> == State::STAGING &amp;&amp;
<a name="l00667"></a>00667                                      <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a0a131fa2c4a9aabc0186b1c2c91f8661" title="A majority of these servers are necessary for a quorum under TRANSITIONAL configurations.">newServers</a>.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration_1_1SimpleConfiguration.html#ad41230e2dec35359e3d3f936c7f4d60e">contains</a>(peer));
<a name="l00668"></a>00668         peer-&gt;updatePeerStats(peerStats, time);
<a name="l00669"></a>00669     }
<a name="l00670"></a>00670 }
<a name="l00671"></a>00671 
<a name="l00672"></a>00672 std::ostream&amp;
<a name="l00673"></a><a class="code" href="namespaceLogCabin_1_1Server_1_1RaftConsensusInternal.html#ab440c8789c5f9a7818ac17972195d4e2">00673</a> <a class="code" href="namespaceLogCabin_1_1Server_1_1RaftConsensusInternal.html#ae6c452fe910faa2e4aee2efaeaaf0fd3">operator&lt;&lt;</a>(std::ostream&amp; os, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a602e7e486778ba0fda4c2ffceeeeb5ca" title="See state.">Configuration::State</a> state)
<a name="l00674"></a>00674 {
<a name="l00675"></a>00675     <span class="keyword">typedef</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a602e7e486778ba0fda4c2ffceeeeb5ca" title="See state.">Configuration::State</a> State;
<a name="l00676"></a>00676     <span class="keywordflow">switch</span> (state) {
<a name="l00677"></a>00677         <span class="keywordflow">case</span> State::BLANK:
<a name="l00678"></a>00678             os &lt;&lt; <span class="stringliteral">&quot;State::BLANK&quot;</span>;
<a name="l00679"></a>00679             <span class="keywordflow">break</span>;
<a name="l00680"></a>00680         <span class="keywordflow">case</span> State::STABLE:
<a name="l00681"></a>00681             os &lt;&lt; <span class="stringliteral">&quot;State::STABLE&quot;</span>;
<a name="l00682"></a>00682             <span class="keywordflow">break</span>;
<a name="l00683"></a>00683         <span class="keywordflow">case</span> State::STAGING:
<a name="l00684"></a>00684             os &lt;&lt; <span class="stringliteral">&quot;State::STAGING&quot;</span>;
<a name="l00685"></a>00685             <span class="keywordflow">break</span>;
<a name="l00686"></a>00686         <span class="keywordflow">case</span> State::TRANSITIONAL:
<a name="l00687"></a>00687             os &lt;&lt; <span class="stringliteral">&quot;State::TRANSITIONAL&quot;</span>;
<a name="l00688"></a>00688             <span class="keywordflow">break</span>;
<a name="l00689"></a>00689     }
<a name="l00690"></a>00690     <span class="keywordflow">return</span> os;
<a name="l00691"></a>00691 }
<a name="l00692"></a>00692 
<a name="l00693"></a>00693 std::ostream&amp;
<a name="l00694"></a><a class="code" href="namespaceLogCabin_1_1Server_1_1RaftConsensusInternal.html#a8013265fc87fea80ad1f85f30576f57a">00694</a> <a class="code" href="namespaceLogCabin_1_1Server_1_1RaftConsensusInternal.html#ae6c452fe910faa2e4aee2efaeaaf0fd3">operator&lt;&lt;</a>(std::ostream&amp; os, <span class="keyword">const</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html" title="A configuration defines the servers that are part of the cluster.">Configuration</a>&amp; configuration)
<a name="l00695"></a>00695 {
<a name="l00696"></a>00696     os &lt;&lt; <span class="stringliteral">&quot;Configuration: {&quot;</span> &lt;&lt; std::endl;
<a name="l00697"></a>00697     os &lt;&lt; <span class="stringliteral">&quot;  state: &quot;</span> &lt;&lt; configuration.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#abba01502b5eb5e710d3bdfb57d79dde9" title="Specifies the meaning of oldServers and newServers.">state</a> &lt;&lt; std::endl;
<a name="l00698"></a>00698     os &lt;&lt; <span class="stringliteral">&quot;  id: &quot;</span> &lt;&lt; configuration.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a5f68072bd5c041c6dc836d1a17bd15f3" title="The ID of the current configuration.">id</a> &lt;&lt; std::endl;
<a name="l00699"></a>00699     os &lt;&lt; <span class="stringliteral">&quot;  description: &quot;</span> &lt;&lt; std::endl;
<a name="l00700"></a>00700     os &lt;&lt; <a class="code" href="namespaceLogCabin_1_1Core_1_1ProtoBuf.html#a755e28f38764f420f33d7008aedced34" title="Dumps a protocol buffer message.">Core::ProtoBuf::dumpString</a>(configuration.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a18b5ea1ff0070a8f98260947f420a838" title="A description of the current configuration.">description</a>);
<a name="l00701"></a>00701     os &lt;&lt; <span class="stringliteral">&quot;}&quot;</span> &lt;&lt; std::endl;
<a name="l00702"></a>00702     <span class="keywordflow">for</span> (<span class="keyword">auto</span> it = configuration.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adc97b0a5dee772e4c7b3e37ac1230f9b" title="A map from server ID to Server of every server, including the local, previous, new, and staging servers.">knownServers</a>.begin();
<a name="l00703"></a>00703          it != configuration.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adc97b0a5dee772e4c7b3e37ac1230f9b" title="A map from server ID to Server of every server, including the local, previous, new, and staging servers.">knownServers</a>.end();
<a name="l00704"></a>00704          ++it) {
<a name="l00705"></a>00705         os &lt;&lt; *it-&gt;second;
<a name="l00706"></a>00706     }
<a name="l00707"></a>00707     <span class="keywordflow">return</span> os;
<a name="l00708"></a>00708 }
<a name="l00709"></a>00709 
<a name="l00710"></a>00710 <span class="comment"></span>
<a name="l00711"></a>00711 <span class="comment">////////// Configuration private methods //////////</span>
<a name="l00712"></a>00712 <span class="comment"></span>
<a name="l00713"></a>00713 std::shared_ptr&lt;Server&gt;
<a name="l00714"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a546755a466da0a62d27b5848b193e983">00714</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a546755a466da0a62d27b5848b193e983" title="If no server by the given ID is known, construct a new one.">Configuration::getServer</a>(uint64_t newServerId)
<a name="l00715"></a>00715 {
<a name="l00716"></a>00716     <span class="keyword">auto</span> it = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adc97b0a5dee772e4c7b3e37ac1230f9b" title="A map from server ID to Server of every server, including the local, previous, new, and staging servers.">knownServers</a>.find(newServerId);
<a name="l00717"></a>00717     <span class="keywordflow">if</span> (it != <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adc97b0a5dee772e4c7b3e37ac1230f9b" title="A map from server ID to Server of every server, including the local, previous, new, and staging servers.">knownServers</a>.end()) {
<a name="l00718"></a>00718         <span class="keywordflow">return</span> it-&gt;second;
<a name="l00719"></a>00719     } <span class="keywordflow">else</span> {
<a name="l00720"></a>00720         std::shared_ptr&lt;Peer&gt; peer(<span class="keyword">new</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html" title="Represents another server in the cluster.">Peer</a>(newServerId, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#af08504e6a6ba80678a5edf0f6252686a" title="Used for constructing Server instances.">consensus</a>));
<a name="l00721"></a>00721         <span class="keywordflow">if</span> (<a class="code" href="namespaceLogCabin_1_1Server_1_1RaftConsensusInternal.html#aa3a20ec5673f7f239631c204201a57e0" title="True if this should actually spawn threads, false otherwise.">startThreads</a>)
<a name="l00722"></a>00722             peer-&gt;startThread(peer);
<a name="l00723"></a>00723         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adc97b0a5dee772e4c7b3e37ac1230f9b" title="A map from server ID to Server of every server, including the local, previous, new, and staging servers.">knownServers</a>[newServerId] = peer;
<a name="l00724"></a>00724         <span class="keywordflow">return</span> peer;
<a name="l00725"></a>00725     }
<a name="l00726"></a>00726 }
<a name="l00727"></a>00727 <span class="comment"></span>
<a name="l00728"></a>00728 <span class="comment">////////// ConfigurationManager //////////</span>
<a name="l00729"></a>00729 <span class="comment"></span>
<a name="l00730"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a20dde8951e005beb38d1fc337042e1e3">00730</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a20dde8951e005beb38d1fc337042e1e3" title="Constructor.">ConfigurationManager::ConfigurationManager</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html" title="A configuration defines the servers that are part of the cluster.">Configuration</a>&amp; configuration)
<a name="l00731"></a>00731     : configuration(configuration)
<a name="l00732"></a>00732     , descriptions()
<a name="l00733"></a>00733     , snapshot(0, {})
<a name="l00734"></a>00734 {
<a name="l00735"></a>00735 }
<a name="l00736"></a>00736 
<a name="l00737"></a>00737 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#abb9e78257346313f89d479aad1cf360f" title="Destructor.">ConfigurationManager::~ConfigurationManager</a>()
<a name="l00738"></a>00738 {
<a name="l00739"></a>00739 }
<a name="l00740"></a>00740 
<a name="l00741"></a>00741 <span class="keywordtype">void</span>
<a name="l00742"></a>00742 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#aff783eca177f6fbbc4d3bd6d799859c0" title="Called when a new configuration is added to the log.">ConfigurationManager::add</a>(
<a name="l00743"></a>00743     uint64_t index,
<a name="l00744"></a>00744     <span class="keyword">const</span> <a class="code" href="namespaceLogCabin_1_1Client.html#a99e2b7ff4ee9b74bcf9dec83b6565fa2" title="Defines the members of the cluster.">Protocol::Raft::Configuration</a>&amp; description)
<a name="l00745"></a>00745 {
<a name="l00746"></a>00746     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a1b0e9174e1e054fdb2f6ec398575900b" title="This contains all the cluster configurations found in the log, plus one additional configuration from...">descriptions</a>[index] = description;
<a name="l00747"></a>00747     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a4e4d61fe51a62f8293d4a5667d68a1cc" title="Helper function called after changing this object&#39;s state.">restoreInvariants</a>();
<a name="l00748"></a>00748 }
<a name="l00749"></a>00749 
<a name="l00750"></a>00750 <span class="keywordtype">void</span>
<a name="l00751"></a>00751 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a9f31a1182a01209770403dbb49423476" title="Called when a log prefix is truncated (after saving a snapshot that covers this prefix).">ConfigurationManager::truncatePrefix</a>(uint64_t firstIndexKept)
<a name="l00752"></a>00752 {
<a name="l00753"></a>00753     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a1b0e9174e1e054fdb2f6ec398575900b" title="This contains all the cluster configurations found in the log, plus one additional configuration from...">descriptions</a>.erase(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a1b0e9174e1e054fdb2f6ec398575900b" title="This contains all the cluster configurations found in the log, plus one additional configuration from...">descriptions</a>.begin(),
<a name="l00754"></a>00754                        <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a1b0e9174e1e054fdb2f6ec398575900b" title="This contains all the cluster configurations found in the log, plus one additional configuration from...">descriptions</a>.lower_bound(firstIndexKept));
<a name="l00755"></a>00755     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a4e4d61fe51a62f8293d4a5667d68a1cc" title="Helper function called after changing this object&#39;s state.">restoreInvariants</a>();
<a name="l00756"></a>00756 }
<a name="l00757"></a>00757 
<a name="l00758"></a>00758 <span class="keywordtype">void</span>
<a name="l00759"></a>00759 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a2dc9ed6d199ba92faaeabf99f3f92e11" title="Called when a log suffix is truncated (when the leader doesn&#39;t agree with this server&#39;s log)...">ConfigurationManager::truncateSuffix</a>(uint64_t lastIndexKept)
<a name="l00760"></a>00760 {
<a name="l00761"></a>00761     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a1b0e9174e1e054fdb2f6ec398575900b" title="This contains all the cluster configurations found in the log, plus one additional configuration from...">descriptions</a>.erase(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a1b0e9174e1e054fdb2f6ec398575900b" title="This contains all the cluster configurations found in the log, plus one additional configuration from...">descriptions</a>.upper_bound(lastIndexKept),
<a name="l00762"></a>00762                        <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a1b0e9174e1e054fdb2f6ec398575900b" title="This contains all the cluster configurations found in the log, plus one additional configuration from...">descriptions</a>.end());
<a name="l00763"></a>00763     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a4e4d61fe51a62f8293d4a5667d68a1cc" title="Helper function called after changing this object&#39;s state.">restoreInvariants</a>();
<a name="l00764"></a>00764 }
<a name="l00765"></a>00765 
<a name="l00766"></a>00766 <span class="keywordtype">void</span>
<a name="l00767"></a>00767 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a9f2af8ae5b725e85ec6bccd788538ab9" title="Called when a new snapshot is saved.">ConfigurationManager::setSnapshot</a>(
<a name="l00768"></a>00768     uint64_t index,
<a name="l00769"></a>00769     <span class="keyword">const</span> <a class="code" href="namespaceLogCabin_1_1Client.html#a99e2b7ff4ee9b74bcf9dec83b6565fa2" title="Defines the members of the cluster.">Protocol::Raft::Configuration</a>&amp; description)
<a name="l00770"></a>00770 {
<a name="l00771"></a>00771     assert(index &gt;= <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a0219706f5f3f19733f82f6330ad49383" title="This reflects the configuration found in this server&#39;s latest snapshot, or {0, {}} if this server has...">snapshot</a>.first);
<a name="l00772"></a>00772     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a0219706f5f3f19733f82f6330ad49383" title="This reflects the configuration found in this server&#39;s latest snapshot, or {0, {}} if this server has...">snapshot</a> = {index, description};
<a name="l00773"></a>00773     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a4e4d61fe51a62f8293d4a5667d68a1cc" title="Helper function called after changing this object&#39;s state.">restoreInvariants</a>();
<a name="l00774"></a>00774 }
<a name="l00775"></a>00775 
<a name="l00776"></a>00776 std::pair&lt;uint64_t, Protocol::Raft::Configuration&gt;
<a name="l00777"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a4bcbda74f982a95c10e29e3657598b4b">00777</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a4bcbda74f982a95c10e29e3657598b4b" title="Return the configuration as of a particular log index.">ConfigurationManager::getLatestConfigurationAsOf</a>(
<a name="l00778"></a>00778                                         uint64_t lastIncludedIndex)<span class="keyword"> const</span>
<a name="l00779"></a>00779 <span class="keyword"></span>{
<a name="l00780"></a>00780     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a1b0e9174e1e054fdb2f6ec398575900b" title="This contains all the cluster configurations found in the log, plus one additional configuration from...">descriptions</a>.empty())
<a name="l00781"></a>00781         <span class="keywordflow">return</span> {0, {}};
<a name="l00782"></a>00782     <span class="keyword">auto</span> it = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a1b0e9174e1e054fdb2f6ec398575900b" title="This contains all the cluster configurations found in the log, plus one additional configuration from...">descriptions</a>.upper_bound(lastIncludedIndex);
<a name="l00783"></a>00783     <span class="comment">// &#39;it&#39; is either an element or end()</span>
<a name="l00784"></a>00784     <span class="keywordflow">if</span> (it == <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a1b0e9174e1e054fdb2f6ec398575900b" title="This contains all the cluster configurations found in the log, plus one additional configuration from...">descriptions</a>.begin())
<a name="l00785"></a>00785         <span class="keywordflow">return</span> {0, {}};
<a name="l00786"></a>00786     --it;
<a name="l00787"></a>00787     <span class="keywordflow">return</span> *it;
<a name="l00788"></a>00788 }
<a name="l00789"></a>00789 <span class="comment"></span>
<a name="l00790"></a>00790 <span class="comment">////////// ConfigurationManager private methods //////////</span>
<a name="l00791"></a>00791 <span class="comment"></span>
<a name="l00792"></a>00792 <span class="keywordtype">void</span>
<a name="l00793"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a4e4d61fe51a62f8293d4a5667d68a1cc">00793</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a4e4d61fe51a62f8293d4a5667d68a1cc" title="Helper function called after changing this object&#39;s state.">ConfigurationManager::restoreInvariants</a>()
<a name="l00794"></a>00794 {
<a name="l00795"></a>00795     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a0219706f5f3f19733f82f6330ad49383" title="This reflects the configuration found in this server&#39;s latest snapshot, or {0, {}} if this server has...">snapshot</a>.first != 0)
<a name="l00796"></a>00796         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a1b0e9174e1e054fdb2f6ec398575900b" title="This contains all the cluster configurations found in the log, plus one additional configuration from...">descriptions</a>.insert(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a0219706f5f3f19733f82f6330ad49383" title="This reflects the configuration found in this server&#39;s latest snapshot, or {0, {}} if this server has...">snapshot</a>);
<a name="l00797"></a>00797     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a1b0e9174e1e054fdb2f6ec398575900b" title="This contains all the cluster configurations found in the log, plus one additional configuration from...">descriptions</a>.empty()) {
<a name="l00798"></a>00798         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a855381f65214fe24d258989b099e0ddc" title="Defines the servers that are part of the cluster.">configuration</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a5b807b039c33d1b7042fce45f2e18520" title="Set the state of this object as if it had just been constructed.">reset</a>();
<a name="l00799"></a>00799     } <span class="keywordflow">else</span> {
<a name="l00800"></a>00800         <span class="keyword">auto</span> it = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a1b0e9174e1e054fdb2f6ec398575900b" title="This contains all the cluster configurations found in the log, plus one additional configuration from...">descriptions</a>.rbegin();
<a name="l00801"></a>00801         <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a855381f65214fe24d258989b099e0ddc" title="Defines the servers that are part of the cluster.">configuration</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#a5f68072bd5c041c6dc836d1a17bd15f3" title="The ID of the current configuration.">id</a> != it-&gt;first)
<a name="l00802"></a>00802             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ConfigurationManager.html#a855381f65214fe24d258989b099e0ddc" title="Defines the servers that are part of the cluster.">configuration</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Configuration.html#adee8a93ec9068cfaadf94db7b9c69bb8" title="Set the configuration.">setConfiguration</a>(it-&gt;first, it-&gt;second);
<a name="l00803"></a>00803     }
<a name="l00804"></a>00804 }
<a name="l00805"></a>00805 <span class="comment"></span>
<a name="l00806"></a>00806 <span class="comment">////////// ClusterClock //////////</span>
<a name="l00807"></a>00807 <span class="comment"></span>
<a name="l00808"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#a43efecbebdea1a5707fbc3d0ee20c757">00808</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#a43efecbebdea1a5707fbc3d0ee20c757" title="Default constructor.">ClusterClock::ClusterClock</a>()
<a name="l00809"></a>00809     : clusterTimeAtEpoch(0)
<a name="l00810"></a>00810     , localTimeAtEpoch(Core::Time::<a class="code" href="namespaceLogCabin_1_1Core_1_1Time.html#a4798c7e2244561626e4ce819710e7e56" title="The best available clock on this system for uses where a steady, monotonic clock is desired...">SteadyClock</a>::now())
<a name="l00811"></a>00811 {
<a name="l00812"></a>00812 }
<a name="l00813"></a>00813 
<a name="l00814"></a>00814 <span class="keywordtype">void</span>
<a name="l00815"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#ad5adb9f0618aeb7a7a55e1524849a8bc">00815</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#ad5adb9f0618aeb7a7a55e1524849a8bc" title="Reset to the given cluster time, assuming it&#39;s the current time right now.">ClusterClock::newEpoch</a>(uint64_t clusterTime)
<a name="l00816"></a>00816 {
<a name="l00817"></a>00817     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#a9d1de557c99f1ad6b3b175f9d4838983" title="Invariant: this is equal to the cluster time in:">clusterTimeAtEpoch</a> = clusterTime;
<a name="l00818"></a>00818     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#ad39b718a9463f3d114da58deb290065f" title="The local SteadyClock time when clusterTimeAtEpoch was set.">localTimeAtEpoch</a> = <a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a13f545c6020dd190e13d21e2577cc59b">Core::Time::SteadyClock::now</a>();
<a name="l00819"></a>00819 }
<a name="l00820"></a>00820 
<a name="l00821"></a>00821 uint64_t
<a name="l00822"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#acfeeb3627de0308d4259324b78b7d84a">00822</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#acfeeb3627de0308d4259324b78b7d84a" title="Called by leaders to generate a new cluster time for a new log entry.">ClusterClock::leaderStamp</a>()
<a name="l00823"></a>00823 {
<a name="l00824"></a>00824     <span class="keyword">auto</span> localTime = <a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a13f545c6020dd190e13d21e2577cc59b">Core::Time::SteadyClock::now</a>();
<a name="l00825"></a>00825     uint64_t nanosSinceEpoch =
<a name="l00826"></a>00826         Core::Util::downCast&lt;uint64_t&gt;(std::chrono::nanoseconds(
<a name="l00827"></a>00827             localTime - <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#ad39b718a9463f3d114da58deb290065f" title="The local SteadyClock time when clusterTimeAtEpoch was set.">localTimeAtEpoch</a>).count());
<a name="l00828"></a>00828     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#a9d1de557c99f1ad6b3b175f9d4838983" title="Invariant: this is equal to the cluster time in:">clusterTimeAtEpoch</a> += nanosSinceEpoch;
<a name="l00829"></a>00829     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#ad39b718a9463f3d114da58deb290065f" title="The local SteadyClock time when clusterTimeAtEpoch was set.">localTimeAtEpoch</a> = localTime;
<a name="l00830"></a>00830     <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#a9d1de557c99f1ad6b3b175f9d4838983" title="Invariant: this is equal to the cluster time in:">clusterTimeAtEpoch</a>;
<a name="l00831"></a>00831 }
<a name="l00832"></a>00832 
<a name="l00833"></a>00833 uint64_t
<a name="l00834"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#a348adcaf81872e5046c141a95c7771fe">00834</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#a348adcaf81872e5046c141a95c7771fe" title="Return the best approximation of the current cluster time, assuming there&#39;s been a leader all along...">ClusterClock::interpolate</a>()<span class="keyword"> const</span>
<a name="l00835"></a>00835 <span class="keyword"></span>{
<a name="l00836"></a>00836     <span class="keyword">auto</span> localTime = <a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a13f545c6020dd190e13d21e2577cc59b">Core::Time::SteadyClock::now</a>();
<a name="l00837"></a>00837     uint64_t nanosSinceEpoch =
<a name="l00838"></a>00838         Core::Util::downCast&lt;uint64_t&gt;(std::chrono::nanoseconds(
<a name="l00839"></a>00839             localTime - <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#ad39b718a9463f3d114da58deb290065f" title="The local SteadyClock time when clusterTimeAtEpoch was set.">localTimeAtEpoch</a>).count());
<a name="l00840"></a>00840     <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#a9d1de557c99f1ad6b3b175f9d4838983" title="Invariant: this is equal to the cluster time in:">clusterTimeAtEpoch</a> + nanosSinceEpoch;
<a name="l00841"></a>00841 }
<a name="l00842"></a>00842 
<a name="l00843"></a>00843 <span class="keyword">namespace </span>{
<a name="l00844"></a>00844 
<a name="l00845"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_03_1_1StagingProgressing.html">00845</a> <span class="keyword">struct </span><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_03_1_1StagingProgressing.html">StagingProgressing</a> {
<a name="l00846"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_03_1_1StagingProgressing.html#a29bb96a543cc35c1f2724f768b5dbbd2">00846</a>     <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_03_1_1StagingProgressing.html">StagingProgressing</a>(uint64_t epoch,
<a name="l00847"></a>00847                        Protocol::Client::SetConfiguration::Response&amp; response)
<a name="l00848"></a>00848         : epoch(epoch)
<a name="l00849"></a>00849         , response(response)
<a name="l00850"></a>00850     {
<a name="l00851"></a>00851     }
<a name="l00852"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_03_1_1StagingProgressing.html#afdc55acdc5480470787d359d38f7bd17">00852</a>     <span class="keywordtype">bool</span> <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_03_1_1StagingProgressing.html#afdc55acdc5480470787d359d38f7bd17">operator()</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html" title="A base class for known servers in the cluster, including this process (see LocalServer) and others (s...">Server</a>&amp; server) {
<a name="l00853"></a>00853         uint64_t serverEpoch = server.getLastAckEpoch();
<a name="l00854"></a>00854         <span class="keywordflow">if</span> (serverEpoch &lt; epoch) {
<a name="l00855"></a>00855             <span class="keyword">auto</span>&amp; s = *response.mutable_configuration_bad()-&gt;add_bad_servers();
<a name="l00856"></a>00856             s.set_server_id(server.serverId);
<a name="l00857"></a>00857             s.set_addresses(server.addresses);
<a name="l00858"></a>00858             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00859"></a>00859         }
<a name="l00860"></a>00860         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00861"></a>00861     }
<a name="l00862"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_03_1_1StagingProgressing.html#ac16e3e39a343aad0667e2181c0065678">00862</a>     <span class="keyword">const</span> uint64_t <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_03_1_1StagingProgressing.html#ac16e3e39a343aad0667e2181c0065678">epoch</a>;
<a name="l00863"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_03_1_1StagingProgressing.html#a00bb23186ed3fc152fa6631b3abfb03e">00863</a>     Protocol::Client::SetConfiguration::Response&amp; <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_03_1_1StagingProgressing.html#a00bb23186ed3fc152fa6631b3abfb03e">response</a>;
<a name="l00864"></a>00864 };
<a name="l00865"></a>00865 
<a name="l00866"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_034ea328804191cee4a5b5761fbbd777da.html">00866</a> <span class="keyword">struct </span><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_034ea328804191cee4a5b5761fbbd777da.html">StateMachineVersionIntersection</a> {
<a name="l00867"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_034ea328804191cee4a5b5761fbbd777da.html#a18e6b23a7d5fb1a4eb56f2c86ed0b2be">00867</a>     <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_034ea328804191cee4a5b5761fbbd777da.html">StateMachineVersionIntersection</a>()
<a name="l00868"></a>00868         : missingCount(0)
<a name="l00869"></a>00869         , allCount(0)
<a name="l00870"></a>00870         , minVersion(0)
<a name="l00871"></a>00871         , maxVersion(std::numeric_limits&lt;uint16_t&gt;::max()) {
<a name="l00872"></a>00872     }
<a name="l00873"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_034ea328804191cee4a5b5761fbbd777da.html#a645a491b929a64b8a427a40ac66b1efd">00873</a>     <span class="keywordtype">void</span> <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_034ea328804191cee4a5b5761fbbd777da.html#a645a491b929a64b8a427a40ac66b1efd">operator()</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html" title="A base class for known servers in the cluster, including this process (see LocalServer) and others (s...">Server</a>&amp; server) {
<a name="l00874"></a>00874         ++allCount;
<a name="l00875"></a>00875         <span class="keywordflow">if</span> (server.haveStateMachineSupportedVersions) {
<a name="l00876"></a>00876             minVersion = std::max(server.minStateMachineVersion,
<a name="l00877"></a>00877                                   minVersion);
<a name="l00878"></a>00878             maxVersion = std::min(server.maxStateMachineVersion,
<a name="l00879"></a>00879                                   maxVersion);
<a name="l00880"></a>00880         } <span class="keywordflow">else</span> {
<a name="l00881"></a>00881             ++missingCount;
<a name="l00882"></a>00882         }
<a name="l00883"></a>00883     }
<a name="l00884"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_034ea328804191cee4a5b5761fbbd777da.html#ab842836ae76b2bb18c61b41f1bf86ad6">00884</a>     uint64_t <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_034ea328804191cee4a5b5761fbbd777da.html#ab842836ae76b2bb18c61b41f1bf86ad6">missingCount</a>;
<a name="l00885"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_034ea328804191cee4a5b5761fbbd777da.html#a79339375bda466ccb71f581ddc7852c1">00885</a>     uint64_t <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_034ea328804191cee4a5b5761fbbd777da.html#a79339375bda466ccb71f581ddc7852c1">allCount</a>;
<a name="l00886"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_034ea328804191cee4a5b5761fbbd777da.html#a82cd85955c01a1e584e7446914e20163">00886</a>     uint16_t <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_034ea328804191cee4a5b5761fbbd777da.html#a82cd85955c01a1e584e7446914e20163">minVersion</a>;
<a name="l00887"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_034ea328804191cee4a5b5761fbbd777da.html#a3e19c3c923031ca2894137a367b34282">00887</a>     uint16_t <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensusInternal_1_1anonymous__namespace_02RaftConsensus_8cc_034ea328804191cee4a5b5761fbbd777da.html#a3e19c3c923031ca2894137a367b34282">maxVersion</a>;
<a name="l00888"></a>00888 };
<a name="l00889"></a>00889 
<a name="l00890"></a>00890 } <span class="comment">// anonymous namespace</span>
<a name="l00891"></a>00891 
<a name="l00892"></a>00892 } <span class="comment">// namespace RaftConsensusInternal</span>
<a name="l00893"></a>00893 <span class="comment"></span>
<a name="l00894"></a>00894 <span class="comment">////////// RaftConsensus::Entry //////////</span>
<a name="l00895"></a>00895 <span class="comment"></span>
<a name="l00896"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html#a147163abb6568451cd4767b29e594936">00896</a> <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html#a147163abb6568451cd4767b29e594936" title="Default constructor.">RaftConsensus::Entry::Entry</a>()
<a name="l00897"></a>00897     : index(0)
<a name="l00898"></a>00898     , type(SKIP)
<a name="l00899"></a>00899     , command()
<a name="l00900"></a>00900     , snapshotReader()
<a name="l00901"></a>00901     , clusterTime(0)
<a name="l00902"></a>00902 {
<a name="l00903"></a>00903 }
<a name="l00904"></a>00904 
<a name="l00905"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html#a17145c4dc7740fc8482584fac6f4b018">00905</a> <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html#a147163abb6568451cd4767b29e594936" title="Default constructor.">RaftConsensus::Entry::Entry</a>(<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html" title="This is returned by getNextEntry().">Entry</a>&amp;&amp; other)
<a name="l00906"></a>00906     : index(other.index)
<a name="l00907"></a>00907     , type(other.type)
<a name="l00908"></a>00908     , command(std::move(other.command))
<a name="l00909"></a>00909     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a66df54dcef389e690e4e94df391f8120" title="If not NULL, this is a Storage::SnapshotFile::Reader that covers up through lastSnapshotIndex.">snapshotReader</a>(std::move(other.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a66df54dcef389e690e4e94df391f8120" title="If not NULL, this is a Storage::SnapshotFile::Reader that covers up through lastSnapshotIndex.">snapshotReader</a>))
<a name="l00910"></a>00910     , clusterTime(other.clusterTime)
<a name="l00911"></a>00911 {
<a name="l00912"></a>00912 }
<a name="l00913"></a>00913 
<a name="l00914"></a><a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html#a43d3cae5e0048ae8205408e5886c60e5">00914</a> <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html#a43d3cae5e0048ae8205408e5886c60e5" title="Destructor.">RaftConsensus::Entry::~Entry</a>()
<a name="l00915"></a>00915 {
<a name="l00916"></a>00916 }
<a name="l00917"></a>00917 <span class="comment"></span>
<a name="l00918"></a>00918 <span class="comment">////////// RaftConsensus //////////</span>
<a name="l00919"></a>00919 <span class="comment"></span>
<a name="l00920"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a646a92b13739ed77da6ffefc7cd7ebe8">00920</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a646a92b13739ed77da6ffefc7cd7ebe8" title="Constructor.">RaftConsensus::RaftConsensus</a>(<a class="code" href="classLogCabin_1_1Server_1_1Globals.html" title="Holds the LogCabin daemon&#39;s top-level objects.">Globals</a>&amp; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a18a8fc189422f6eb3f5f0497e4e102b1" title="The LogCabin daemon&#39;s top-level objects.">globals</a>)
<a name="l00921"></a>00921     : <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5a76d9fce7cc8e8bd69bcf059b89ad93" title="A follower waits for about this much inactivity before becoming a candidate and starting a new electi...">ELECTION_TIMEOUT_MS</a>(globals.config.read&lt;uint64_t&gt;(
<a name="l00922"></a>00922         <span class="stringliteral">&quot;electionTimeoutMilliseconds&quot;</span>, 500))
<a name="l00923"></a>00923     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a4b4eba8076afd37eb50b234346d491dc" title="A leader sends RPCs at least this often, even if there is no data to send.">HEARTBEAT_PERIOD_MS</a>(globals.config.read&lt;uint64_t&gt;(
<a name="l00924"></a>00924         <span class="stringliteral">&quot;heartbeatPeriodMilliseconds&quot;</span>,
<a name="l00925"></a>00925         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5a76d9fce7cc8e8bd69bcf059b89ad93" title="A follower waits for about this much inactivity before becoming a candidate and starting a new electi...">ELECTION_TIMEOUT_MS</a> / 2))
<a name="l00926"></a>00926     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a8c3ec432979e19052a70bd756ebd5689" title="A candidate or leader waits this long after an RPC fails before sending another one, so as to not overwhelm the network with retries.">RPC_FAILURE_BACKOFF_MS</a>(globals.config.read&lt;uint64_t&gt;(
<a name="l00927"></a>00927         <span class="stringliteral">&quot;rpcFailureBackoffMilliseconds&quot;</span>,
<a name="l00928"></a>00928         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5a76d9fce7cc8e8bd69bcf059b89ad93" title="A follower waits for about this much inactivity before becoming a candidate and starting a new electi...">ELECTION_TIMEOUT_MS</a> / 2))
<a name="l00929"></a>00929     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a4b14bc75339c857054abc16882aae2d8" title="How long the state machine updater thread should sleep if:">STATE_MACHINE_UPDATER_BACKOFF</a>(std::chrono::milliseconds(
<a name="l00930"></a>00930         globals.config.read&lt;uint64_t&gt;(
<a name="l00931"></a>00931             <span class="stringliteral">&quot;stateMachineUpdaterBackoffMilliseconds&quot;</span>,
<a name="l00932"></a>00932             10000)))
<a name="l00933"></a>00933     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a8b367b81c3af4957007d02ec2e136275" title="Prefer to keep RPC requests under this size.">SOFT_RPC_SIZE_LIMIT</a>(Protocol::Common::<a class="code" href="namespaceLogCabin_1_1Protocol_1_1Common.html#aa6228f646abedfa36fd7716cb7228570a04fad61d856722e9a6d32f23980b332f">MAX_MESSAGE_LENGTH</a> - 1024)
<a name="l00934"></a>00934     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a32b5b6a4d6ae35dcd20c8ba3e7a95de0" title="This server&#39;s unique ID.">serverId</a>(0)
<a name="l00935"></a>00935     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#af1238b47653a95c110dc9d526e006286" title="The addresses that this server is listening on.">serverAddresses</a>()
<a name="l00936"></a>00936     , globals(globals)
<a name="l00937"></a>00937     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a6bed133d4a5b6e69399b1dbc44f7f483" title="Where the files for the log and snapshots are stored.">storageLayout</a>()
<a name="l00938"></a>00938     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a4d16a25856a2ba0c739fdfde0db05d89" title="Used to create new sessions.">sessionManager</a>(globals.eventLoop,
<a name="l00939"></a>00939                      globals.config)
<a name="l00940"></a>00940     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>()
<a name="l00941"></a>00941     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>()
<a name="l00942"></a>00942     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a7f8cdeb3a67e3398cca54f23eb5022a6" title="Set to true when this class is about to be destroyed.">exiting</a>(false)
<a name="l00943"></a>00943     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b784132bbc03e602f0a8233d6e570f" title="The number of Peer::thread threads that are still using this RaftConsensus object.">numPeerThreads</a>(0)
<a name="l00944"></a>00944     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>()
<a name="l00945"></a>00945     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aa6c06993ed2a50989b453f120cd31aea" title="Flag to indicate that leaderDiskThreadMain should flush recent log writes to stable storage...">logSyncQueued</a>(false)
<a name="l00946"></a>00946     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a3f885e618c137506f3e0da0fdbe4b13d" title="Used for stepDown() to wait on leaderDiskThread without releasing mutex.">leaderDiskThreadWorking</a>(false)
<a name="l00947"></a>00947     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>()
<a name="l00948"></a>00948     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ade5bbdec3e8ff60b7931a2682b2bb4ef" title="Ensures that &#39;configuration&#39; reflects the latest state of the log and snapshot.">configurationManager</a>()
<a name="l00949"></a>00949     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>(0)
<a name="l00950"></a>00950     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a8a1270561380477170b6c7447705d74f" title="See state.">State</a>::<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a8a1270561380477170b6c7447705d74fa589983a6c56c8a49a9dac22184a0e0e7" title="A follower does not initiate RPCs.">FOLLOWER</a>)
<a name="l00951"></a>00951     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>(0)
<a name="l00952"></a>00952     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5f0c55552abd43fa5b1ffe779f70fcf9" title="The term of the last entry covered by the latest good snapshot, or 0 if we have no snapshot...">lastSnapshotTerm</a>(0)
<a name="l00953"></a>00953     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#af98e037190d928bbe2ecda31a19ca7c2" title="The cluster time of the last entry covered by the latest good snapshot, or 0 if we have no snapshot...">lastSnapshotClusterTime</a>(0)
<a name="l00954"></a>00954     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a3f14561ea354f31be363ab7f008b9961" title="The size of the latest good snapshot in bytes, or 0 if we have no snapshot.">lastSnapshotBytes</a>(0)
<a name="l00955"></a>00955     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a66df54dcef389e690e4e94df391f8120" title="If not NULL, this is a Storage::SnapshotFile::Reader that covers up through lastSnapshotIndex.">snapshotReader</a>()
<a name="l00956"></a>00956     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a750be73694a5e22bffc9c62f61cbb779" title="This is used in handleInstallSnapshot when receiving a snapshot from the current leader.">snapshotWriter</a>()
<a name="l00957"></a>00957     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a>(0)
<a name="l00958"></a>00958     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae3f2b58c62af497eb474046566656f67" title="The server ID of the leader for this term.">leaderId</a>(0)
<a name="l00959"></a>00959     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1add1a4497b990f9f4b053266459b59d" title="The server ID that this server voted for during this term&#39;s election, if any.">votedFor</a>(0)
<a name="l00960"></a>00960     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1ab1473657769c339579f02f7e454513" title="A logical clock used to confirm leadership and connectivity.">currentEpoch</a>(0)
<a name="l00961"></a>00961     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aa525cfc8dac0abdc8f744f5bd75302ae" title="Tracks the passage of &quot;cluster time&quot;.">clusterClock</a>()
<a name="l00962"></a>00962     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a3528d66b8409ca51a4392d7c3f395d39" title="The earliest time at which timerThread should begin a new election with startNewElection().">startElectionAt</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#adadb64ccb66627454e6001aca18dc801">TimePoint</a>::max())
<a name="l00963"></a>00963     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a075b1f3174db6673435f31622c231d02" title="The earliest time at which RequestVote messages should be processed.">withholdVotesUntil</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#adadb64ccb66627454e6001aca18dc801">TimePoint</a>::min())
<a name="l00964"></a>00964     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a651ad565303b12e3ab72a38429349d23" title="The total number of entries ever truncated from the end of the log.">numEntriesTruncated</a>(0)
<a name="l00965"></a>00965     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a07ae9a16a699b6773c80175d0d3a003b" title="The thread that executes leaderDiskThreadMain() to flush log entries to stable storage in the backgro...">leaderDiskThread</a>()
<a name="l00966"></a>00966     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a502802fd49e11b01a4005f2cd794fc68" title="The thread that executes timerThreadMain() to begin new elections after periods of inactivity...">timerThread</a>()
<a name="l00967"></a>00967     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1c438e3a3d2f82e759258ec0d0169819" title="The thread that executes stateMachineUpdaterThreadMain() to append advance state machine version entr...">stateMachineUpdaterThread</a>()
<a name="l00968"></a>00968     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2fc61e8f83d7ea5520bb1a81c236dd28" title="The thread that executes stepDownThreadMain() to return to the follower state if the leader becomes d...">stepDownThread</a>()
<a name="l00969"></a>00969     , <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2d6ee7995b60660085fdf042d07c276c">invariants</a>(*this)
<a name="l00970"></a>00970 {
<a name="l00971"></a>00971 }
<a name="l00972"></a>00972 
<a name="l00973"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#add876ba1ed44af748a4128cd78a41da4">00973</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#add876ba1ed44af748a4128cd78a41da4" title="Destructor.">RaftConsensus::~RaftConsensus</a>()
<a name="l00974"></a>00974 {
<a name="l00975"></a>00975     <span class="keywordflow">if</span> (!<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a7f8cdeb3a67e3398cca54f23eb5022a6" title="Set to true when this class is about to be destroyed.">exiting</a>)
<a name="l00976"></a>00976         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5f315e9f0ad06d3b924fdadf04ecfd60" title="Signal the consensus module to exit (shut down threads, etc).">exit</a>();
<a name="l00977"></a>00977     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a07ae9a16a699b6773c80175d0d3a003b" title="The thread that executes leaderDiskThreadMain() to flush log entries to stable storage in the backgro...">leaderDiskThread</a>.joinable())
<a name="l00978"></a>00978         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a07ae9a16a699b6773c80175d0d3a003b" title="The thread that executes leaderDiskThreadMain() to flush log entries to stable storage in the backgro...">leaderDiskThread</a>.join();
<a name="l00979"></a>00979     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a502802fd49e11b01a4005f2cd794fc68" title="The thread that executes timerThreadMain() to begin new elections after periods of inactivity...">timerThread</a>.joinable())
<a name="l00980"></a>00980         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a502802fd49e11b01a4005f2cd794fc68" title="The thread that executes timerThreadMain() to begin new elections after periods of inactivity...">timerThread</a>.join();
<a name="l00981"></a>00981     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1c438e3a3d2f82e759258ec0d0169819" title="The thread that executes stateMachineUpdaterThreadMain() to append advance state machine version entr...">stateMachineUpdaterThread</a>.joinable())
<a name="l00982"></a>00982         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1c438e3a3d2f82e759258ec0d0169819" title="The thread that executes stateMachineUpdaterThreadMain() to append advance state machine version entr...">stateMachineUpdaterThread</a>.join();
<a name="l00983"></a>00983     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2fc61e8f83d7ea5520bb1a81c236dd28" title="The thread that executes stepDownThreadMain() to return to the follower state if the leader becomes d...">stepDownThread</a>.joinable())
<a name="l00984"></a>00984         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2fc61e8f83d7ea5520bb1a81c236dd28" title="The thread that executes stepDownThreadMain() to return to the follower state if the leader becomes d...">stepDownThread</a>.join();
<a name="l00985"></a>00985     <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Joined with disk and timer threads&quot;</span>);
<a name="l00986"></a>00986     std::unique_lock&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l00987"></a>00987     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b784132bbc03e602f0a8233d6e570f" title="The number of Peer::thread threads that are still using this RaftConsensus object.">numPeerThreads</a> &gt; 0) {
<a name="l00988"></a>00988         <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Waiting for %u peer threads to exit&quot;</span>, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b784132bbc03e602f0a8233d6e570f" title="The number of Peer::thread threads that are still using this RaftConsensus object.">numPeerThreads</a>);
<a name="l00989"></a>00989         <span class="keywordflow">while</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b784132bbc03e602f0a8233d6e570f" title="The number of Peer::thread threads that are still using this RaftConsensus object.">numPeerThreads</a> &gt; 0)
<a name="l00990"></a>00990             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#aedc8162c9f0251ae3491e6bc6efbe477">wait</a>(lockGuard);
<a name="l00991"></a>00991     }
<a name="l00992"></a>00992     <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Peer threads have exited&quot;</span>);
<a name="l00993"></a>00993     <span class="comment">// issue any outstanding disk flushes</span>
<a name="l00994"></a>00994     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aa6c06993ed2a50989b453f120cd31aea" title="Flag to indicate that leaderDiskThreadMain should flush recent log writes to stable storage...">logSyncQueued</a>) {
<a name="l00995"></a>00995         std::unique_ptr&lt;Log::Sync&gt; sync = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;takeSync();
<a name="l00996"></a>00996         sync-&gt;wait();
<a name="l00997"></a>00997         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;syncComplete(std::move(sync));
<a name="l00998"></a>00998     }
<a name="l00999"></a>00999     <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Completed disk writes&quot;</span>);
<a name="l01000"></a>01000 }
<a name="l01001"></a>01001 
<a name="l01002"></a>01002 <span class="keywordtype">void</span>
<a name="l01003"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ad2dca58bbacf2e172a737c84a4f0789b">01003</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ad2dca58bbacf2e172a737c84a4f0789b" title="Initialize. Must be called before any other method.">RaftConsensus::init</a>()
<a name="l01004"></a>01004 {
<a name="l01005"></a>01005     std::lock_guard&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l01006"></a>01006 <span class="preprocessor">#if DEBUG</span>
<a name="l01007"></a>01007 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a18a8fc189422f6eb3f5f0497e4e102b1" title="The LogCabin daemon&#39;s top-level objects.">globals</a>.<a class="code" href="classLogCabin_1_1Server_1_1Globals.html#a0716780cdbc776d14d8e63f9b6cdce41" title="Global configuration options.">config</a>.<a class="code" href="classLogCabin_1_1Core_1_1Config.html#a9463413099189cc32b0f372621d92fba" title="Read the value corresponding to a key.">read</a>&lt;<span class="keywordtype">bool</span>&gt;(<span class="stringliteral">&quot;raftDebug&quot;</span>, <span class="keyword">false</span>)) {
<a name="l01008"></a>01008         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>.<a class="code" href="classLogCabin_1_1Core_1_1Mutex.html#a9b6a7d967ca3c6be6681255bdd58a894" title="This function will be called with the lock held after the lock is acquired and before it is released...">callback</a> = std::bind(&amp;<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Invariants.html#a24d92b28bef05210c492634c6c7cdc3b">Invariants::checkAll</a>, &amp;<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2d6ee7995b60660085fdf042d07c276c">invariants</a>);
<a name="l01009"></a>01009     }
<a name="l01010"></a>01010 <span class="preprocessor">#endif</span>
<a name="l01011"></a>01011 <span class="preprocessor"></span>
<a name="l01012"></a>01012     <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;My server ID is %lu&quot;</span>, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a32b5b6a4d6ae35dcd20c8ba3e7a95de0" title="This server&#39;s unique ID.">serverId</a>);
<a name="l01013"></a>01013 
<a name="l01014"></a>01014     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a6bed133d4a5b6e69399b1dbc44f7f483" title="Where the files for the log and snapshots are stored.">storageLayout</a>.<a class="code" href="classLogCabin_1_1Storage_1_1Layout.html#a434a2c1d6230bd4dfc621e0ddfa382b0" title="Contains all files.">topDir</a>.<a class="code" href="classLogCabin_1_1Storage_1_1FilesystemUtil_1_1File.html#ad90bd1b9eeb500e3edccfa8eef8fb092" title="The open file descriptor, or -1 otherwise.">fd</a> == -1) {
<a name="l01015"></a>01015         <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a18a8fc189422f6eb3f5f0497e4e102b1" title="The LogCabin daemon&#39;s top-level objects.">globals</a>.<a class="code" href="classLogCabin_1_1Server_1_1Globals.html#a0716780cdbc776d14d8e63f9b6cdce41" title="Global configuration options.">config</a>.<a class="code" href="classLogCabin_1_1Core_1_1Config.html#a9463413099189cc32b0f372621d92fba" title="Read the value corresponding to a key.">read</a>(<span class="stringliteral">&quot;use-temporary-storage&quot;</span>, <span class="keyword">false</span>))
<a name="l01016"></a>01016             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a6bed133d4a5b6e69399b1dbc44f7f483" title="Where the files for the log and snapshots are stored.">storageLayout</a>.<a class="code" href="classLogCabin_1_1Storage_1_1Layout.html#a52a9da5994543b80d3e867420270c952" title="Initialize for unit tests.">initTemporary</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a32b5b6a4d6ae35dcd20c8ba3e7a95de0" title="This server&#39;s unique ID.">serverId</a>); <span class="comment">// unit tests</span>
<a name="l01017"></a>01017         <span class="keywordflow">else</span>
<a name="l01018"></a>01018             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a6bed133d4a5b6e69399b1dbc44f7f483" title="Where the files for the log and snapshots are stored.">storageLayout</a>.<a class="code" href="classLogCabin_1_1Storage_1_1Layout.html#a6dda2698cba322363883ff039c6ef3eb" title="Initialize in the normal way for a LogCabin server.">init</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a18a8fc189422f6eb3f5f0497e4e102b1" title="The LogCabin daemon&#39;s top-level objects.">globals</a>.<a class="code" href="classLogCabin_1_1Server_1_1Globals.html#a0716780cdbc776d14d8e63f9b6cdce41" title="Global configuration options.">config</a>, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a32b5b6a4d6ae35dcd20c8ba3e7a95de0" title="This server&#39;s unique ID.">serverId</a>);
<a name="l01019"></a>01019     }
<a name="l01020"></a>01020 
<a name="l01021"></a>01021     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>.reset(<span class="keyword">new</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#abb92a771973338b1819053776ee8c7d7">Configuration</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a32b5b6a4d6ae35dcd20c8ba3e7a95de0" title="This server&#39;s unique ID.">serverId</a>, *<span class="keyword">this</span>));
<a name="l01022"></a>01022     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ade5bbdec3e8ff60b7931a2682b2bb4ef" title="Ensures that &#39;configuration&#39; reflects the latest state of the log and snapshot.">configurationManager</a>.reset(<span class="keyword">new</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a95aef651c5cb2af93b4fa31595cb54a0">ConfigurationManager</a>(*<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>));
<a name="l01023"></a>01023 
<a name="l01024"></a>01024     <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Reading the log&quot;</span>);
<a name="l01025"></a>01025     <span class="keywordflow">if</span> (!<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>) { <span class="comment">// some unit tests pre-set the log; don&#39;t overwrite it</span>
<a name="l01026"></a>01026         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a> = <a class="code" href="namespaceLogCabin_1_1Storage_1_1LogFactory.html#a6f87950142c86227bcfc09cde3dffcc6" title="Construct and return a Log object.">Storage::LogFactory::makeLog</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a18a8fc189422f6eb3f5f0497e4e102b1" title="The LogCabin daemon&#39;s top-level objects.">globals</a>.<a class="code" href="classLogCabin_1_1Server_1_1Globals.html#a0716780cdbc776d14d8e63f9b6cdce41" title="Global configuration options.">config</a>, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a6bed133d4a5b6e69399b1dbc44f7f483" title="Where the files for the log and snapshots are stored.">storageLayout</a>);
<a name="l01027"></a>01027     }
<a name="l01028"></a>01028     <span class="keywordflow">for</span> (uint64_t index = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLogStartIndex();
<a name="l01029"></a>01029          index &lt;= <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex();
<a name="l01030"></a>01030          ++index) {
<a name="l01031"></a>01031         <span class="keyword">const</span> <a class="code" href="classLogCabin_1_1Storage_1_1Log.html#a8ca64ace5d6ae6f0175186c595d4fbe0" title="The type of a log entry (the same format that&#39;s used in AppendEntries).">Log::Entry</a>&amp; entry = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getEntry(index);
<a name="l01032"></a>01032         <span class="keywordflow">if</span> (entry.type() == Protocol::Raft::EntryType::UNKNOWN) {
<a name="l01033"></a>01033             <a class="code" href="Core_2Debug_8h.html#ad84b0f521394f4d9214c9d185711a8c3" title="Log an ERROR message and abort the process.">PANIC</a>(<span class="stringliteral">&quot;Don&#39;t understand the entry type for index %lu (term %lu) &quot;</span>
<a name="l01034"></a>01034                   <span class="stringliteral">&quot;found on disk&quot;</span>,
<a name="l01035"></a>01035                   index, entry.term());
<a name="l01036"></a>01036         }
<a name="l01037"></a>01037         <span class="keywordflow">if</span> (entry.type() == Protocol::Raft::EntryType::CONFIGURATION) {
<a name="l01038"></a>01038             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ade5bbdec3e8ff60b7931a2682b2bb4ef" title="Ensures that &#39;configuration&#39; reflects the latest state of the log and snapshot.">configurationManager</a>-&gt;add(index, entry.configuration());
<a name="l01039"></a>01039         }
<a name="l01040"></a>01040     }
<a name="l01041"></a>01041 
<a name="l01042"></a>01042     <span class="comment">// Restore cluster time epoch from last log entry, if any</span>
<a name="l01043"></a>01043     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex() &gt;= <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLogStartIndex()) {
<a name="l01044"></a>01044         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aa525cfc8dac0abdc8f744f5bd75302ae" title="Tracks the passage of &quot;cluster time&quot;.">clusterClock</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#ad5adb9f0618aeb7a7a55e1524849a8bc" title="Reset to the given cluster time, assuming it&#39;s the current time right now.">newEpoch</a>(
<a name="l01045"></a>01045             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getEntry(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex()).cluster_time());
<a name="l01046"></a>01046     }
<a name="l01047"></a>01047 
<a name="l01048"></a>01048     <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;The log contains indexes %lu through %lu (inclusive)&quot;</span>,
<a name="l01049"></a>01049            <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLogStartIndex(), <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex());
<a name="l01050"></a>01050 
<a name="l01051"></a>01051     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;metadata.has_current_term())
<a name="l01052"></a>01052         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a> = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;metadata.current_term();
<a name="l01053"></a>01053     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;metadata.has_voted_for())
<a name="l01054"></a>01054         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1add1a4497b990f9f4b053266459b59d" title="The server ID that this server voted for during this term&#39;s election, if any.">votedFor</a> = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;metadata.voted_for();
<a name="l01055"></a>01055     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97717592e5ac7db5c59591bd651deff8" title="Persist critical state, such as the term and the vote, to stable storage.">updateLogMetadata</a>();
<a name="l01056"></a>01056 
<a name="l01057"></a>01057     <span class="comment">// Read snapshot after reading log, since readSnapshot() will get rid of</span>
<a name="l01058"></a>01058     <span class="comment">// conflicting log entries</span>
<a name="l01059"></a>01059     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#adcbc3efddd798b87c1a659b2cf9ffd4c" title="Try to read the latest good snapshot from disk.">readSnapshot</a>();
<a name="l01060"></a>01060 
<a name="l01061"></a>01061     <span class="comment">// Clean up incomplete snapshots left by prior runs. This could be done</span>
<a name="l01062"></a>01062     <span class="comment">// earlier, but maybe it&#39;s nicer to make sure we can get to this point</span>
<a name="l01063"></a>01063     <span class="comment">// without PANICing before deleting these files.</span>
<a name="l01064"></a>01064     <a class="code" href="namespaceLogCabin_1_1Storage_1_1SnapshotFile.html#a2852e12ee900d5a5fc91c1410995cba5" title="Remove any partial snapshots found on disk.">Storage::SnapshotFile::discardPartialSnapshots</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a6bed133d4a5b6e69399b1dbc44f7f483" title="Where the files for the log and snapshots are stored.">storageLayout</a>);
<a name="l01065"></a>01065 
<a name="l01066"></a>01066     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;id == 0)
<a name="l01067"></a>01067         <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;No configuration, waiting to receive one.&quot;</span>);
<a name="l01068"></a>01068 
<a name="l01069"></a>01069     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a284075bb503d0b8efb9c217a257dadc5" title="Transition to being a follower.">stepDown</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l01070"></a>01070     <span class="keywordflow">if</span> (<a class="code" href="namespaceLogCabin_1_1Server_1_1RaftConsensusInternal.html#aa3a20ec5673f7f239631c204201a57e0" title="True if this should actually spawn threads, false otherwise.">RaftConsensusInternal::startThreads</a>) {
<a name="l01071"></a>01071         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a07ae9a16a699b6773c80175d0d3a003b" title="The thread that executes leaderDiskThreadMain() to flush log entries to stable storage in the backgro...">leaderDiskThread</a> = std::thread(
<a name="l01072"></a>01072             &amp;<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ab869a94f802cecc39c768a3425aac160" title="Flush log entries to stable storage in the background on leaders.">RaftConsensus::leaderDiskThreadMain</a>, <span class="keyword">this</span>);
<a name="l01073"></a>01073         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a502802fd49e11b01a4005f2cd794fc68" title="The thread that executes timerThreadMain() to begin new elections after periods of inactivity...">timerThread</a> = std::thread(
<a name="l01074"></a>01074             &amp;<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a0c3b92e4cd0c94b84b00c21c77dad0b6" title="Start new elections when it&#39;s time to do so.">RaftConsensus::timerThreadMain</a>, <span class="keyword">this</span>);
<a name="l01075"></a>01075         <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a18a8fc189422f6eb3f5f0497e4e102b1" title="The LogCabin daemon&#39;s top-level objects.">globals</a>.<a class="code" href="classLogCabin_1_1Server_1_1Globals.html#a0716780cdbc776d14d8e63f9b6cdce41" title="Global configuration options.">config</a>.<a class="code" href="classLogCabin_1_1Core_1_1Config.html#a9463413099189cc32b0f372621d92fba" title="Read the value corresponding to a key.">read</a>&lt;<span class="keywordtype">bool</span>&gt;(<span class="stringliteral">&quot;disableStateMachineUpdates&quot;</span>, <span class="keyword">false</span>)) {
<a name="l01076"></a>01076             <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Not starting state machine updater thread (state machine &quot;</span>
<a name="l01077"></a>01077                    <span class="stringliteral">&quot;updates are disabled in config)&quot;</span>);
<a name="l01078"></a>01078         } <span class="keywordflow">else</span> {
<a name="l01079"></a>01079             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1c438e3a3d2f82e759258ec0d0169819" title="The thread that executes stateMachineUpdaterThreadMain() to append advance state machine version entr...">stateMachineUpdaterThread</a> = std::thread(
<a name="l01080"></a>01080                 &amp;<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ade987b3689a8b49a9e08e749af69110a" title="Append advance state machine version entries to the log as leader once all servers can support a new ...">RaftConsensus::stateMachineUpdaterThreadMain</a>, <span class="keyword">this</span>);
<a name="l01081"></a>01081         }
<a name="l01082"></a>01082         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2fc61e8f83d7ea5520bb1a81c236dd28" title="The thread that executes stepDownThreadMain() to return to the follower state if the leader becomes d...">stepDownThread</a> = std::thread(
<a name="l01083"></a>01083             &amp;<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a20e9e7e7e4f6d13a219cf1044db92857" title="Return to follower state when, as leader, this server is not able to communicate with a quorum...">RaftConsensus::stepDownThreadMain</a>, <span class="keyword">this</span>);
<a name="l01084"></a>01084     }
<a name="l01085"></a>01085     <span class="comment">// log-&gt;path = &quot;&quot;; // hack to disable disk</span>
<a name="l01086"></a>01086     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#a66990e7e4f8fd459a7311ce86800e5e7">notify_all</a>();
<a name="l01087"></a>01087     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acfe558f9de36a467f22e24dbb07b38fd" title="Dumps serverId, currentTerm, state, leaderId, and votedFor to the debug log.">printElectionState</a>();
<a name="l01088"></a>01088 }
<a name="l01089"></a>01089 
<a name="l01090"></a>01090 <span class="keywordtype">void</span>
<a name="l01091"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5f315e9f0ad06d3b924fdadf04ecfd60">01091</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5f315e9f0ad06d3b924fdadf04ecfd60" title="Signal the consensus module to exit (shut down threads, etc).">RaftConsensus::exit</a>()
<a name="l01092"></a>01092 {
<a name="l01093"></a>01093     <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Shutting down&quot;</span>);
<a name="l01094"></a>01094     std::lock_guard&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l01095"></a>01095     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a7f8cdeb3a67e3398cca54f23eb5022a6" title="Set to true when this class is about to be destroyed.">exiting</a> = <span class="keyword">true</span>;
<a name="l01096"></a>01096     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>)
<a name="l01097"></a>01097         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;forEach(&amp;<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#ae4af8d452636e4d3fada9eb686416143" title="Inform any threads belonging to this Server to exit.">Server::exit</a>);
<a name="l01098"></a>01098     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae59f81b29757ea16583034c975e952cf" title="Notify the stateChanged condition variable and cancel all current RPCs.">interruptAll</a>();
<a name="l01099"></a>01099 }
<a name="l01100"></a>01100 
<a name="l01101"></a>01101 <span class="keywordtype">void</span>
<a name="l01102"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acedd2bcfd65fca7bb0a2d8fd484611ed">01102</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acedd2bcfd65fca7bb0a2d8fd484611ed" title="Initialize the log with a configuration consisting of just this server.">RaftConsensus::bootstrapConfiguration</a>()
<a name="l01103"></a>01103 {
<a name="l01104"></a>01104     std::lock_guard&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l01105"></a>01105 
<a name="l01106"></a>01106     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a> != 0 ||
<a name="l01107"></a>01107         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLogStartIndex() != 1 ||
<a name="l01108"></a>01108         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex() != 0 ||
<a name="l01109"></a>01109         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a> != 0) {
<a name="l01110"></a>01110         <a class="code" href="Core_2Debug_8h.html#ad84b0f521394f4d9214c9d185711a8c3" title="Log an ERROR message and abort the process.">PANIC</a>(<span class="stringliteral">&quot;Refusing to bootstrap configuration: it looks like a log or &quot;</span>
<a name="l01111"></a>01111               <span class="stringliteral">&quot;snapshot already exists.&quot;</span>);
<a name="l01112"></a>01112     }
<a name="l01113"></a>01113     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a284075bb503d0b8efb9c217a257dadc5" title="Transition to being a follower.">stepDown</a>(1); <span class="comment">// satisfies invariants assertions</span>
<a name="l01114"></a>01114 
<a name="l01115"></a>01115     <span class="comment">// Append the configuration entry to the log</span>
<a name="l01116"></a>01116     <a class="code" href="classLogCabin_1_1Storage_1_1Log.html#a8ca64ace5d6ae6f0175186c595d4fbe0" title="The type of a log entry (the same format that&#39;s used in AppendEntries).">Log::Entry</a> entry;
<a name="l01117"></a>01117     entry.set_term(1);
<a name="l01118"></a>01118     entry.set_type(Protocol::Raft::EntryType::CONFIGURATION);
<a name="l01119"></a>01119     entry.set_cluster_time(0);
<a name="l01120"></a>01120     <a class="code" href="namespaceLogCabin_1_1Client.html#a99e2b7ff4ee9b74bcf9dec83b6565fa2" title="Defines the members of the cluster.">Protocol::Raft::Configuration</a>&amp; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a> =
<a name="l01121"></a>01121         *entry.mutable_configuration();
<a name="l01122"></a>01122     Protocol::Raft::Server&amp; server =
<a name="l01123"></a>01123         *configuration.mutable_prev_configuration()-&gt;add_servers();
<a name="l01124"></a>01124     server.set_server_id(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a32b5b6a4d6ae35dcd20c8ba3e7a95de0" title="This server&#39;s unique ID.">serverId</a>);
<a name="l01125"></a>01125     server.set_addresses(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#af1238b47653a95c110dc9d526e006286" title="The addresses that this server is listening on.">serverAddresses</a>);
<a name="l01126"></a>01126     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aab0f5ebde52053a9de31a575093dc098" title="Append entries to the log, set the configuration if this contains a configuration entry...">append</a>({&amp;entry});
<a name="l01127"></a>01127 }
<a name="l01128"></a>01128 
<a name="l01129"></a>01129 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2e798f8f5febb02f25e027eccac8496a">RaftConsensus::ClientResult</a>
<a name="l01130"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2a1cf6a171ab0797bce1d5f1dbaf15a8">01130</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2a1cf6a171ab0797bce1d5f1dbaf15a8" title="Get the current leader&#39;s active, committed, simple cluster configuration.">RaftConsensus::getConfiguration</a>(
<a name="l01131"></a>01131         Protocol::Raft::SimpleConfiguration&amp; currentConfiguration,
<a name="l01132"></a>01132         uint64_t&amp; <span class="keywordtype">id</span>)<span class="keyword"> const</span>
<a name="l01133"></a>01133 <span class="keyword"></span>{
<a name="l01134"></a>01134     std::unique_lock&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l01135"></a>01135     <span class="keywordflow">if</span> (!<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a083099431c4dd8bdb9985027a7385861" title="Return true if every entry that might have already been marked committed on any leader is marked comm...">upToDateLeader</a>(lockGuard))
<a name="l01136"></a>01136         <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2e798f8f5febb02f25e027eccac8496aaf0c9dacaac36992bfc8db3368a4128c4" title="Cannot process the request because this server is not leader or temporarily lost its leadership...">ClientResult::NOT_LEADER</a>;
<a name="l01137"></a>01137     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;state != Configuration::State::STABLE ||
<a name="l01138"></a>01138         commitIndex &lt; configuration-&gt;<span class="keywordtype">id</span>) {
<a name="l01139"></a>01139         <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2e798f8f5febb02f25e027eccac8496aa4c64a47b177883a7ccd978b281b61a41" title="Returned by getConfiguration() if the configuration is not stable or is not committed.">ClientResult::RETRY</a>;
<a name="l01140"></a>01140     }
<a name="l01141"></a>01141     currentConfiguration = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;description.prev_configuration();
<a name="l01142"></a>01142     <span class="keywordtype">id</span> = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;id;
<a name="l01143"></a>01143     <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2e798f8f5febb02f25e027eccac8496aa0b5aa96f6ed35c5c9a026c47b2245850" title="Request completed successfully.">ClientResult::SUCCESS</a>;
<a name="l01144"></a>01144 }
<a name="l01145"></a>01145 
<a name="l01146"></a>01146 std::pair&lt;RaftConsensus::ClientResult, uint64_t&gt;
<a name="l01147"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a3fd3710f9e14f865ad1c9d67406804a5">01147</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a3fd3710f9e14f865ad1c9d67406804a5" title="Return the most recent entry ID that has been externalized by the replicated log.">RaftConsensus::getLastCommitIndex</a>()<span class="keyword"> const</span>
<a name="l01148"></a>01148 <span class="keyword"></span>{
<a name="l01149"></a>01149     std::unique_lock&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l01150"></a>01150     <span class="keywordflow">if</span> (!<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a083099431c4dd8bdb9985027a7385861" title="Return true if every entry that might have already been marked committed on any leader is marked comm...">upToDateLeader</a>(lockGuard))
<a name="l01151"></a>01151         <span class="keywordflow">return</span> {<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2e798f8f5febb02f25e027eccac8496aaf0c9dacaac36992bfc8db3368a4128c4" title="Cannot process the request because this server is not leader or temporarily lost its leadership...">ClientResult::NOT_LEADER</a>, 0};
<a name="l01152"></a>01152     <span class="keywordflow">else</span>
<a name="l01153"></a>01153         <span class="keywordflow">return</span> {<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2e798f8f5febb02f25e027eccac8496aa0b5aa96f6ed35c5c9a026c47b2245850" title="Request completed successfully.">ClientResult::SUCCESS</a>, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a>};
<a name="l01154"></a>01154 }
<a name="l01155"></a>01155 
<a name="l01156"></a>01156 std::string
<a name="l01157"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#af402997ae4970df1767305416748638c">01157</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#af402997ae4970df1767305416748638c" title="Return the network address for a recent leader, if known, or empty string otherwise.">RaftConsensus::getLeaderHint</a>()<span class="keyword"> const</span>
<a name="l01158"></a>01158 <span class="keyword"></span>{
<a name="l01159"></a>01159     std::lock_guard&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l01160"></a>01160     <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;lookupAddress(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae3f2b58c62af497eb474046566656f67" title="The server ID of the leader for this term.">leaderId</a>);
<a name="l01161"></a>01161 }
<a name="l01162"></a>01162 
<a name="l01163"></a>01163 <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html" title="This is returned by getNextEntry().">RaftConsensus::Entry</a>
<a name="l01164"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a3cb2290f2b2be4201ca8ee5a2d540d4f">01164</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a3cb2290f2b2be4201ca8ee5a2d540d4f" title="This returns the entry following lastIndex in the replicated log.">RaftConsensus::getNextEntry</a>(uint64_t lastIndex)<span class="keyword"> const</span>
<a name="l01165"></a>01165 <span class="keyword"></span>{
<a name="l01166"></a>01166     std::unique_lock&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l01167"></a>01167     uint64_t nextIndex = lastIndex + 1;
<a name="l01168"></a>01168     <span class="keywordflow">while</span> (<span class="keyword">true</span>) {
<a name="l01169"></a>01169         <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a7f8cdeb3a67e3398cca54f23eb5022a6" title="Set to true when this class is about to be destroyed.">exiting</a>)
<a name="l01170"></a>01170             <span class="keywordflow">throw</span> <a class="code" href="classLogCabin_1_1Core_1_1Util_1_1ThreadInterruptedException.html" title="The thread could not complete its task because it was asked to exit.">Core::Util::ThreadInterruptedException</a>();
<a name="l01171"></a>01171         <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a> &gt;= nextIndex) {
<a name="l01172"></a>01172             <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html" title="This is returned by getNextEntry().">RaftConsensus::Entry</a> entry;
<a name="l01173"></a>01173 
<a name="l01174"></a>01174             <span class="comment">// Make the state machine load a snapshot if we don&#39;t have the next</span>
<a name="l01175"></a>01175             <span class="comment">// entry it needs in the log.</span>
<a name="l01176"></a>01176             <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLogStartIndex() &gt; nextIndex) {
<a name="l01177"></a>01177                 entry.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html#aaa3b16ae53c6a8f26e66efcc3ef84268" title="The type of the entry.">type</a> = <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html#a0b88eeaf00022ad116d9bb1499af28eba48a20fbc01b3a7809320e783554a6df1" title="This is a snapshot: the state machine should clear its state and load in the snapshot.">Entry::SNAPSHOT</a>;
<a name="l01178"></a>01178                 <span class="comment">// For well-behaved state machines, we expect &#39;snapshotReader&#39;</span>
<a name="l01179"></a>01179                 <span class="comment">// to contain a SnapshotFile::Reader that we can return</span>
<a name="l01180"></a>01180                 <span class="comment">// directly to the state machine. In the case that a State</span>
<a name="l01181"></a>01181                 <span class="comment">// Machine asks for the snapshot again, we have to build a new</span>
<a name="l01182"></a>01182                 <span class="comment">// SnapshotFile::Reader again.</span>
<a name="l01183"></a>01183                 entry.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html#a68cc06a068151ed0bb237fe3f0f3cd72" title="A handle to the snapshot file for entries of type &#39;SNAPSHOT&#39;.">snapshotReader</a> = std::move(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a66df54dcef389e690e4e94df391f8120" title="If not NULL, this is a Storage::SnapshotFile::Reader that covers up through lastSnapshotIndex.">snapshotReader</a>);
<a name="l01184"></a>01184                 <span class="keywordflow">if</span> (!entry.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html#a68cc06a068151ed0bb237fe3f0f3cd72" title="A handle to the snapshot file for entries of type &#39;SNAPSHOT&#39;.">snapshotReader</a>) {
<a name="l01185"></a>01185                     <a class="code" href="Core_2Debug_8h.html#ad51176fec84ca79bd96163c9cb5a7c32" title="Log a WARNING message.">WARNING</a>(<span class="stringliteral">&quot;State machine asked for same snapshot twice; &quot;</span>
<a name="l01186"></a>01186                             <span class="stringliteral">&quot;this shouldn&#39;t happen in normal operation. &quot;</span>
<a name="l01187"></a>01187                             <span class="stringliteral">&quot;Having to re-read it from disk.&quot;</span>);
<a name="l01188"></a>01188                     <span class="comment">// readSnapshot() shouldn&#39;t have any side effects since the</span>
<a name="l01189"></a>01189                     <span class="comment">// snapshot should have already been read, so const_cast</span>
<a name="l01190"></a>01190                     <span class="comment">// should be ok (though ugly).</span>
<a name="l01191"></a>01191                     <span class="keyword">const_cast&lt;</span><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html" title="An implementation of the Raft consensus algorithm.">RaftConsensus</a>*<span class="keyword">&gt;</span>(<span class="keyword">this</span>)-&gt;<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#adcbc3efddd798b87c1a659b2cf9ffd4c" title="Try to read the latest good snapshot from disk.">readSnapshot</a>();
<a name="l01192"></a>01192                     entry.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html#a68cc06a068151ed0bb237fe3f0f3cd72" title="A handle to the snapshot file for entries of type &#39;SNAPSHOT&#39;.">snapshotReader</a> = std::move(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a66df54dcef389e690e4e94df391f8120" title="If not NULL, this is a Storage::SnapshotFile::Reader that covers up through lastSnapshotIndex.">snapshotReader</a>);
<a name="l01193"></a>01193                 }
<a name="l01194"></a>01194                 entry.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html#ae53c9259efad84029cd9c7b0b25288bd" title="The Raft log index for this entry (or the last one a snapshot covers).">index</a> = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>;
<a name="l01195"></a>01195                 entry.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html#a1dc22a9bfc4b758902aea89996e37090" title="Cluster time when leader created entry/snapshot.">clusterTime</a> = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#af98e037190d928bbe2ecda31a19ca7c2" title="The cluster time of the last entry covered by the latest good snapshot, or 0 if we have no snapshot...">lastSnapshotClusterTime</a>;
<a name="l01196"></a>01196             } <span class="keywordflow">else</span> {
<a name="l01197"></a>01197                 <span class="comment">// not a snapshot</span>
<a name="l01198"></a>01198                 <span class="keyword">const</span> <a class="code" href="classLogCabin_1_1Storage_1_1Log.html#a8ca64ace5d6ae6f0175186c595d4fbe0" title="The type of a log entry (the same format that&#39;s used in AppendEntries).">Log::Entry</a>&amp; logEntry = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getEntry(nextIndex);
<a name="l01199"></a>01199                 entry.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html#ae53c9259efad84029cd9c7b0b25288bd" title="The Raft log index for this entry (or the last one a snapshot covers).">index</a> = nextIndex;
<a name="l01200"></a>01200                 <span class="keywordflow">if</span> (logEntry.type() == Protocol::Raft::EntryType::DATA) {
<a name="l01201"></a>01201                     entry.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html#aaa3b16ae53c6a8f26e66efcc3ef84268" title="The type of the entry.">type</a> = <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html#a0b88eeaf00022ad116d9bb1499af28ebac9e0e10f40c459c4753efe71350e7c3e" title="This is a normal entry containing a client request for the state machine.">Entry::DATA</a>;
<a name="l01202"></a>01202                     <span class="keyword">const</span> std::string&amp; s = logEntry.data();
<a name="l01203"></a>01203                     entry.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html#a6beee9dcbc83466591acb844a12eec0b" title="The client request for entries of type &#39;DATA&#39;.">command</a> = <a class="code" href="classLogCabin_1_1Core_1_1Buffer.html" title="A container for opaque data.">Core::Buffer</a>(
<a name="l01204"></a>01204                         <a class="code" href="namespaceLogCabin_1_1Core_1_1Util.html#a6577de108423cf4d2ebfed2d7a60ad65" title="Copy some noncontiguous chunks of data into a contiguous chunk.">memcpy</a>(<span class="keyword">new</span> <span class="keywordtype">char</span>[s.length()], s.data(), s.length()),
<a name="l01205"></a>01205                         s.length(),
<a name="l01206"></a>01206                         Core::Buffer::deleteArrayFn&lt;char&gt;);
<a name="l01207"></a>01207                 } <span class="keywordflow">else</span> {
<a name="l01208"></a>01208                     entry.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html#aaa3b16ae53c6a8f26e66efcc3ef84268" title="The type of the entry.">type</a> = <a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html#a0b88eeaf00022ad116d9bb1499af28ebafab95348af62aca672706442a920bd9d" title="Some entries should be ignored by the state machine (they are consumed internally by the consensus mo...">Entry::SKIP</a>;
<a name="l01209"></a>01209                 }
<a name="l01210"></a>01210                 entry.<a class="code" href="structLogCabin_1_1Server_1_1RaftConsensus_1_1Entry.html#a1dc22a9bfc4b758902aea89996e37090" title="Cluster time when leader created entry/snapshot.">clusterTime</a> = logEntry.cluster_time();
<a name="l01211"></a>01211             }
<a name="l01212"></a>01212             <span class="keywordflow">return</span> entry;
<a name="l01213"></a>01213         }
<a name="l01214"></a>01214         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#aedc8162c9f0251ae3491e6bc6efbe477">wait</a>(lockGuard);
<a name="l01215"></a>01215     }
<a name="l01216"></a>01216 }
<a name="l01217"></a>01217 
<a name="l01218"></a>01218 SnapshotStats::SnapshotStats
<a name="l01219"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a777719f802ef0e36eba303205f8e995f">01219</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a777719f802ef0e36eba303205f8e995f" title="Return statistics that may be useful in deciding when to snapshot.">RaftConsensus::getSnapshotStats</a>()<span class="keyword"> const</span>
<a name="l01220"></a>01220 <span class="keyword"></span>{
<a name="l01221"></a>01221     std::lock_guard&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l01222"></a>01222 
<a name="l01223"></a>01223     SnapshotStats::SnapshotStats s;
<a name="l01224"></a>01224     s.set_last_snapshot_index(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>);
<a name="l01225"></a>01225     s.set_last_snapshot_bytes(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a3f14561ea354f31be363ab7f008b9961" title="The size of the latest good snapshot in bytes, or 0 if we have no snapshot.">lastSnapshotBytes</a>);
<a name="l01226"></a>01226     s.set_log_start_index(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLogStartIndex());
<a name="l01227"></a>01227     s.set_last_log_index(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex());
<a name="l01228"></a>01228     s.set_log_bytes(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getSizeBytes());
<a name="l01229"></a>01229     s.set_is_leader(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> == State::LEADER);
<a name="l01230"></a>01230     <span class="keywordflow">return</span> s;
<a name="l01231"></a>01231 }
<a name="l01232"></a>01232 
<a name="l01233"></a>01233 <span class="keywordtype">void</span>
<a name="l01234"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a76540f417603b0c4b22bb87267e1f27d">01234</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a76540f417603b0c4b22bb87267e1f27d" title="Process an AppendEntries RPC from another server.">RaftConsensus::handleAppendEntries</a>(
<a name="l01235"></a>01235                     <span class="keyword">const</span> Protocol::Raft::AppendEntries::Request&amp; request,
<a name="l01236"></a>01236                     Protocol::Raft::AppendEntries::Response&amp; response)
<a name="l01237"></a>01237 {
<a name="l01238"></a>01238     std::lock_guard&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l01239"></a>01239     assert(!<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a7f8cdeb3a67e3398cca54f23eb5022a6" title="Set to true when this class is about to be destroyed.">exiting</a>);
<a name="l01240"></a>01240 
<a name="l01241"></a>01241     <span class="comment">// Set response to a rejection. We&#39;ll overwrite these later if we end up</span>
<a name="l01242"></a>01242     <span class="comment">// accepting the request.</span>
<a name="l01243"></a>01243     response.set_term(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l01244"></a>01244     response.set_success(<span class="keyword">false</span>);
<a name="l01245"></a>01245     response.set_last_log_index(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex());
<a name="l01246"></a>01246 
<a name="l01247"></a>01247     <span class="comment">// Piggy-back server capabilities.</span>
<a name="l01248"></a>01248     {
<a name="l01249"></a>01249         <span class="keyword">auto</span>&amp; cap = *response.mutable_server_capabilities();
<a name="l01250"></a>01250         <span class="keyword">auto</span>&amp; s = *<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;localServer;
<a name="l01251"></a>01251         <span class="keywordflow">if</span> (s.haveStateMachineSupportedVersions) {
<a name="l01252"></a>01252             cap.set_min_supported_state_machine_version(
<a name="l01253"></a>01253                     s.minStateMachineVersion);
<a name="l01254"></a>01254             cap.set_max_supported_state_machine_version(
<a name="l01255"></a>01255                     s.maxStateMachineVersion);
<a name="l01256"></a>01256         }
<a name="l01257"></a>01257     }
<a name="l01258"></a>01258 
<a name="l01259"></a>01259     <span class="comment">// If the caller&#39;s term is stale, just return our term to it.</span>
<a name="l01260"></a>01260     <span class="keywordflow">if</span> (request.term() &lt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>) {
<a name="l01261"></a>01261         <a class="code" href="Core_2Debug_8h.html#a77e5c931f41ca7e1792ddfa762d38473" title="Log a VERBOSE message.">VERBOSE</a>(<span class="stringliteral">&quot;Caller(%lu) is stale. Our term is %lu, theirs is %lu&quot;</span>,
<a name="l01262"></a>01262                  request.server_id(), <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>, request.term());
<a name="l01263"></a>01263         <span class="keywordflow">return</span>; <span class="comment">// response was set to a rejection above</span>
<a name="l01264"></a>01264     }
<a name="l01265"></a>01265     <span class="keywordflow">if</span> (request.term() &gt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>) {
<a name="l01266"></a>01266         <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Received AppendEntries request from server %lu in term %lu &quot;</span>
<a name="l01267"></a>01267                <span class="stringliteral">&quot;(this server&#39;s term was %lu)&quot;</span>,
<a name="l01268"></a>01268                 request.server_id(), request.term(), <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l01269"></a>01269         <span class="comment">// We&#39;re about to bump our term in the stepDown below: update</span>
<a name="l01270"></a>01270         <span class="comment">// &#39;response&#39; accordingly.</span>
<a name="l01271"></a>01271         response.set_term(request.term());
<a name="l01272"></a>01272     }
<a name="l01273"></a>01273     <span class="comment">// This request is a sign of life from the current leader. Update our term</span>
<a name="l01274"></a>01274     <span class="comment">// and convert to follower if necessary; reset the election timer.</span>
<a name="l01275"></a>01275     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a284075bb503d0b8efb9c217a257dadc5" title="Transition to being a follower.">stepDown</a>(request.term());
<a name="l01276"></a>01276     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ac307cba21a66a55c0edc29d6e094ec7a" title="Set the timer to start a new election and notify stateChanged.">setElectionTimer</a>();
<a name="l01277"></a>01277     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a075b1f3174db6673435f31622c231d02" title="The earliest time at which RequestVote messages should be processed.">withholdVotesUntil</a> = <a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a13f545c6020dd190e13d21e2577cc59b">Clock::now</a>() +
<a name="l01278"></a>01278                          std::chrono::milliseconds(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5a76d9fce7cc8e8bd69bcf059b89ad93" title="A follower waits for about this much inactivity before becoming a candidate and starting a new electi...">ELECTION_TIMEOUT_MS</a>);
<a name="l01279"></a>01279 
<a name="l01280"></a>01280     <span class="comment">// Record the leader ID as a hint for clients.</span>
<a name="l01281"></a>01281     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae3f2b58c62af497eb474046566656f67" title="The server ID of the leader for this term.">leaderId</a> == 0) {
<a name="l01282"></a>01282         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae3f2b58c62af497eb474046566656f67" title="The server ID of the leader for this term.">leaderId</a> = request.server_id();
<a name="l01283"></a>01283         <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;All hail leader %lu for term %lu&quot;</span>, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae3f2b58c62af497eb474046566656f67" title="The server ID of the leader for this term.">leaderId</a>, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l01284"></a>01284         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acfe558f9de36a467f22e24dbb07b38fd" title="Dumps serverId, currentTerm, state, leaderId, and votedFor to the debug log.">printElectionState</a>();
<a name="l01285"></a>01285     } <span class="keywordflow">else</span> {
<a name="l01286"></a>01286         assert(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae3f2b58c62af497eb474046566656f67" title="The server ID of the leader for this term.">leaderId</a> == request.server_id());
<a name="l01287"></a>01287     }
<a name="l01288"></a>01288 
<a name="l01289"></a>01289     <span class="comment">// For an entry to fit into our log, it must not leave a gap.</span>
<a name="l01290"></a>01290     <span class="keywordflow">if</span> (request.prev_log_index() &gt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex()) {
<a name="l01291"></a>01291         <a class="code" href="Core_2Debug_8h.html#a77e5c931f41ca7e1792ddfa762d38473" title="Log a VERBOSE message.">VERBOSE</a>(<span class="stringliteral">&quot;Rejecting AppendEntries RPC: would leave gap&quot;</span>);
<a name="l01292"></a>01292         <span class="keywordflow">return</span>; <span class="comment">// response was set to a rejection above</span>
<a name="l01293"></a>01293     }
<a name="l01294"></a>01294     <span class="comment">// It must also agree with the previous entry in the log (and, inductively</span>
<a name="l01295"></a>01295     <span class="comment">// all prior entries).</span>
<a name="l01296"></a>01296     <span class="comment">// Always match on index 0, and always match on any discarded indexes:</span>
<a name="l01297"></a>01297     <span class="comment">// since we know those were committed, the leader must agree with them.</span>
<a name="l01298"></a>01298     <span class="comment">// We could truncate the log here, but there&#39;s no real advantage to doing</span>
<a name="l01299"></a>01299     <span class="comment">// that.</span>
<a name="l01300"></a>01300     <span class="keywordflow">if</span> (request.prev_log_index() &gt;= <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLogStartIndex() &amp;&amp;
<a name="l01301"></a>01301         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getEntry(request.prev_log_index()).term() !=
<a name="l01302"></a>01302             request.prev_log_term()) {
<a name="l01303"></a>01303         <a class="code" href="Core_2Debug_8h.html#a77e5c931f41ca7e1792ddfa762d38473" title="Log a VERBOSE message.">VERBOSE</a>(<span class="stringliteral">&quot;Rejecting AppendEntries RPC: terms don&#39;t agree&quot;</span>);
<a name="l01304"></a>01304         <span class="keywordflow">return</span>; <span class="comment">// response was set to a rejection above</span>
<a name="l01305"></a>01305     }
<a name="l01306"></a>01306 
<a name="l01307"></a>01307     <span class="comment">// If we got this far, we&#39;re accepting the request.</span>
<a name="l01308"></a>01308     response.set_success(<span class="keyword">true</span>);
<a name="l01309"></a>01309 
<a name="l01310"></a>01310     <span class="comment">// This needs to be able to handle duplicated RPC requests. We compare the</span>
<a name="l01311"></a>01311     <span class="comment">// entries&#39; terms to know if we need to do the operation; otherwise,</span>
<a name="l01312"></a>01312     <span class="comment">// reapplying requests can result in data loss.</span>
<a name="l01313"></a>01313     <span class="comment">//</span>
<a name="l01314"></a>01314     <span class="comment">// The first problem this solves is that an old AppendEntries request may be</span>
<a name="l01315"></a>01315     <span class="comment">// duplicated and received after a newer request, which could cause</span>
<a name="l01316"></a>01316     <span class="comment">// undesirable data loss. For example, suppose the leader appends entry 4</span>
<a name="l01317"></a>01317     <span class="comment">// and then entry 5, but the follower receives 4, then 5, then 4 again.</span>
<a name="l01318"></a>01318     <span class="comment">// Without this extra guard, the follower would truncate 5 out of its</span>
<a name="l01319"></a>01319     <span class="comment">// log.</span>
<a name="l01320"></a>01320     <span class="comment">//</span>
<a name="l01321"></a>01321     <span class="comment">// The second problem is more subtle: if the same request is duplicated but</span>
<a name="l01322"></a>01322     <span class="comment">// the leader processes an earlier response, it will assume the</span>
<a name="l01323"></a>01323     <span class="comment">// acknowledged data is safe. However, there is a window of vulnerability</span>
<a name="l01324"></a>01324     <span class="comment">// on the follower&#39;s disk between the truncate and append operations (which</span>
<a name="l01325"></a>01325     <span class="comment">// are not done atomically) when the follower processes the later request.</span>
<a name="l01326"></a>01326     uint64_t index = request.prev_log_index();
<a name="l01327"></a>01327     <span class="keywordflow">for</span> (<span class="keyword">auto</span> it = request.entries().begin();
<a name="l01328"></a>01328          it != request.entries().end();
<a name="l01329"></a>01329          ++it) {
<a name="l01330"></a>01330         ++index;
<a name="l01331"></a>01331         <span class="keyword">const</span> Protocol::Raft::Entry&amp; entry = *it;
<a name="l01332"></a>01332         <span class="keywordflow">if</span> (entry.has_index()) {
<a name="l01333"></a>01333             <span class="comment">// This precaution was added after #160: &quot;Packing entries into</span>
<a name="l01334"></a>01334             <span class="comment">// AppendEntries requests is broken (critical)&quot;.</span>
<a name="l01335"></a>01335             assert(entry.index() == index);
<a name="l01336"></a>01336         }
<a name="l01337"></a>01337         <span class="keywordflow">if</span> (index &lt; log-&gt;getLogStartIndex()) {
<a name="l01338"></a>01338             <span class="comment">// We already snapshotted and discarded this index, so presumably</span>
<a name="l01339"></a>01339             <span class="comment">// we&#39;ve received a committed entry we once already had.</span>
<a name="l01340"></a>01340             <span class="keywordflow">continue</span>;
<a name="l01341"></a>01341         }
<a name="l01342"></a>01342         <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex() &gt;= index) {
<a name="l01343"></a>01343             <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getEntry(index).term() == entry.term())
<a name="l01344"></a>01344                 <span class="keywordflow">continue</span>;
<a name="l01345"></a>01345             <span class="comment">// should never truncate committed entries:</span>
<a name="l01346"></a>01346             assert(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a> &lt; index);
<a name="l01347"></a>01347             uint64_t lastIndexKept = index - 1;
<a name="l01348"></a>01348             uint64_t numTruncating = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex() - lastIndexKept;
<a name="l01349"></a>01349             <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Truncating %lu entries after %lu from the log&quot;</span>,
<a name="l01350"></a>01350                    numTruncating,
<a name="l01351"></a>01351                    lastIndexKept);
<a name="l01352"></a>01352             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a651ad565303b12e3ab72a38429349d23" title="The total number of entries ever truncated from the end of the log.">numEntriesTruncated</a> += numTruncating;
<a name="l01353"></a>01353             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;truncateSuffix(lastIndexKept);
<a name="l01354"></a>01354             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ade5bbdec3e8ff60b7931a2682b2bb4ef" title="Ensures that &#39;configuration&#39; reflects the latest state of the log and snapshot.">configurationManager</a>-&gt;truncateSuffix(lastIndexKept);
<a name="l01355"></a>01355         }
<a name="l01356"></a>01356 
<a name="l01357"></a>01357         <span class="comment">// Append this and all following entries.</span>
<a name="l01358"></a>01358         std::vector&lt;const Protocol::Raft::Entry*&gt; entries;
<a name="l01359"></a>01359         <span class="keywordflow">do</span> {
<a name="l01360"></a>01360             <span class="keyword">const</span> Protocol::Raft::Entry&amp; entry = *it;
<a name="l01361"></a>01361             <span class="keywordflow">if</span> (entry.type() == Protocol::Raft::EntryType::UNKNOWN) {
<a name="l01362"></a>01362                 <a class="code" href="Core_2Debug_8h.html#ad84b0f521394f4d9214c9d185711a8c3" title="Log an ERROR message and abort the process.">PANIC</a>(<span class="stringliteral">&quot;Leader %lu is trying to send us an unknown log entry &quot;</span>
<a name="l01363"></a>01363                       <span class="stringliteral">&quot;type for index %lu (term %lu). It shouldn&#39;t do that, &quot;</span>
<a name="l01364"></a>01364                       <span class="stringliteral">&quot;and there&#39;s not a good way forward. There&#39;s some hope &quot;</span>
<a name="l01365"></a>01365                       <span class="stringliteral">&quot;that if this server reboots, it&#39;ll come back up with a &quot;</span>
<a name="l01366"></a>01366                       <span class="stringliteral">&quot;newer version of the code that understands the entry.&quot;</span>,
<a name="l01367"></a>01367                       index,
<a name="l01368"></a>01368                       entry.term(),
<a name="l01369"></a>01369                       <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae3f2b58c62af497eb474046566656f67" title="The server ID of the leader for this term.">leaderId</a>);
<a name="l01370"></a>01370             }
<a name="l01371"></a>01371             entries.push_back(&amp;entry);
<a name="l01372"></a>01372             ++it;
<a name="l01373"></a>01373             ++index;
<a name="l01374"></a>01374         } <span class="keywordflow">while</span> (it != request.entries().end());
<a name="l01375"></a>01375         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aab0f5ebde52053a9de31a575093dc098" title="Append entries to the log, set the configuration if this contains a configuration entry...">append</a>(entries);
<a name="l01376"></a>01376         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aa525cfc8dac0abdc8f744f5bd75302ae" title="Tracks the passage of &quot;cluster time&quot;.">clusterClock</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#ad5adb9f0618aeb7a7a55e1524849a8bc" title="Reset to the given cluster time, assuming it&#39;s the current time right now.">newEpoch</a>(entries.back()-&gt;cluster_time());
<a name="l01377"></a>01377         <span class="keywordflow">break</span>;
<a name="l01378"></a>01378     }
<a name="l01379"></a>01379     response.set_last_log_index(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex());
<a name="l01380"></a>01380 
<a name="l01381"></a>01381     <span class="comment">// Set our committed ID from the request&#39;s. In rare cases, this would make</span>
<a name="l01382"></a>01382     <span class="comment">// our committed ID decrease. For example, this could happen with a new</span>
<a name="l01383"></a>01383     <span class="comment">// leader who has not yet replicated one of its own entries. While that&#39;d</span>
<a name="l01384"></a>01384     <span class="comment">// be perfectly safe, guarding against it with an if statement lets us</span>
<a name="l01385"></a>01385     <span class="comment">// make stronger assertions.</span>
<a name="l01386"></a>01386     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a> &lt; request.commit_index()) {
<a name="l01387"></a>01387         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a> = request.commit_index();
<a name="l01388"></a>01388         assert(commitIndex &lt;= log-&gt;getLastLogIndex());
<a name="l01389"></a>01389         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#a66990e7e4f8fd459a7311ce86800e5e7">notify_all</a>();
<a name="l01390"></a>01390         <a class="code" href="Core_2Debug_8h.html#a77e5c931f41ca7e1792ddfa762d38473" title="Log a VERBOSE message.">VERBOSE</a>(<span class="stringliteral">&quot;New commitIndex: %lu&quot;</span>, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a>);
<a name="l01391"></a>01391     }
<a name="l01392"></a>01392 }
<a name="l01393"></a>01393 
<a name="l01394"></a>01394 <span class="keywordtype">void</span>
<a name="l01395"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afe0ad94e4670e8128de667c1d35d2ae2">01395</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afe0ad94e4670e8128de667c1d35d2ae2" title="Process an InstallSnapshot RPC from another server.">RaftConsensus::handleInstallSnapshot</a>(
<a name="l01396"></a>01396         <span class="keyword">const</span> Protocol::Raft::InstallSnapshot::Request&amp; request,
<a name="l01397"></a>01397         Protocol::Raft::InstallSnapshot::Response&amp; response)
<a name="l01398"></a>01398 {
<a name="l01399"></a>01399     std::lock_guard&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l01400"></a>01400     assert(!<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a7f8cdeb3a67e3398cca54f23eb5022a6" title="Set to true when this class is about to be destroyed.">exiting</a>);
<a name="l01401"></a>01401 
<a name="l01402"></a>01402     response.set_term(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l01403"></a>01403 
<a name="l01404"></a>01404     <span class="comment">// If the caller&#39;s term is stale, just return our term to it.</span>
<a name="l01405"></a>01405     <span class="keywordflow">if</span> (request.term() &lt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>) {
<a name="l01406"></a>01406         <a class="code" href="Core_2Debug_8h.html#a77e5c931f41ca7e1792ddfa762d38473" title="Log a VERBOSE message.">VERBOSE</a>(<span class="stringliteral">&quot;Caller(%lu) is stale. Our term is %lu, theirs is %lu&quot;</span>,
<a name="l01407"></a>01407                  request.server_id(), <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>, request.term());
<a name="l01408"></a>01408         <span class="keywordflow">return</span>;
<a name="l01409"></a>01409     }
<a name="l01410"></a>01410     <span class="keywordflow">if</span> (request.term() &gt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>) {
<a name="l01411"></a>01411         <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Received InstallSnapshot request from server %lu in &quot;</span>
<a name="l01412"></a>01412                <span class="stringliteral">&quot;term %lu (this server&#39;s term was %lu)&quot;</span>,
<a name="l01413"></a>01413                 request.server_id(), request.term(), <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l01414"></a>01414         <span class="comment">// We&#39;re about to bump our term in the stepDown below: update</span>
<a name="l01415"></a>01415         <span class="comment">// &#39;response&#39; accordingly.</span>
<a name="l01416"></a>01416         response.set_term(request.term());
<a name="l01417"></a>01417     }
<a name="l01418"></a>01418     <span class="comment">// This request is a sign of life from the current leader. Update our term</span>
<a name="l01419"></a>01419     <span class="comment">// and convert to follower if necessary; reset the election timer.</span>
<a name="l01420"></a>01420     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a284075bb503d0b8efb9c217a257dadc5" title="Transition to being a follower.">stepDown</a>(request.term());
<a name="l01421"></a>01421     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ac307cba21a66a55c0edc29d6e094ec7a" title="Set the timer to start a new election and notify stateChanged.">setElectionTimer</a>();
<a name="l01422"></a>01422     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a075b1f3174db6673435f31622c231d02" title="The earliest time at which RequestVote messages should be processed.">withholdVotesUntil</a> = <a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a13f545c6020dd190e13d21e2577cc59b">Clock::now</a>() +
<a name="l01423"></a>01423                          std::chrono::milliseconds(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5a76d9fce7cc8e8bd69bcf059b89ad93" title="A follower waits for about this much inactivity before becoming a candidate and starting a new electi...">ELECTION_TIMEOUT_MS</a>);
<a name="l01424"></a>01424 
<a name="l01425"></a>01425     <span class="comment">// Record the leader ID as a hint for clients.</span>
<a name="l01426"></a>01426     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae3f2b58c62af497eb474046566656f67" title="The server ID of the leader for this term.">leaderId</a> == 0) {
<a name="l01427"></a>01427         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae3f2b58c62af497eb474046566656f67" title="The server ID of the leader for this term.">leaderId</a> = request.server_id();
<a name="l01428"></a>01428         <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;All hail leader %lu for term %lu&quot;</span>, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae3f2b58c62af497eb474046566656f67" title="The server ID of the leader for this term.">leaderId</a>, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l01429"></a>01429         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acfe558f9de36a467f22e24dbb07b38fd" title="Dumps serverId, currentTerm, state, leaderId, and votedFor to the debug log.">printElectionState</a>();
<a name="l01430"></a>01430     } <span class="keywordflow">else</span> {
<a name="l01431"></a>01431         assert(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae3f2b58c62af497eb474046566656f67" title="The server ID of the leader for this term.">leaderId</a> == request.server_id());
<a name="l01432"></a>01432     }
<a name="l01433"></a>01433 
<a name="l01434"></a>01434     <span class="keywordflow">if</span> (!<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a750be73694a5e22bffc9c62f61cbb779" title="This is used in handleInstallSnapshot when receiving a snapshot from the current leader.">snapshotWriter</a>) {
<a name="l01435"></a>01435         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a750be73694a5e22bffc9c62f61cbb779" title="This is used in handleInstallSnapshot when receiving a snapshot from the current leader.">snapshotWriter</a>.reset(
<a name="l01436"></a>01436             <span class="keyword">new</span> <a class="code" href="classLogCabin_1_1Storage_1_1SnapshotFile_1_1Writer.html" title="Assists in writing snapshot files to the local filesystem.">Storage::SnapshotFile::Writer</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a6bed133d4a5b6e69399b1dbc44f7f483" title="Where the files for the log and snapshots are stored.">storageLayout</a>));
<a name="l01437"></a>01437     }
<a name="l01438"></a>01438     <span class="keywordflow">if</span> (request.byte_offset() &lt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a750be73694a5e22bffc9c62f61cbb779" title="This is used in handleInstallSnapshot when receiving a snapshot from the current leader.">snapshotWriter</a>-&gt;getBytesWritten()) {
<a name="l01439"></a>01439         <a class="code" href="Core_2Debug_8h.html#ad51176fec84ca79bd96163c9cb5a7c32" title="Log a WARNING message.">WARNING</a>(<span class="stringliteral">&quot;Ignoring stale snapshot chunk for byte offset %lu when the &quot;</span>
<a name="l01440"></a>01440                 <span class="stringliteral">&quot;next byte needed is %lu&quot;</span>,
<a name="l01441"></a>01441                 request.byte_offset(),
<a name="l01442"></a>01442                 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a750be73694a5e22bffc9c62f61cbb779" title="This is used in handleInstallSnapshot when receiving a snapshot from the current leader.">snapshotWriter</a>-&gt;getBytesWritten());
<a name="l01443"></a>01443         <span class="keywordflow">return</span>;
<a name="l01444"></a>01444     }
<a name="l01445"></a>01445     <span class="keywordflow">if</span> (request.byte_offset() &gt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a750be73694a5e22bffc9c62f61cbb779" title="This is used in handleInstallSnapshot when receiving a snapshot from the current leader.">snapshotWriter</a>-&gt;getBytesWritten()) {
<a name="l01446"></a>01446         <a class="code" href="Core_2Debug_8h.html#ad84b0f521394f4d9214c9d185711a8c3" title="Log an ERROR message and abort the process.">PANIC</a>(<span class="stringliteral">&quot;Leader tried to send snapshot chunk at byte offset %lu but the &quot;</span>
<a name="l01447"></a>01447               <span class="stringliteral">&quot;next byte needed is %lu. It&#39;s supposed to send these in order.&quot;</span>,
<a name="l01448"></a>01448               request.byte_offset(),
<a name="l01449"></a>01449               <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a750be73694a5e22bffc9c62f61cbb779" title="This is used in handleInstallSnapshot when receiving a snapshot from the current leader.">snapshotWriter</a>-&gt;getBytesWritten());
<a name="l01450"></a>01450     }
<a name="l01451"></a>01451     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a750be73694a5e22bffc9c62f61cbb779" title="This is used in handleInstallSnapshot when receiving a snapshot from the current leader.">snapshotWriter</a>-&gt;writeRaw(request.data().data(), request.data().length());
<a name="l01452"></a>01452 
<a name="l01453"></a>01453     <span class="keywordflow">if</span> (request.done()) {
<a name="l01454"></a>01454         <span class="keywordflow">if</span> (request.last_snapshot_index() &lt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>) {
<a name="l01455"></a>01455             <a class="code" href="Core_2Debug_8h.html#ad51176fec84ca79bd96163c9cb5a7c32" title="Log a WARNING message.">WARNING</a>(<span class="stringliteral">&quot;The leader sent us a snapshot, but it&#39;s stale: it only &quot;</span>
<a name="l01456"></a>01456                     <span class="stringliteral">&quot;covers up through index %lu and we already have one &quot;</span>
<a name="l01457"></a>01457                     <span class="stringliteral">&quot;through %lu. A well-behaved leader shouldn&#39;t do that. &quot;</span>
<a name="l01458"></a>01458                     <span class="stringliteral">&quot;Discarding the snapshot.&quot;</span>,
<a name="l01459"></a>01459                     request.last_snapshot_index(),
<a name="l01460"></a>01460                     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>);
<a name="l01461"></a>01461             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a750be73694a5e22bffc9c62f61cbb779" title="This is used in handleInstallSnapshot when receiving a snapshot from the current leader.">snapshotWriter</a>-&gt;discard();
<a name="l01462"></a>01462             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a750be73694a5e22bffc9c62f61cbb779" title="This is used in handleInstallSnapshot when receiving a snapshot from the current leader.">snapshotWriter</a>.reset();
<a name="l01463"></a>01463             <span class="keywordflow">return</span>;
<a name="l01464"></a>01464         }
<a name="l01465"></a>01465         <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Loading in new snapshot from leader&quot;</span>);
<a name="l01466"></a>01466         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a750be73694a5e22bffc9c62f61cbb779" title="This is used in handleInstallSnapshot when receiving a snapshot from the current leader.">snapshotWriter</a>-&gt;save();
<a name="l01467"></a>01467         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a750be73694a5e22bffc9c62f61cbb779" title="This is used in handleInstallSnapshot when receiving a snapshot from the current leader.">snapshotWriter</a>.reset();
<a name="l01468"></a>01468         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#adcbc3efddd798b87c1a659b2cf9ffd4c" title="Try to read the latest good snapshot from disk.">readSnapshot</a>();
<a name="l01469"></a>01469         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#a66990e7e4f8fd459a7311ce86800e5e7">notify_all</a>();
<a name="l01470"></a>01470     }
<a name="l01471"></a>01471 }
<a name="l01472"></a>01472 
<a name="l01473"></a>01473 <span class="keywordtype">void</span>
<a name="l01474"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a9730411cbbf26e3f718442ebaf92649b">01474</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a9730411cbbf26e3f718442ebaf92649b" title="Process a RequestVote RPC from another server.">RaftConsensus::handleRequestVote</a>(
<a name="l01475"></a>01475                     <span class="keyword">const</span> Protocol::Raft::RequestVote::Request&amp; request,
<a name="l01476"></a>01476                     Protocol::Raft::RequestVote::Response&amp; response)
<a name="l01477"></a>01477 {
<a name="l01478"></a>01478     std::lock_guard&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l01479"></a>01479     assert(!<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a7f8cdeb3a67e3398cca54f23eb5022a6" title="Set to true when this class is about to be destroyed.">exiting</a>);
<a name="l01480"></a>01480 
<a name="l01481"></a>01481     <span class="comment">// If the caller has a less complete log, we can&#39;t give it our vote.</span>
<a name="l01482"></a>01482     uint64_t lastLogIndex = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex();
<a name="l01483"></a>01483     uint64_t lastLogTerm = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ab66363f61f7c6b5dbd298da6d594cca7" title="Return the term corresponding to log-&gt;getLastLogIndex().">getLastLogTerm</a>();
<a name="l01484"></a>01484     <span class="keywordtype">bool</span> logIsOk = (request.last_log_term() &gt; lastLogTerm ||
<a name="l01485"></a>01485                     (request.last_log_term() == lastLogTerm &amp;&amp;
<a name="l01486"></a>01486                      request.last_log_index() &gt;= lastLogIndex));
<a name="l01487"></a>01487 
<a name="l01488"></a>01488     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a075b1f3174db6673435f31622c231d02" title="The earliest time at which RequestVote messages should be processed.">withholdVotesUntil</a> &gt; <a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a13f545c6020dd190e13d21e2577cc59b">Clock::now</a>()) {
<a name="l01489"></a>01489         <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Rejecting RequestVote for term %lu from server %lu, since &quot;</span>
<a name="l01490"></a>01490                <span class="stringliteral">&quot;this server (which is in term %lu) recently heard from a &quot;</span>
<a name="l01491"></a>01491                <span class="stringliteral">&quot;leader (%lu). Should server %lu be shut down?&quot;</span>,
<a name="l01492"></a>01492                request.term(), request.server_id(), <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>,
<a name="l01493"></a>01493                <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae3f2b58c62af497eb474046566656f67" title="The server ID of the leader for this term.">leaderId</a>, request.server_id());
<a name="l01494"></a>01494         response.set_term(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l01495"></a>01495         response.set_granted(<span class="keyword">false</span>);
<a name="l01496"></a>01496         response.set_log_ok(logIsOk);
<a name="l01497"></a>01497         <span class="keywordflow">return</span>;
<a name="l01498"></a>01498     }
<a name="l01499"></a>01499 
<a name="l01500"></a>01500     <span class="keywordflow">if</span> (request.term() &gt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>) {
<a name="l01501"></a>01501         <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Received RequestVote request from server %lu in term %lu &quot;</span>
<a name="l01502"></a>01502                <span class="stringliteral">&quot;(this server&#39;s term was %lu)&quot;</span>,
<a name="l01503"></a>01503                 request.server_id(), request.term(), <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l01504"></a>01504         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a284075bb503d0b8efb9c217a257dadc5" title="Transition to being a follower.">stepDown</a>(request.term());
<a name="l01505"></a>01505     }
<a name="l01506"></a>01506 
<a name="l01507"></a>01507     <span class="comment">// At this point, if leaderId != 0, we could tell the caller to step down.</span>
<a name="l01508"></a>01508     <span class="comment">// However, this is just an optimization that does not affect correctness</span>
<a name="l01509"></a>01509     <span class="comment">// or really even efficiency, so it&#39;s not worth the trouble.</span>
<a name="l01510"></a>01510 
<a name="l01511"></a>01511     <span class="keywordflow">if</span> (request.term() == <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>) {
<a name="l01512"></a>01512         <span class="keywordflow">if</span> (logIsOk &amp;&amp; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1add1a4497b990f9f4b053266459b59d" title="The server ID that this server voted for during this term&#39;s election, if any.">votedFor</a> == 0) {
<a name="l01513"></a>01513             <span class="comment">// Give caller our vote</span>
<a name="l01514"></a>01514             <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Voting for %lu in term %lu&quot;</span>,
<a name="l01515"></a>01515                    request.server_id(), <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l01516"></a>01516             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a284075bb503d0b8efb9c217a257dadc5" title="Transition to being a follower.">stepDown</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l01517"></a>01517             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ac307cba21a66a55c0edc29d6e094ec7a" title="Set the timer to start a new election and notify stateChanged.">setElectionTimer</a>();
<a name="l01518"></a>01518             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1add1a4497b990f9f4b053266459b59d" title="The server ID that this server voted for during this term&#39;s election, if any.">votedFor</a> = request.server_id();
<a name="l01519"></a>01519             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97717592e5ac7db5c59591bd651deff8" title="Persist critical state, such as the term and the vote, to stable storage.">updateLogMetadata</a>();
<a name="l01520"></a>01520             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acfe558f9de36a467f22e24dbb07b38fd" title="Dumps serverId, currentTerm, state, leaderId, and votedFor to the debug log.">printElectionState</a>();
<a name="l01521"></a>01521         }
<a name="l01522"></a>01522     }
<a name="l01523"></a>01523 
<a name="l01524"></a>01524     <span class="comment">// Fill in response.</span>
<a name="l01525"></a>01525     response.set_term(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l01526"></a>01526     <span class="comment">// don&#39;t strictly need the first condition</span>
<a name="l01527"></a>01527     response.set_granted(request.term() == <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a> &amp;&amp;
<a name="l01528"></a>01528                          <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1add1a4497b990f9f4b053266459b59d" title="The server ID that this server voted for during this term&#39;s election, if any.">votedFor</a> == request.server_id());
<a name="l01529"></a>01529     response.set_log_ok(logIsOk);
<a name="l01530"></a>01530 }
<a name="l01531"></a>01531 
<a name="l01532"></a>01532 std::pair&lt;RaftConsensus::ClientResult, uint64_t&gt;
<a name="l01533"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a0093bdf7b22e915100ad46aa974da8c0">01533</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a0093bdf7b22e915100ad46aa974da8c0" title="Submit an operation to the replicated log.">RaftConsensus::replicate</a>(<span class="keyword">const</span> <a class="code" href="classLogCabin_1_1Core_1_1Buffer.html" title="A container for opaque data.">Core::Buffer</a>&amp; operation)
<a name="l01534"></a>01534 {
<a name="l01535"></a>01535     std::unique_lock&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l01536"></a>01536     <a class="code" href="classLogCabin_1_1Storage_1_1Log.html#a8ca64ace5d6ae6f0175186c595d4fbe0" title="The type of a log entry (the same format that&#39;s used in AppendEntries).">Log::Entry</a> entry;
<a name="l01537"></a>01537     entry.set_type(Protocol::Raft::EntryType::DATA);
<a name="l01538"></a>01538     entry.set_data(operation.<a class="code" href="classLogCabin_1_1Core_1_1Buffer.html#a3b84e70fc6c1269fdd8f701ef2d9ab4e" title="Return a pointer to the first byte of data.">getData</a>(), operation.<a class="code" href="classLogCabin_1_1Core_1_1Buffer.html#a08d97c0adafb53992122d2c38a072148" title="Return the number of bytes that make up the data.">getLength</a>());
<a name="l01539"></a>01539     <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2d3262b95e156d88b3e239397bad643e" title="Append an entry to the log and wait for it to be committed.">replicateEntry</a>(entry, lockGuard);
<a name="l01540"></a>01540 }
<a name="l01541"></a>01541 
<a name="l01542"></a>01542 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2e798f8f5febb02f25e027eccac8496a">RaftConsensus::ClientResult</a>
<a name="l01543"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a59692cf950249ec2078077107526e8b7">01543</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a59692cf950249ec2078077107526e8b7" title="Change the cluster&#39;s configuration.">RaftConsensus::setConfiguration</a>(
<a name="l01544"></a>01544         <span class="keyword">const</span> Protocol::Client::SetConfiguration::Request&amp; request,
<a name="l01545"></a>01545         Protocol::Client::SetConfiguration::Response&amp; response)
<a name="l01546"></a>01546 {
<a name="l01547"></a>01547     std::unique_lock&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l01548"></a>01548 
<a name="l01549"></a>01549     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a7f8cdeb3a67e3398cca54f23eb5022a6" title="Set to true when this class is about to be destroyed.">exiting</a> || <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> != State::LEADER) {
<a name="l01550"></a>01550         <span class="comment">// caller fills out response</span>
<a name="l01551"></a>01551         <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2e798f8f5febb02f25e027eccac8496aaf0c9dacaac36992bfc8db3368a4128c4" title="Cannot process the request because this server is not leader or temporarily lost its leadership...">ClientResult::NOT_LEADER</a>;
<a name="l01552"></a>01552     }
<a name="l01553"></a>01553     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;id != request.old_id()) {
<a name="l01554"></a>01554         <span class="comment">// configurations has changed in the meantime</span>
<a name="l01555"></a>01555         response.mutable_configuration_changed()-&gt;set_error(
<a name="l01556"></a>01556             <a class="code" href="namespaceLogCabin_1_1Core_1_1StringUtil.html#a4b3972f4e603a7ba710374772b03c5c7" title="A safe version of sprintf.">Core::StringUtil::format</a>(
<a name="l01557"></a>01557                 <span class="stringliteral">&quot;The current configuration has ID %lu (no longer %lu) &quot;</span>
<a name="l01558"></a>01558                 <span class="stringliteral">&quot;and it&#39;s %s&quot;</span>,
<a name="l01559"></a>01559                 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;id,
<a name="l01560"></a>01560                 request.old_id(),
<a name="l01561"></a>01561                 <a class="code" href="namespaceLogCabin_1_1Core_1_1StringUtil.html#ac524b54525b06c9cf044d38746e3d0f0" title="Return a string returned from the given object&#39;s stream operator.">Core::StringUtil::toString</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;state).c_str()));
<a name="l01562"></a>01562         <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2e798f8f5febb02f25e027eccac8496aa3a5ab1577185f1c48d0e10aa7f6dc29d" title="Returned by setConfiguration() if the configuration could not be set because the previous configurati...">ClientResult::FAIL</a>;
<a name="l01563"></a>01563     }
<a name="l01564"></a>01564     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;state != Configuration::State::STABLE) {
<a name="l01565"></a>01565         response.mutable_configuration_changed()-&gt;set_error(
<a name="l01566"></a>01566             <a class="code" href="namespaceLogCabin_1_1Core_1_1StringUtil.html#a4b3972f4e603a7ba710374772b03c5c7" title="A safe version of sprintf.">Core::StringUtil::format</a>(
<a name="l01567"></a>01567                 <span class="stringliteral">&quot;The current configuration (%lu) is not stable (it&#39;s %s)&quot;</span>,
<a name="l01568"></a>01568                 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;id,
<a name="l01569"></a>01569                 <a class="code" href="namespaceLogCabin_1_1Core_1_1StringUtil.html#ac524b54525b06c9cf044d38746e3d0f0" title="Return a string returned from the given object&#39;s stream operator.">Core::StringUtil::toString</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;state).c_str()));
<a name="l01570"></a>01570         <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2e798f8f5febb02f25e027eccac8496aa3a5ab1577185f1c48d0e10aa7f6dc29d" title="Returned by setConfiguration() if the configuration could not be set because the previous configurati...">ClientResult::FAIL</a>;
<a name="l01571"></a>01571     }
<a name="l01572"></a>01572 
<a name="l01573"></a>01573     <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Attempting to change the configuration from %lu&quot;</span>,
<a name="l01574"></a>01574            <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;id);
<a name="l01575"></a>01575 
<a name="l01576"></a>01576     <span class="comment">// Set the staging servers in the configuration.</span>
<a name="l01577"></a>01577     Protocol::Raft::SimpleConfiguration nextConfiguration;
<a name="l01578"></a>01578     <span class="keywordflow">for</span> (<span class="keyword">auto</span> it = request.new_servers().begin();
<a name="l01579"></a>01579          it != request.new_servers().end();
<a name="l01580"></a>01580          ++it) {
<a name="l01581"></a>01581         <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Adding server %lu at %s to staging servers&quot;</span>,
<a name="l01582"></a>01582                it-&gt;server_id(), it-&gt;addresses().c_str());
<a name="l01583"></a>01583         Protocol::Raft::Server* s = nextConfiguration.add_servers();
<a name="l01584"></a>01584         s-&gt;set_server_id(it-&gt;server_id());
<a name="l01585"></a>01585         s-&gt;set_addresses(it-&gt;addresses());
<a name="l01586"></a>01586     }
<a name="l01587"></a>01587     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;setStagingServers(nextConfiguration);
<a name="l01588"></a>01588     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#a66990e7e4f8fd459a7311ce86800e5e7">notify_all</a>();
<a name="l01589"></a>01589 
<a name="l01590"></a>01590     <span class="comment">// Wait for new servers to be caught up. This will abort if not every</span>
<a name="l01591"></a>01591     <span class="comment">// server makes progress in a ELECTION_TIMEOUT_MS period.</span>
<a name="l01592"></a>01592     uint64_t term = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>;
<a name="l01593"></a>01593     ++<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1ab1473657769c339579f02f7e454513" title="A logical clock used to confirm leadership and connectivity.">currentEpoch</a>;
<a name="l01594"></a>01594     uint64_t epoch = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1ab1473657769c339579f02f7e454513" title="A logical clock used to confirm leadership and connectivity.">currentEpoch</a>;
<a name="l01595"></a>01595     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#adadb64ccb66627454e6001aca18dc801">TimePoint</a> checkProgressAt =
<a name="l01596"></a>01596         <a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a13f545c6020dd190e13d21e2577cc59b">Clock::now</a>() + std::chrono::milliseconds(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5a76d9fce7cc8e8bd69bcf059b89ad93" title="A follower waits for about this much inactivity before becoming a candidate and starting a new electi...">ELECTION_TIMEOUT_MS</a>);
<a name="l01597"></a>01597     <span class="keywordflow">while</span> (<span class="keyword">true</span>) {
<a name="l01598"></a>01598         <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a7f8cdeb3a67e3398cca54f23eb5022a6" title="Set to true when this class is about to be destroyed.">exiting</a> || term != <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>) {
<a name="l01599"></a>01599             <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Lost leadership, aborting configuration change&quot;</span>);
<a name="l01600"></a>01600             <span class="comment">// caller will fill in response</span>
<a name="l01601"></a>01601             <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2e798f8f5febb02f25e027eccac8496aaf0c9dacaac36992bfc8db3368a4128c4" title="Cannot process the request because this server is not leader or temporarily lost its leadership...">ClientResult::NOT_LEADER</a>;
<a name="l01602"></a>01602         }
<a name="l01603"></a>01603         <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;stagingAll(&amp;<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#abaabd1bf45eefc51e4d99548a2c71eb1" title="Return true once this Server is ready to be added to the cluster.">Server::isCaughtUp</a>)) {
<a name="l01604"></a>01604             <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Done catching up servers&quot;</span>);
<a name="l01605"></a>01605             <span class="keywordflow">break</span>;
<a name="l01606"></a>01606         }
<a name="l01607"></a>01607         <span class="keywordflow">if</span> (<a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a13f545c6020dd190e13d21e2577cc59b">Clock::now</a>() &gt;= checkProgressAt) {
<a name="l01608"></a>01608             <span class="keyword">using</span> RaftConsensusInternal::StagingProgressing;
<a name="l01609"></a>01609             StagingProgressing progressing(epoch, response);
<a name="l01610"></a>01610             <span class="keywordflow">if</span> (!<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;stagingAll(progressing)) {
<a name="l01611"></a>01611                 <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Failed to catch up new servers, aborting &quot;</span>
<a name="l01612"></a>01612                        <span class="stringliteral">&quot;configuration change&quot;</span>);
<a name="l01613"></a>01613                 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;resetStagingServers();
<a name="l01614"></a>01614                 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#a66990e7e4f8fd459a7311ce86800e5e7">notify_all</a>();
<a name="l01615"></a>01615                 <span class="comment">// progressing filled in response</span>
<a name="l01616"></a>01616                 <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2e798f8f5febb02f25e027eccac8496aa3a5ab1577185f1c48d0e10aa7f6dc29d" title="Returned by setConfiguration() if the configuration could not be set because the previous configurati...">ClientResult::FAIL</a>;
<a name="l01617"></a>01617             } <span class="keywordflow">else</span> {
<a name="l01618"></a>01618                 ++<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1ab1473657769c339579f02f7e454513" title="A logical clock used to confirm leadership and connectivity.">currentEpoch</a>;
<a name="l01619"></a>01619                 epoch = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1ab1473657769c339579f02f7e454513" title="A logical clock used to confirm leadership and connectivity.">currentEpoch</a>;
<a name="l01620"></a>01620                 checkProgressAt =
<a name="l01621"></a>01621                     (<a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a13f545c6020dd190e13d21e2577cc59b">Clock::now</a>() +
<a name="l01622"></a>01622                      std::chrono::milliseconds(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5a76d9fce7cc8e8bd69bcf059b89ad93" title="A follower waits for about this much inactivity before becoming a candidate and starting a new electi...">ELECTION_TIMEOUT_MS</a>));
<a name="l01623"></a>01623             }
<a name="l01624"></a>01624         }
<a name="l01625"></a>01625         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#ae6b4ac4d192b0efe25cfd5d7dd9a5558">wait_until</a>(lockGuard, checkProgressAt);
<a name="l01626"></a>01626     }
<a name="l01627"></a>01627 
<a name="l01628"></a>01628     <span class="comment">// Write and commit transitional configuration</span>
<a name="l01629"></a>01629     <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Writing transitional configuration entry&quot;</span>);
<a name="l01630"></a>01630     <a class="code" href="namespaceLogCabin_1_1Client.html#a99e2b7ff4ee9b74bcf9dec83b6565fa2" title="Defines the members of the cluster.">Protocol::Raft::Configuration</a> newConfiguration;
<a name="l01631"></a>01631     *newConfiguration.mutable_prev_configuration() =
<a name="l01632"></a>01632         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;description.prev_configuration();
<a name="l01633"></a>01633     *newConfiguration.mutable_next_configuration() = nextConfiguration;
<a name="l01634"></a>01634     <a class="code" href="classLogCabin_1_1Storage_1_1Log.html#a8ca64ace5d6ae6f0175186c595d4fbe0" title="The type of a log entry (the same format that&#39;s used in AppendEntries).">Log::Entry</a> entry;
<a name="l01635"></a>01635     entry.set_type(Protocol::Raft::EntryType::CONFIGURATION);
<a name="l01636"></a>01636     *entry.mutable_configuration() = newConfiguration;
<a name="l01637"></a>01637     std::pair&lt;ClientResult, uint64_t&gt; result =
<a name="l01638"></a>01638         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2d3262b95e156d88b3e239397bad643e" title="Append an entry to the log and wait for it to be committed.">replicateEntry</a>(entry, lockGuard);
<a name="l01639"></a>01639     <span class="keywordflow">if</span> (result.first != ClientResult::SUCCESS) {
<a name="l01640"></a>01640         <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Failed to commit transitional configuration entry, aborting &quot;</span>
<a name="l01641"></a>01641                <span class="stringliteral">&quot;configuration change (%s)&quot;</span>,
<a name="l01642"></a>01642                <a class="code" href="namespaceLogCabin_1_1Core_1_1StringUtil.html#ac524b54525b06c9cf044d38746e3d0f0" title="Return a string returned from the given object&#39;s stream operator.">Core::StringUtil::toString</a>(result.first).c_str());
<a name="l01643"></a>01643         <span class="keywordflow">if</span> (result.first == ClientResult::NOT_LEADER) {
<a name="l01644"></a>01644             <span class="comment">// caller will fill in response</span>
<a name="l01645"></a>01645         } <span class="keywordflow">else</span> {
<a name="l01646"></a>01646             response.mutable_configuration_changed()-&gt;set_error(
<a name="l01647"></a>01647                 <a class="code" href="namespaceLogCabin_1_1Core_1_1StringUtil.html#a4b3972f4e603a7ba710374772b03c5c7" title="A safe version of sprintf.">Core::StringUtil::format</a>(
<a name="l01648"></a>01648                     <span class="stringliteral">&quot;Couldn&#39;t successfully replicate the transitional &quot;</span>
<a name="l01649"></a>01649                     <span class="stringliteral">&quot;configuration (%s)&quot;</span>,
<a name="l01650"></a>01650                     <a class="code" href="namespaceLogCabin_1_1Core_1_1StringUtil.html#ac524b54525b06c9cf044d38746e3d0f0" title="Return a string returned from the given object&#39;s stream operator.">Core::StringUtil::toString</a>(result.first).c_str()));
<a name="l01651"></a>01651         }
<a name="l01652"></a>01652         <span class="keywordflow">return</span> result.first;
<a name="l01653"></a>01653     }
<a name="l01654"></a>01654     uint64_t transitionalId = result.second;
<a name="l01655"></a>01655 
<a name="l01656"></a>01656     <span class="comment">// Wait until the configuration that removes the old servers has been</span>
<a name="l01657"></a>01657     <span class="comment">// committed. This is the first configuration with ID greater than</span>
<a name="l01658"></a>01658     <span class="comment">// transitionalId.</span>
<a name="l01659"></a>01659     <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Waiting for stable configuration to commit&quot;</span>);
<a name="l01660"></a>01660     <span class="keywordflow">while</span> (<span class="keyword">true</span>) {
<a name="l01661"></a>01661         <span class="comment">// Check this first: if the new configuration excludes us so we&#39;ve</span>
<a name="l01662"></a>01662         <span class="comment">// stepped down upon committing it, we still want to return success.</span>
<a name="l01663"></a>01663         <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;id &gt; transitionalId &amp;&amp;
<a name="l01664"></a>01664             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a> &gt;= <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;id) {
<a name="l01665"></a>01665             response.mutable_ok();
<a name="l01666"></a>01666             <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Stable configuration committed. Configuration change &quot;</span>
<a name="l01667"></a>01667                    <span class="stringliteral">&quot;completed successfully&quot;</span>);
<a name="l01668"></a>01668             <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2e798f8f5febb02f25e027eccac8496aa0b5aa96f6ed35c5c9a026c47b2245850" title="Request completed successfully.">ClientResult::SUCCESS</a>;
<a name="l01669"></a>01669         }
<a name="l01670"></a>01670         <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a7f8cdeb3a67e3398cca54f23eb5022a6" title="Set to true when this class is about to be destroyed.">exiting</a> || term != <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>) {
<a name="l01671"></a>01671             <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Lost leadership&quot;</span>);
<a name="l01672"></a>01672             <span class="comment">// caller fills in response</span>
<a name="l01673"></a>01673             <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2e798f8f5febb02f25e027eccac8496aaf0c9dacaac36992bfc8db3368a4128c4" title="Cannot process the request because this server is not leader or temporarily lost its leadership...">ClientResult::NOT_LEADER</a>;
<a name="l01674"></a>01674         }
<a name="l01675"></a>01675         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#aedc8162c9f0251ae3491e6bc6efbe477">wait</a>(lockGuard);
<a name="l01676"></a>01676     }
<a name="l01677"></a>01677 }
<a name="l01678"></a>01678 
<a name="l01679"></a>01679 <span class="keywordtype">void</span>
<a name="l01680"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#af8f0745c0b405e19e196d818e7f83a81">01680</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#af8f0745c0b405e19e196d818e7f83a81" title="Register which versions of client commands/behavior the local state machine supports.">RaftConsensus::setSupportedStateMachineVersions</a>(uint16_t minSupported,
<a name="l01681"></a>01681                                                 uint16_t maxSupported)
<a name="l01682"></a>01682 {
<a name="l01683"></a>01683     std::lock_guard&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l01684"></a>01684     <span class="keyword">auto</span>&amp; s = *<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;localServer;
<a name="l01685"></a>01685     <span class="keywordflow">if</span> (!s.haveStateMachineSupportedVersions ||
<a name="l01686"></a>01686         s.minStateMachineVersion != minSupported ||
<a name="l01687"></a>01687         s.maxStateMachineVersion != maxSupported) {
<a name="l01688"></a>01688 
<a name="l01689"></a>01689         s.haveStateMachineSupportedVersions = <span class="keyword">true</span>;
<a name="l01690"></a>01690         s.minStateMachineVersion = minSupported;
<a name="l01691"></a>01691         s.maxStateMachineVersion = maxSupported;
<a name="l01692"></a>01692         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#a66990e7e4f8fd459a7311ce86800e5e7">notify_all</a>();
<a name="l01693"></a>01693     }
<a name="l01694"></a>01694 }
<a name="l01695"></a>01695 
<a name="l01696"></a>01696 std::unique_ptr&lt;Storage::SnapshotFile::Writer&gt;
<a name="l01697"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ad44a80941ba68083b861eccc6f5acf5a">01697</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ad44a80941ba68083b861eccc6f5acf5a" title="Start taking a snapshot.">RaftConsensus::beginSnapshot</a>(uint64_t lastIncludedIndex)
<a name="l01698"></a>01698 {
<a name="l01699"></a>01699     std::lock_guard&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l01700"></a>01700 
<a name="l01701"></a>01701     <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Creating new snapshot through log index %lu (inclusive)&quot;</span>,
<a name="l01702"></a>01702            lastIncludedIndex);
<a name="l01703"></a>01703     std::unique_ptr&lt;Storage::SnapshotFile::Writer&gt; writer(
<a name="l01704"></a>01704                 <span class="keyword">new</span> <a class="code" href="classLogCabin_1_1Storage_1_1SnapshotFile_1_1Writer.html" title="Assists in writing snapshot files to the local filesystem.">Storage::SnapshotFile::Writer</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a6bed133d4a5b6e69399b1dbc44f7f483" title="Where the files for the log and snapshots are stored.">storageLayout</a>));
<a name="l01705"></a>01705 
<a name="l01706"></a>01706     <span class="comment">// Only committed entries may be snapshotted.</span>
<a name="l01707"></a>01707     <span class="comment">// (This check relies on commitIndex monotonically increasing.)</span>
<a name="l01708"></a>01708     <span class="keywordflow">if</span> (lastIncludedIndex &gt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a>) {
<a name="l01709"></a>01709         <a class="code" href="Core_2Debug_8h.html#ad84b0f521394f4d9214c9d185711a8c3" title="Log an ERROR message and abort the process.">PANIC</a>(<span class="stringliteral">&quot;Attempted to snapshot uncommitted entries (%lu requested but &quot;</span>
<a name="l01710"></a>01710               <span class="stringliteral">&quot;%lu is last committed entry)&quot;</span>, lastIncludedIndex, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a>);
<a name="l01711"></a>01711     }
<a name="l01712"></a>01712 
<a name="l01713"></a>01713     <span class="comment">// Format version of snapshot file is 1.</span>
<a name="l01714"></a>01714     uint8_t version = 1;
<a name="l01715"></a>01715     writer-&gt;writeRaw(&amp;version, <span class="keyword">sizeof</span>(version));
<a name="l01716"></a>01716 
<a name="l01717"></a>01717     <span class="comment">// set header fields</span>
<a name="l01718"></a>01718     SnapshotMetadata::Header header;
<a name="l01719"></a>01719     header.set_last_included_index(lastIncludedIndex);
<a name="l01720"></a>01720     <span class="comment">// Set last_included_term and last_cluster_time:</span>
<a name="l01721"></a>01721     <span class="keywordflow">if</span> (lastIncludedIndex &gt;= <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLogStartIndex() &amp;&amp;
<a name="l01722"></a>01722         lastIncludedIndex &lt;= <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex()) {
<a name="l01723"></a>01723         <span class="keyword">const</span> <a class="code" href="classLogCabin_1_1Storage_1_1Log.html#a8ca64ace5d6ae6f0175186c595d4fbe0" title="The type of a log entry (the same format that&#39;s used in AppendEntries).">Log::Entry</a>&amp; entry = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getEntry(lastIncludedIndex);
<a name="l01724"></a>01724         header.set_last_included_term(entry.term());
<a name="l01725"></a>01725         header.set_last_cluster_time(entry.cluster_time());
<a name="l01726"></a>01726     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lastIncludedIndex == 0) {
<a name="l01727"></a>01727         <a class="code" href="Core_2Debug_8h.html#ad51176fec84ca79bd96163c9cb5a7c32" title="Log a WARNING message.">WARNING</a>(<span class="stringliteral">&quot;Taking a snapshot covering no log entries&quot;</span>);
<a name="l01728"></a>01728         header.set_last_included_term(0);
<a name="l01729"></a>01729         header.set_last_cluster_time(0);
<a name="l01730"></a>01730     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lastIncludedIndex == <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>) {
<a name="l01731"></a>01731         <a class="code" href="Core_2Debug_8h.html#ad51176fec84ca79bd96163c9cb5a7c32" title="Log a WARNING message.">WARNING</a>(<span class="stringliteral">&quot;Taking a snapshot where we already have one, covering &quot;</span>
<a name="l01732"></a>01732                 <span class="stringliteral">&quot;entries 1 through %lu (inclusive)&quot;</span>, lastIncludedIndex);
<a name="l01733"></a>01733         header.set_last_included_term(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5f0c55552abd43fa5b1ffe779f70fcf9" title="The term of the last entry covered by the latest good snapshot, or 0 if we have no snapshot...">lastSnapshotTerm</a>);
<a name="l01734"></a>01734         header.set_last_cluster_time(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#af98e037190d928bbe2ecda31a19ca7c2" title="The cluster time of the last entry covered by the latest good snapshot, or 0 if we have no snapshot...">lastSnapshotClusterTime</a>);
<a name="l01735"></a>01735     } <span class="keywordflow">else</span> {
<a name="l01736"></a>01736         <a class="code" href="Core_2Debug_8h.html#ad51176fec84ca79bd96163c9cb5a7c32" title="Log a WARNING message.">WARNING</a>(<span class="stringliteral">&quot;We&#39;ve already discarded the entries that the state machine &quot;</span>
<a name="l01737"></a>01737                 <span class="stringliteral">&quot;wants to snapshot. This can happen in rare cases if the &quot;</span>
<a name="l01738"></a>01738                 <span class="stringliteral">&quot;leader already sent us a newer snapshot. We&#39;ll go ahead and &quot;</span>
<a name="l01739"></a>01739                 <span class="stringliteral">&quot;compute the snapshot, but it&#39;ll be discarded later in &quot;</span>
<a name="l01740"></a>01740                 <span class="stringliteral">&quot;snapshotDone(). Setting the last included term in the &quot;</span>
<a name="l01741"></a>01741                 <span class="stringliteral">&quot;snapshot header to 0 (a bogus value).&quot;</span>);
<a name="l01742"></a>01742         <span class="comment">// If this turns out to be common, we should return NULL instead and</span>
<a name="l01743"></a>01743         <span class="comment">// change the state machines to deal with that.</span>
<a name="l01744"></a>01744         header.set_last_included_term(0);
<a name="l01745"></a>01745         header.set_last_cluster_time(0);
<a name="l01746"></a>01746     }
<a name="l01747"></a>01747 
<a name="l01748"></a>01748     <span class="comment">// Copy the configuration as of lastIncludedIndex to the header.</span>
<a name="l01749"></a>01749     std::pair&lt;uint64_t, Protocol::Raft::Configuration&gt; c =
<a name="l01750"></a>01750         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ade5bbdec3e8ff60b7931a2682b2bb4ef" title="Ensures that &#39;configuration&#39; reflects the latest state of the log and snapshot.">configurationManager</a>-&gt;getLatestConfigurationAsOf(lastIncludedIndex);
<a name="l01751"></a>01751     <span class="keywordflow">if</span> (c.first == 0) {
<a name="l01752"></a>01752         <a class="code" href="Core_2Debug_8h.html#ad51176fec84ca79bd96163c9cb5a7c32" title="Log a WARNING message.">WARNING</a>(<span class="stringliteral">&quot;Taking snapshot with no configuration. &quot;</span>
<a name="l01753"></a>01753                 <span class="stringliteral">&quot;This should have been the first thing in the log.&quot;</span>);
<a name="l01754"></a>01754     } <span class="keywordflow">else</span> {
<a name="l01755"></a>01755         header.set_configuration_index(c.first);
<a name="l01756"></a>01756         *header.mutable_configuration() = c.second;
<a name="l01757"></a>01757     }
<a name="l01758"></a>01758 
<a name="l01759"></a>01759     <span class="comment">// write header to file</span>
<a name="l01760"></a>01760     writer-&gt;writeMessage(header);
<a name="l01761"></a>01761     <span class="keywordflow">return</span> writer;
<a name="l01762"></a>01762 }
<a name="l01763"></a>01763 
<a name="l01764"></a>01764 <span class="keywordtype">void</span>
<a name="l01765"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a371d2d3e4c5228c7bf7ebecc3b004cda">01765</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a371d2d3e4c5228c7bf7ebecc3b004cda" title="Complete taking a snapshot for the log entries in range [1, lastIncludedIndex].">RaftConsensus::snapshotDone</a>(
<a name="l01766"></a>01766         uint64_t lastIncludedIndex,
<a name="l01767"></a>01767         std::unique_ptr&lt;Storage::SnapshotFile::Writer&gt; writer)
<a name="l01768"></a>01768 {
<a name="l01769"></a>01769     std::lock_guard&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l01770"></a>01770     <span class="keywordflow">if</span> (lastIncludedIndex &lt;= <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>) {
<a name="l01771"></a>01771         <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Discarding snapshot through %lu since we already have one &quot;</span>
<a name="l01772"></a>01772                <span class="stringliteral">&quot;(presumably from another server) through %lu&quot;</span>,
<a name="l01773"></a>01773                lastIncludedIndex, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>);
<a name="l01774"></a>01774         writer-&gt;discard();
<a name="l01775"></a>01775         <span class="keywordflow">return</span>;
<a name="l01776"></a>01776     }
<a name="l01777"></a>01777 
<a name="l01778"></a>01778     <span class="comment">// log-&gt;getEntry(lastIncludedIndex) is safe:</span>
<a name="l01779"></a>01779     <span class="comment">// If the log prefix for this snapshot was truncated, that means we have a</span>
<a name="l01780"></a>01780     <span class="comment">// newer snapshot (handled above).</span>
<a name="l01781"></a>01781     assert(lastIncludedIndex &gt;= <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLogStartIndex());
<a name="l01782"></a>01782     <span class="comment">// We never truncate committed entries from the end of our log, and</span>
<a name="l01783"></a>01783     <span class="comment">// beginSnapshot() made sure that lastIncludedIndex covers only committed</span>
<a name="l01784"></a>01784     <span class="comment">// entries.</span>
<a name="l01785"></a>01785     assert(lastIncludedIndex &lt;= log-&gt;getLastLogIndex());
<a name="l01786"></a>01786 
<a name="l01787"></a>01787     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a3f14561ea354f31be363ab7f008b9961" title="The size of the latest good snapshot in bytes, or 0 if we have no snapshot.">lastSnapshotBytes</a> = writer-&gt;save();
<a name="l01788"></a>01788     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a> = lastIncludedIndex;
<a name="l01789"></a>01789     <span class="keyword">const</span> <a class="code" href="classLogCabin_1_1Storage_1_1Log.html#a8ca64ace5d6ae6f0175186c595d4fbe0" title="The type of a log entry (the same format that&#39;s used in AppendEntries).">Log::Entry</a>&amp; lastEntry = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getEntry(lastIncludedIndex);
<a name="l01790"></a>01790     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5f0c55552abd43fa5b1ffe779f70fcf9" title="The term of the last entry covered by the latest good snapshot, or 0 if we have no snapshot...">lastSnapshotTerm</a> = lastEntry.term();
<a name="l01791"></a>01791     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#af98e037190d928bbe2ecda31a19ca7c2" title="The cluster time of the last entry covered by the latest good snapshot, or 0 if we have no snapshot...">lastSnapshotClusterTime</a> = lastEntry.cluster_time();
<a name="l01792"></a>01792 
<a name="l01793"></a>01793     <span class="comment">// It&#39;s easier to grab this configuration out of the manager again than to</span>
<a name="l01794"></a>01794     <span class="comment">// carry it around after writing the header.</span>
<a name="l01795"></a>01795     std::pair&lt;uint64_t, Protocol::Raft::Configuration&gt; c =
<a name="l01796"></a>01796         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ade5bbdec3e8ff60b7931a2682b2bb4ef" title="Ensures that &#39;configuration&#39; reflects the latest state of the log and snapshot.">configurationManager</a>-&gt;getLatestConfigurationAsOf(lastIncludedIndex);
<a name="l01797"></a>01797     <span class="keywordflow">if</span> (c.first == 0) {
<a name="l01798"></a>01798         <a class="code" href="Core_2Debug_8h.html#ad51176fec84ca79bd96163c9cb5a7c32" title="Log a WARNING message.">WARNING</a>(<span class="stringliteral">&quot;Could not find the latest configuration as of index %lu &quot;</span>
<a name="l01799"></a>01799                 <span class="stringliteral">&quot;(inclusive). This shouldn&#39;t happen if the snapshot was &quot;</span>
<a name="l01800"></a>01800                 <span class="stringliteral">&quot;created with a configuration, as they should be.&quot;</span>,
<a name="l01801"></a>01801                 lastIncludedIndex);
<a name="l01802"></a>01802     } <span class="keywordflow">else</span> {
<a name="l01803"></a>01803         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ade5bbdec3e8ff60b7931a2682b2bb4ef" title="Ensures that &#39;configuration&#39; reflects the latest state of the log and snapshot.">configurationManager</a>-&gt;setSnapshot(c.first, c.second);
<a name="l01804"></a>01804     }
<a name="l01805"></a>01805 
<a name="l01806"></a>01806     <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Completed snapshot through log index %lu (inclusive)&quot;</span>,
<a name="l01807"></a>01807            <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>);
<a name="l01808"></a>01808 
<a name="l01809"></a>01809     <span class="comment">// It may be beneficial to defer discarding entries if some followers are</span>
<a name="l01810"></a>01810     <span class="comment">// a little bit slow, to avoid having to send them a snapshot when a few</span>
<a name="l01811"></a>01811     <span class="comment">// entries would do the trick. Best to avoid premature optimization though.</span>
<a name="l01812"></a>01812     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#af98ae4ff770b37572783ee33946fb0b7" title="Remove the prefix of the log that is redundant with this server&#39;s snapshot.">discardUnneededEntries</a>();
<a name="l01813"></a>01813 }
<a name="l01814"></a>01814 
<a name="l01815"></a>01815 <span class="keywordtype">void</span>
<a name="l01816"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a466e3fec92bbbf8d0ac5813584fe4a1e">01816</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a466e3fec92bbbf8d0ac5813584fe4a1e" title="Add information about the consensus state to the given structure.">RaftConsensus::updateServerStats</a>(Protocol::ServerStats&amp; serverStats)<span class="keyword"> const</span>
<a name="l01817"></a>01817 <span class="keyword"></span>{
<a name="l01818"></a>01818     std::lock_guard&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l01819"></a>01819     <a class="code" href="classLogCabin_1_1Core_1_1Time_1_1SteadyTimeConverter.html" title="Used to convert one or more SteadyClock::time_point values into values of the SystemClock.">Core::Time::SteadyTimeConverter</a> time;
<a name="l01820"></a>01820     serverStats.clear_raft();
<a name="l01821"></a>01821     Protocol::ServerStats::Raft&amp; raftStats = *serverStats.mutable_raft();
<a name="l01822"></a>01822 
<a name="l01823"></a>01823     raftStats.set_current_term(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l01824"></a>01824     <span class="keywordflow">switch</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a>) {
<a name="l01825"></a>01825         <span class="keywordflow">case</span> State::FOLLOWER:
<a name="l01826"></a>01826             raftStats.set_state(Protocol::ServerStats::Raft::FOLLOWER);
<a name="l01827"></a>01827             <span class="keywordflow">break</span>;
<a name="l01828"></a>01828         <span class="keywordflow">case</span> State::CANDIDATE:
<a name="l01829"></a>01829             raftStats.set_state(Protocol::ServerStats::Raft::CANDIDATE);
<a name="l01830"></a>01830             <span class="keywordflow">break</span>;
<a name="l01831"></a>01831         <span class="keywordflow">case</span> State::LEADER:
<a name="l01832"></a>01832             raftStats.set_state(Protocol::ServerStats::Raft::LEADER);
<a name="l01833"></a>01833             <span class="keywordflow">break</span>;
<a name="l01834"></a>01834     }
<a name="l01835"></a>01835     raftStats.set_commit_index(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a>);
<a name="l01836"></a>01836     raftStats.set_last_log_index(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex());
<a name="l01837"></a>01837     raftStats.set_leader_id(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae3f2b58c62af497eb474046566656f67" title="The server ID of the leader for this term.">leaderId</a>);
<a name="l01838"></a>01838     raftStats.set_voted_for(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1add1a4497b990f9f4b053266459b59d" title="The server ID that this server voted for during this term&#39;s election, if any.">votedFor</a>);
<a name="l01839"></a>01839     raftStats.set_start_election_at(time.<a class="code" href="classLogCabin_1_1Core_1_1Time_1_1SteadyTimeConverter.html#aa967e929bf170e2fe251eb06ad8b3dd7" title="Return the given time in nanoseconds since the Unix epoch according the system clock (assuming no tim...">unixNanos</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a3528d66b8409ca51a4392d7c3f395d39" title="The earliest time at which timerThread should begin a new election with startNewElection().">startElectionAt</a>));
<a name="l01840"></a>01840     raftStats.set_withhold_votes_until(time.<a class="code" href="classLogCabin_1_1Core_1_1Time_1_1SteadyTimeConverter.html#aa967e929bf170e2fe251eb06ad8b3dd7" title="Return the given time in nanoseconds since the Unix epoch according the system clock (assuming no tim...">unixNanos</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a075b1f3174db6673435f31622c231d02" title="The earliest time at which RequestVote messages should be processed.">withholdVotesUntil</a>));
<a name="l01841"></a>01841     raftStats.set_cluster_time_epoch(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aa525cfc8dac0abdc8f744f5bd75302ae" title="Tracks the passage of &quot;cluster time&quot;.">clusterClock</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#a9d1de557c99f1ad6b3b175f9d4838983" title="Invariant: this is equal to the cluster time in:">clusterTimeAtEpoch</a>);
<a name="l01842"></a>01842     raftStats.set_cluster_time(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aa525cfc8dac0abdc8f744f5bd75302ae" title="Tracks the passage of &quot;cluster time&quot;.">clusterClock</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#a348adcaf81872e5046c141a95c7771fe" title="Return the best approximation of the current cluster time, assuming there&#39;s been a leader all along...">interpolate</a>());
<a name="l01843"></a>01843 
<a name="l01844"></a>01844     raftStats.set_last_snapshot_index(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>);
<a name="l01845"></a>01845     raftStats.set_last_snapshot_term(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5f0c55552abd43fa5b1ffe779f70fcf9" title="The term of the last entry covered by the latest good snapshot, or 0 if we have no snapshot...">lastSnapshotTerm</a>);
<a name="l01846"></a>01846     raftStats.set_last_snapshot_cluster_time(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#af98e037190d928bbe2ecda31a19ca7c2" title="The cluster time of the last entry covered by the latest good snapshot, or 0 if we have no snapshot...">lastSnapshotClusterTime</a>);
<a name="l01847"></a>01847     raftStats.set_last_snapshot_bytes(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a3f14561ea354f31be363ab7f008b9961" title="The size of the latest good snapshot in bytes, or 0 if we have no snapshot.">lastSnapshotBytes</a>);
<a name="l01848"></a>01848     raftStats.set_num_entries_truncated(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a651ad565303b12e3ab72a38429349d23" title="The total number of entries ever truncated from the end of the log.">numEntriesTruncated</a>);
<a name="l01849"></a>01849     raftStats.set_log_start_index(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLogStartIndex());
<a name="l01850"></a>01850     raftStats.set_log_bytes(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getSizeBytes());
<a name="l01851"></a>01851     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;updateServerStats(serverStats, time);
<a name="l01852"></a>01852     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;updateServerStats(serverStats);
<a name="l01853"></a>01853 }
<a name="l01854"></a>01854 
<a name="l01855"></a>01855 std::ostream&amp;
<a name="l01856"></a><a class="code" href="namespaceLogCabin_1_1Server.html#ab9983b72b5cc28f2c8dae1ce8803adad">01856</a> <a class="code" href="namespaceLogCabin_1_1Server.html#ab9983b72b5cc28f2c8dae1ce8803adad">operator&lt;&lt;</a>(std::ostream&amp; os, <span class="keyword">const</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html" title="An implementation of the Raft consensus algorithm.">RaftConsensus</a>&amp; raft)
<a name="l01857"></a>01857 {
<a name="l01858"></a>01858     std::lock_guard&lt;RaftConsensus::Mutex&gt; lockGuard(raft.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l01859"></a>01859     <span class="keyword">typedef</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a8a1270561380477170b6c7447705d74f" title="See state.">RaftConsensus::State</a> State;
<a name="l01860"></a>01860     os &lt;&lt; <span class="stringliteral">&quot;server id: &quot;</span> &lt;&lt; raft.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a32b5b6a4d6ae35dcd20c8ba3e7a95de0" title="This server&#39;s unique ID.">serverId</a> &lt;&lt; std::endl;
<a name="l01861"></a>01861     os &lt;&lt; <span class="stringliteral">&quot;term: &quot;</span> &lt;&lt; raft.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a> &lt;&lt; std::endl;
<a name="l01862"></a>01862     os &lt;&lt; <span class="stringliteral">&quot;state: &quot;</span> &lt;&lt; raft.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> &lt;&lt; std::endl;
<a name="l01863"></a>01863     os &lt;&lt; <span class="stringliteral">&quot;leader: &quot;</span> &lt;&lt; raft.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae3f2b58c62af497eb474046566656f67" title="The server ID of the leader for this term.">leaderId</a> &lt;&lt; std::endl;
<a name="l01864"></a>01864     os &lt;&lt; <span class="stringliteral">&quot;lastSnapshotIndex: &quot;</span> &lt;&lt; raft.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a> &lt;&lt; std::endl;
<a name="l01865"></a>01865     os &lt;&lt; <span class="stringliteral">&quot;lastSnapshotTerm: &quot;</span> &lt;&lt; raft.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5f0c55552abd43fa5b1ffe779f70fcf9" title="The term of the last entry covered by the latest good snapshot, or 0 if we have no snapshot...">lastSnapshotTerm</a> &lt;&lt; std::endl;
<a name="l01866"></a>01866     os &lt;&lt; <span class="stringliteral">&quot;lastSnapshotClusterTime: &quot;</span> &lt;&lt; raft.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#af98e037190d928bbe2ecda31a19ca7c2" title="The cluster time of the last entry covered by the latest good snapshot, or 0 if we have no snapshot...">lastSnapshotClusterTime</a>
<a name="l01867"></a>01867        &lt;&lt; std::endl;
<a name="l01868"></a>01868     os &lt;&lt; <span class="stringliteral">&quot;commitIndex: &quot;</span> &lt;&lt; raft.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a> &lt;&lt; std::endl;
<a name="l01869"></a>01869     <span class="keywordflow">switch</span> (raft.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a>) {
<a name="l01870"></a>01870         <span class="keywordflow">case</span> State::FOLLOWER:
<a name="l01871"></a>01871             os &lt;&lt; <span class="stringliteral">&quot;vote: &quot;</span>;
<a name="l01872"></a>01872             <span class="keywordflow">if</span> (raft.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1add1a4497b990f9f4b053266459b59d" title="The server ID that this server voted for during this term&#39;s election, if any.">votedFor</a> == 0)
<a name="l01873"></a>01873                 os &lt;&lt; <span class="stringliteral">&quot;available&quot;</span>;
<a name="l01874"></a>01874             <span class="keywordflow">else</span>
<a name="l01875"></a>01875                 os &lt;&lt; <span class="stringliteral">&quot;given to &quot;</span> &lt;&lt; raft.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1add1a4497b990f9f4b053266459b59d" title="The server ID that this server voted for during this term&#39;s election, if any.">votedFor</a>;
<a name="l01876"></a>01876             os &lt;&lt; std::endl;
<a name="l01877"></a>01877             <span class="keywordflow">break</span>;
<a name="l01878"></a>01878         <span class="keywordflow">case</span> State::CANDIDATE:
<a name="l01879"></a>01879             <span class="keywordflow">break</span>;
<a name="l01880"></a>01880         <span class="keywordflow">case</span> State::LEADER:
<a name="l01881"></a>01881             <span class="keywordflow">break</span>;
<a name="l01882"></a>01882     }
<a name="l01883"></a>01883     os &lt;&lt; *raft.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>;
<a name="l01884"></a>01884     os &lt;&lt; *raft.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>;
<a name="l01885"></a>01885     <span class="keywordflow">return</span> os;
<a name="l01886"></a>01886 }
<a name="l01887"></a>01887 
<a name="l01888"></a>01888 <span class="comment"></span>
<a name="l01889"></a>01889 <span class="comment">//// RaftConsensus private methods that MUST acquire the lock</span>
<a name="l01890"></a>01890 <span class="comment"></span>
<a name="l01891"></a>01891 <span class="keywordtype">void</span>
<a name="l01892"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ade987b3689a8b49a9e08e749af69110a">01892</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ade987b3689a8b49a9e08e749af69110a" title="Append advance state machine version entries to the log as leader once all servers can support a new ...">RaftConsensus::stateMachineUpdaterThreadMain</a>()
<a name="l01893"></a>01893 {
<a name="l01894"></a>01894     <span class="comment">// This implementation might create many spurious entries, since this</span>
<a name="l01895"></a>01895     <span class="comment">// process will append a state machine version if it hasn&#39;t appended that</span>
<a name="l01896"></a>01896     <span class="comment">// same version before during this boot. That should be fine for most use</span>
<a name="l01897"></a>01897     <span class="comment">// cases. If the state machine&#39;s num_redundant_advance_version_entries</span>
<a name="l01898"></a>01898     <span class="comment">// server stat gets to be large, this may need to be revisited.</span>
<a name="l01899"></a>01899     std::unique_lock&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l01900"></a>01900     <a class="code" href="namespaceLogCabin_1_1Core_1_1ThreadId.html#a4dbe9da59e37b2a282c41984be0ebdcb" title="Set the friendly name for the current thread.">Core::ThreadId::setName</a>(<span class="stringliteral">&quot;StateMachineUpdater&quot;</span>);
<a name="l01901"></a>01901     uint64_t lastVersionCommitted = 0;
<a name="l01902"></a>01902     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#adadb64ccb66627454e6001aca18dc801">TimePoint</a> backoffUntil = TimePoint::min();
<a name="l01903"></a>01903     <span class="keywordflow">while</span> (!<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a7f8cdeb3a67e3398cca54f23eb5022a6" title="Set to true when this class is about to be destroyed.">exiting</a>) {
<a name="l01904"></a>01904         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#adadb64ccb66627454e6001aca18dc801">TimePoint</a> now = <a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a13f545c6020dd190e13d21e2577cc59b">Clock::now</a>();
<a name="l01905"></a>01905         <span class="keywordflow">if</span> (backoffUntil &lt;= now &amp;&amp; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> == State::LEADER) {
<a name="l01906"></a>01906             <span class="keyword">using</span> RaftConsensusInternal::StateMachineVersionIntersection;
<a name="l01907"></a>01907             StateMachineVersionIntersection s;
<a name="l01908"></a>01908             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;forEach(std::ref(s));
<a name="l01909"></a>01909             <span class="keywordflow">if</span> (s.missingCount == 0) {
<a name="l01910"></a>01910                 <span class="keywordflow">if</span> (s.minVersion &gt; s.maxVersion) {
<a name="l01911"></a>01911                     <a class="code" href="Core_2Debug_8h.html#a78e40dfd87f516e322340d249027aea1" title="Log an ERROR message.">ERROR</a>(<span class="stringliteral">&quot;The state machines on the %lu servers do not &quot;</span>
<a name="l01912"></a>01912                           <span class="stringliteral">&quot;currently support a common version &quot;</span>
<a name="l01913"></a>01913                           <span class="stringliteral">&quot;(max of mins=%u, min of maxes=%u). Will wait to &quot;</span>
<a name="l01914"></a>01914                           <span class="stringliteral">&quot;change the state machine version for at least &quot;</span>
<a name="l01915"></a>01915                           <span class="stringliteral">&quot;another backoff period&quot;</span>,
<a name="l01916"></a>01916                           s.allCount,
<a name="l01917"></a>01917                           s.minVersion,
<a name="l01918"></a>01918                           s.maxVersion);
<a name="l01919"></a>01919                     backoffUntil = now + <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a4b14bc75339c857054abc16882aae2d8" title="How long the state machine updater thread should sleep if:">STATE_MACHINE_UPDATER_BACKOFF</a>;
<a name="l01920"></a>01920                 } <span class="keywordflow">else</span> { <span class="comment">// s.maxVersion is the one we want</span>
<a name="l01921"></a>01921                     <span class="keywordflow">if</span> (s.maxVersion &gt; lastVersionCommitted) {
<a name="l01922"></a>01922                         <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Appending log entry to advance state machine &quot;</span>
<a name="l01923"></a>01923                                <span class="stringliteral">&quot;version to %u (it may be set to %u already, &quot;</span>
<a name="l01924"></a>01924                                <span class="stringliteral">&quot;but it&#39;s hard to check that and not much &quot;</span>
<a name="l01925"></a>01925                                <span class="stringliteral">&quot;overhead to just do it again)&quot;</span>,
<a name="l01926"></a>01926                                s.maxVersion,
<a name="l01927"></a>01927                                s.maxVersion);
<a name="l01928"></a>01928                         <a class="code" href="classLogCabin_1_1Storage_1_1Log.html#a8ca64ace5d6ae6f0175186c595d4fbe0" title="The type of a log entry (the same format that&#39;s used in AppendEntries).">Log::Entry</a> entry;
<a name="l01929"></a>01929                         entry.set_term(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l01930"></a>01930                         entry.set_type(Protocol::Raft::EntryType::DATA);
<a name="l01931"></a>01931                         entry.set_cluster_time(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aa525cfc8dac0abdc8f744f5bd75302ae" title="Tracks the passage of &quot;cluster time&quot;.">clusterClock</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#acfeeb3627de0308d4259324b78b7d84a" title="Called by leaders to generate a new cluster time for a new log entry.">leaderStamp</a>());
<a name="l01932"></a>01932                         Protocol::Client::StateMachineCommand::Request command;
<a name="l01933"></a>01933                         command.mutable_advance_version()-&gt;
<a name="l01934"></a>01934                             set_requested_version(s.maxVersion);
<a name="l01935"></a>01935                         <a class="code" href="classLogCabin_1_1Core_1_1Buffer.html" title="A container for opaque data.">Core::Buffer</a> cmdBuf;
<a name="l01936"></a>01936                         <a class="code" href="namespaceLogCabin_1_1Core_1_1ProtoBuf.html#a59b769e00332b67dbfddb348c3707956" title="Serialize a protocol buffer message into a Core::Buffer.">Core::ProtoBuf::serialize</a>(command, cmdBuf);
<a name="l01937"></a>01937                         entry.set_data(cmdBuf.<a class="code" href="classLogCabin_1_1Core_1_1Buffer.html#a3b84e70fc6c1269fdd8f701ef2d9ab4e" title="Return a pointer to the first byte of data.">getData</a>(), cmdBuf.<a class="code" href="classLogCabin_1_1Core_1_1Buffer.html#a08d97c0adafb53992122d2c38a072148" title="Return the number of bytes that make up the data.">getLength</a>());
<a name="l01938"></a>01938 
<a name="l01939"></a>01939                         std::pair&lt;ClientResult, uint64_t&gt; result =
<a name="l01940"></a>01940                             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2d3262b95e156d88b3e239397bad643e" title="Append an entry to the log and wait for it to be committed.">replicateEntry</a>(entry, lockGuard);
<a name="l01941"></a>01941                         <span class="keywordflow">if</span> (result.first == ClientResult::SUCCESS) {
<a name="l01942"></a>01942                             lastVersionCommitted = s.maxVersion;
<a name="l01943"></a>01943                         } <span class="keywordflow">else</span> {
<a name="l01944"></a>01944                             <span class="keyword">using</span> <a class="code" href="namespaceLogCabin_1_1Core_1_1StringUtil.html#ac524b54525b06c9cf044d38746e3d0f0" title="Return a string returned from the given object&#39;s stream operator.">Core::StringUtil::toString</a>;
<a name="l01945"></a>01945                             <a class="code" href="Core_2Debug_8h.html#ad51176fec84ca79bd96163c9cb5a7c32" title="Log a WARNING message.">WARNING</a>(<span class="stringliteral">&quot;Failed to commit entry to advance state &quot;</span>
<a name="l01946"></a>01946                                     <span class="stringliteral">&quot;machine version to version %u (%s). &quot;</span>
<a name="l01947"></a>01947                                     <span class="stringliteral">&quot;Will retry later after backoff period&quot;</span>,
<a name="l01948"></a>01948                                     s.maxVersion,
<a name="l01949"></a>01949                                     <a class="code" href="namespaceLogCabin_1_1Core_1_1StringUtil.html#ac524b54525b06c9cf044d38746e3d0f0" title="Return a string returned from the given object&#39;s stream operator.">toString</a>(result.first).c_str());
<a name="l01950"></a>01950                             backoffUntil = now + <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a4b14bc75339c857054abc16882aae2d8" title="How long the state machine updater thread should sleep if:">STATE_MACHINE_UPDATER_BACKOFF</a>;
<a name="l01951"></a>01951                         }
<a name="l01952"></a>01952                         <span class="keywordflow">continue</span>;
<a name="l01953"></a>01953                     } <span class="keywordflow">else</span> {
<a name="l01954"></a>01954                         <span class="comment">// We&#39;re in good shape, go back to sleep.</span>
<a name="l01955"></a>01955                     }
<a name="l01956"></a>01956                 }
<a name="l01957"></a>01957             } <span class="keywordflow">else</span> { <span class="comment">// missing info from at least one server</span>
<a name="l01958"></a>01958                 <span class="comment">// Do nothing until we have info from everyone else</span>
<a name="l01959"></a>01959                 <span class="comment">// (stateChanged will be notified). The backoff is here just to</span>
<a name="l01960"></a>01960                 <span class="comment">// avoid spamming the NOTICE message.</span>
<a name="l01961"></a>01961                 <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Waiting to receive state machine supported version &quot;</span>
<a name="l01962"></a>01962                        <span class="stringliteral">&quot;information from all peers (missing %lu of %lu)&quot;</span>,
<a name="l01963"></a>01963                        s.missingCount, s.allCount);
<a name="l01964"></a>01964                 backoffUntil = now + <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a4b14bc75339c857054abc16882aae2d8" title="How long the state machine updater thread should sleep if:">STATE_MACHINE_UPDATER_BACKOFF</a>;
<a name="l01965"></a>01965             }
<a name="l01966"></a>01966         }
<a name="l01967"></a>01967         <span class="keywordflow">if</span> (backoffUntil &lt;= now)
<a name="l01968"></a>01968             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#aedc8162c9f0251ae3491e6bc6efbe477">wait</a>(lockGuard);
<a name="l01969"></a>01969         <span class="keywordflow">else</span>
<a name="l01970"></a>01970             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#ae6b4ac4d192b0efe25cfd5d7dd9a5558">wait_until</a>(lockGuard, backoffUntil);
<a name="l01971"></a>01971     }
<a name="l01972"></a>01972     <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Exiting&quot;</span>);
<a name="l01973"></a>01973 }
<a name="l01974"></a>01974 
<a name="l01975"></a>01975 <span class="keywordtype">void</span>
<a name="l01976"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ab869a94f802cecc39c768a3425aac160">01976</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ab869a94f802cecc39c768a3425aac160" title="Flush log entries to stable storage in the background on leaders.">RaftConsensus::leaderDiskThreadMain</a>()
<a name="l01977"></a>01977 {
<a name="l01978"></a>01978     std::unique_lock&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l01979"></a>01979     <a class="code" href="namespaceLogCabin_1_1Core_1_1ThreadId.html#a4dbe9da59e37b2a282c41984be0ebdcb" title="Set the friendly name for the current thread.">Core::ThreadId::setName</a>(<span class="stringliteral">&quot;LeaderDisk&quot;</span>);
<a name="l01980"></a>01980     <span class="comment">// Each iteration of this loop syncs the log to disk once or sleeps until</span>
<a name="l01981"></a>01981     <span class="comment">// that is necessary.</span>
<a name="l01982"></a>01982     <span class="keywordflow">while</span> (!<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a7f8cdeb3a67e3398cca54f23eb5022a6" title="Set to true when this class is about to be destroyed.">exiting</a>) {
<a name="l01983"></a>01983         <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> == State::LEADER &amp;&amp; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aa6c06993ed2a50989b453f120cd31aea" title="Flag to indicate that leaderDiskThreadMain should flush recent log writes to stable storage...">logSyncQueued</a>) {
<a name="l01984"></a>01984             uint64_t term = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>;
<a name="l01985"></a>01985             std::unique_ptr&lt;Log::Sync&gt; sync = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;takeSync();
<a name="l01986"></a>01986             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aa6c06993ed2a50989b453f120cd31aea" title="Flag to indicate that leaderDiskThreadMain should flush recent log writes to stable storage...">logSyncQueued</a> = <span class="keyword">false</span>;
<a name="l01987"></a>01987             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a3f885e618c137506f3e0da0fdbe4b13d" title="Used for stepDown() to wait on leaderDiskThread without releasing mutex.">leaderDiskThreadWorking</a> = <span class="keyword">true</span>;
<a name="l01988"></a>01988             {
<a name="l01989"></a>01989                 <a class="code" href="classLogCabin_1_1Core_1_1MutexUnlock.html" title="Release a mutex upon construction, reacquires it upon destruction.">Core::MutexUnlock&lt;Mutex&gt;</a> unlockGuard(lockGuard);
<a name="l01990"></a>01990                 sync-&gt;wait();
<a name="l01991"></a>01991                 <span class="comment">// Mark this false before re-acquiring RaftConsensus lock,</span>
<a name="l01992"></a>01992                 <span class="comment">// since stepDown() polls on this to go false while holding the</span>
<a name="l01993"></a>01993                 <span class="comment">// lock.</span>
<a name="l01994"></a>01994                 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a3f885e618c137506f3e0da0fdbe4b13d" title="Used for stepDown() to wait on leaderDiskThread without releasing mutex.">leaderDiskThreadWorking</a> = <span class="keyword">false</span>;
<a name="l01995"></a>01995             }
<a name="l01996"></a>01996             <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> == State::LEADER &amp;&amp; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a> == term) {
<a name="l01997"></a>01997                 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;localServer-&gt;lastSyncedIndex = sync-&gt;lastIndex;
<a name="l01998"></a>01998                 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a6313bbd5c18d255db90131471985d80e" title="Move forward commitIndex if possible.">advanceCommitIndex</a>();
<a name="l01999"></a>01999             }
<a name="l02000"></a>02000             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;syncComplete(std::move(sync));
<a name="l02001"></a>02001             <span class="keywordflow">continue</span>;
<a name="l02002"></a>02002         }
<a name="l02003"></a>02003         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#aedc8162c9f0251ae3491e6bc6efbe477">wait</a>(lockGuard);
<a name="l02004"></a>02004     }
<a name="l02005"></a>02005 }
<a name="l02006"></a>02006 
<a name="l02007"></a>02007 <span class="keywordtype">void</span>
<a name="l02008"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a0c3b92e4cd0c94b84b00c21c77dad0b6">02008</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a0c3b92e4cd0c94b84b00c21c77dad0b6" title="Start new elections when it&#39;s time to do so.">RaftConsensus::timerThreadMain</a>()
<a name="l02009"></a>02009 {
<a name="l02010"></a>02010     std::unique_lock&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l02011"></a>02011     <a class="code" href="namespaceLogCabin_1_1Core_1_1ThreadId.html#a4dbe9da59e37b2a282c41984be0ebdcb" title="Set the friendly name for the current thread.">Core::ThreadId::setName</a>(<span class="stringliteral">&quot;startNewElection&quot;</span>);
<a name="l02012"></a>02012     <span class="keywordflow">while</span> (!<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a7f8cdeb3a67e3398cca54f23eb5022a6" title="Set to true when this class is about to be destroyed.">exiting</a>) {
<a name="l02013"></a>02013         <span class="keywordflow">if</span> (<a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a13f545c6020dd190e13d21e2577cc59b">Clock::now</a>() &gt;= <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a3528d66b8409ca51a4392d7c3f395d39" title="The earliest time at which timerThread should begin a new election with startNewElection().">startElectionAt</a>)
<a name="l02014"></a>02014             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2d9850882643fd6df30cf42e985258be" title="Transitions to being a candidate from being a follower or candidate.">startNewElection</a>();
<a name="l02015"></a>02015         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#ae6b4ac4d192b0efe25cfd5d7dd9a5558">wait_until</a>(lockGuard, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a3528d66b8409ca51a4392d7c3f395d39" title="The earliest time at which timerThread should begin a new election with startNewElection().">startElectionAt</a>);
<a name="l02016"></a>02016     }
<a name="l02017"></a>02017 }
<a name="l02018"></a>02018 
<a name="l02019"></a>02019 <span class="keywordtype">void</span>
<a name="l02020"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acb5c8d3c4f827cfb7f01ef4128f435a4">02020</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acb5c8d3c4f827cfb7f01ef4128f435a4" title="Initiate RPCs to a specific server as necessary.">RaftConsensus::peerThreadMain</a>(std::shared_ptr&lt;Peer&gt; peer)
<a name="l02021"></a>02021 {
<a name="l02022"></a>02022     std::unique_lock&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l02023"></a>02023     <a class="code" href="namespaceLogCabin_1_1Core_1_1ThreadId.html#a4dbe9da59e37b2a282c41984be0ebdcb" title="Set the friendly name for the current thread.">Core::ThreadId::setName</a>(
<a name="l02024"></a>02024         <a class="code" href="namespaceLogCabin_1_1Core_1_1StringUtil.html#a4b3972f4e603a7ba710374772b03c5c7" title="A safe version of sprintf.">Core::StringUtil::format</a>(<span class="stringliteral">&quot;Peer(%lu)&quot;</span>, peer-&gt;serverId));
<a name="l02025"></a>02025     <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Peer thread for server %lu started&quot;</span>, peer-&gt;serverId);
<a name="l02026"></a>02026 
<a name="l02027"></a>02027     <span class="comment">// Each iteration of this loop issues a new RPC or sleeps on the condition</span>
<a name="l02028"></a>02028     <span class="comment">// variable.</span>
<a name="l02029"></a>02029     <span class="keywordflow">while</span> (!peer-&gt;exiting) {
<a name="l02030"></a>02030         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#adadb64ccb66627454e6001aca18dc801">TimePoint</a> now = <a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a13f545c6020dd190e13d21e2577cc59b">Clock::now</a>();
<a name="l02031"></a>02031         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#adadb64ccb66627454e6001aca18dc801">TimePoint</a> waitUntil = TimePoint::min();
<a name="l02032"></a>02032 
<a name="l02033"></a>02033         <span class="keywordflow">if</span> (peer-&gt;backoffUntil &gt; now) {
<a name="l02034"></a>02034             waitUntil = peer-&gt;backoffUntil;
<a name="l02035"></a>02035         } <span class="keywordflow">else</span> {
<a name="l02036"></a>02036             <span class="keywordflow">switch</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a>) {
<a name="l02037"></a>02037                 <span class="comment">// Followers don&#39;t issue RPCs.</span>
<a name="l02038"></a>02038                 <span class="keywordflow">case</span> State::FOLLOWER:
<a name="l02039"></a>02039                     waitUntil = TimePoint::max();
<a name="l02040"></a>02040                     <span class="keywordflow">break</span>;
<a name="l02041"></a>02041 
<a name="l02042"></a>02042                 <span class="comment">// Candidates request votes.</span>
<a name="l02043"></a>02043                 <span class="keywordflow">case</span> State::CANDIDATE:
<a name="l02044"></a>02044                     <span class="keywordflow">if</span> (!peer-&gt;requestVoteDone)
<a name="l02045"></a>02045                         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5e86b884554e94732ba8b6445e0278c3" title="Send a RequestVote RPC to the server.">requestVote</a>(lockGuard, *peer);
<a name="l02046"></a>02046                     <span class="keywordflow">else</span>
<a name="l02047"></a>02047                         waitUntil = TimePoint::max();
<a name="l02048"></a>02048                     <span class="keywordflow">break</span>;
<a name="l02049"></a>02049 
<a name="l02050"></a>02050                 <span class="comment">// Leaders replicate entries and periodically send heartbeats.</span>
<a name="l02051"></a>02051                 <span class="keywordflow">case</span> State::LEADER:
<a name="l02052"></a>02052                     <span class="keywordflow">if</span> (peer-&gt;getLastAgreeIndex() &lt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex() ||
<a name="l02053"></a>02053                         peer-&gt;nextHeartbeatTime &lt; now) {
<a name="l02054"></a>02054                         <span class="comment">// appendEntries delegates to installSnapshot if we</span>
<a name="l02055"></a>02055                         <span class="comment">// need to send a snapshot instead</span>
<a name="l02056"></a>02056                         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a46bfac42c8d88437bf408de89878db10" title="Send an AppendEntries RPC to the server (either a heartbeat or containing an entry to replicate)...">appendEntries</a>(lockGuard, *peer);
<a name="l02057"></a>02057                     } <span class="keywordflow">else</span> {
<a name="l02058"></a>02058                         waitUntil = peer-&gt;nextHeartbeatTime;
<a name="l02059"></a>02059                     }
<a name="l02060"></a>02060                     <span class="keywordflow">break</span>;
<a name="l02061"></a>02061             }
<a name="l02062"></a>02062         }
<a name="l02063"></a>02063 
<a name="l02064"></a>02064         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#ae6b4ac4d192b0efe25cfd5d7dd9a5558">wait_until</a>(lockGuard, waitUntil);
<a name="l02065"></a>02065     }
<a name="l02066"></a>02066 
<a name="l02067"></a>02067     <span class="comment">// must return immediately after this</span>
<a name="l02068"></a>02068     --<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b784132bbc03e602f0a8233d6e570f" title="The number of Peer::thread threads that are still using this RaftConsensus object.">numPeerThreads</a>;
<a name="l02069"></a>02069     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#a66990e7e4f8fd459a7311ce86800e5e7">notify_all</a>();
<a name="l02070"></a>02070     <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Peer thread for server %lu exiting&quot;</span>, peer-&gt;serverId);
<a name="l02071"></a>02071 }
<a name="l02072"></a>02072 
<a name="l02073"></a>02073 <span class="keywordtype">void</span>
<a name="l02074"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a20e9e7e7e4f6d13a219cf1044db92857">02074</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a20e9e7e7e4f6d13a219cf1044db92857" title="Return to follower state when, as leader, this server is not able to communicate with a quorum...">RaftConsensus::stepDownThreadMain</a>()
<a name="l02075"></a>02075 {
<a name="l02076"></a>02076     std::unique_lock&lt;Mutex&gt; lockGuard(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a78f4be29e95800f2cdc37b7881383cee" title="This class behaves mostly like a monitor.">mutex</a>);
<a name="l02077"></a>02077     <a class="code" href="namespaceLogCabin_1_1Core_1_1ThreadId.html#a4dbe9da59e37b2a282c41984be0ebdcb" title="Set the friendly name for the current thread.">Core::ThreadId::setName</a>(<span class="stringliteral">&quot;stepDown&quot;</span>);
<a name="l02078"></a>02078     <span class="keywordflow">while</span> (<span class="keyword">true</span>) {
<a name="l02079"></a>02079         <span class="comment">// Wait until this server is the leader and is not the only server in</span>
<a name="l02080"></a>02080         <span class="comment">// the cluster.</span>
<a name="l02081"></a>02081         <span class="keywordflow">while</span> (<span class="keyword">true</span>) {
<a name="l02082"></a>02082             <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a7f8cdeb3a67e3398cca54f23eb5022a6" title="Set to true when this class is about to be destroyed.">exiting</a>)
<a name="l02083"></a>02083                 <span class="keywordflow">return</span>;
<a name="l02084"></a>02084             <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> == State::LEADER) {
<a name="l02085"></a>02085                 <span class="comment">// If this local server forms a quorum (it is the only server</span>
<a name="l02086"></a>02086                 <span class="comment">// in the configuration), we need to sleep. Without this guard,</span>
<a name="l02087"></a>02087                 <span class="comment">// this method would not relinquish the CPU.</span>
<a name="l02088"></a>02088                 ++<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1ab1473657769c339579f02f7e454513" title="A logical clock used to confirm leadership and connectivity.">currentEpoch</a>;
<a name="l02089"></a>02089                 <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;quorumMin(&amp;<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#a78554a4aaedbe99eca7dbb652b0ba355" title="Return the latest time this Server acknowledged our current term.">Server::getLastAckEpoch</a>) &lt;
<a name="l02090"></a>02090                     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1ab1473657769c339579f02f7e454513" title="A logical clock used to confirm leadership and connectivity.">currentEpoch</a>) {
<a name="l02091"></a>02091                     <span class="keywordflow">break</span>;
<a name="l02092"></a>02092                 }
<a name="l02093"></a>02093             }
<a name="l02094"></a>02094             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#aedc8162c9f0251ae3491e6bc6efbe477">wait</a>(lockGuard);
<a name="l02095"></a>02095         }
<a name="l02096"></a>02096         <span class="comment">// Now, if an election timeout goes by without confirming leadership,</span>
<a name="l02097"></a>02097         <span class="comment">// step down. The election timeout is a reasonable amount of time,</span>
<a name="l02098"></a>02098         <span class="comment">// since it&#39;s about when other servers will start elections and bump</span>
<a name="l02099"></a>02099         <span class="comment">// the term.</span>
<a name="l02100"></a>02100         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#adadb64ccb66627454e6001aca18dc801">TimePoint</a> stepDownAt =
<a name="l02101"></a>02101             <a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a13f545c6020dd190e13d21e2577cc59b">Clock::now</a>() + std::chrono::milliseconds(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5a76d9fce7cc8e8bd69bcf059b89ad93" title="A follower waits for about this much inactivity before becoming a candidate and starting a new electi...">ELECTION_TIMEOUT_MS</a>);
<a name="l02102"></a>02102         uint64_t term = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>;
<a name="l02103"></a>02103         uint64_t epoch = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1ab1473657769c339579f02f7e454513" title="A logical clock used to confirm leadership and connectivity.">currentEpoch</a>; <span class="comment">// currentEpoch was incremented above</span>
<a name="l02104"></a>02104         <span class="keywordflow">while</span> (<span class="keyword">true</span>) {
<a name="l02105"></a>02105             <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a7f8cdeb3a67e3398cca54f23eb5022a6" title="Set to true when this class is about to be destroyed.">exiting</a>)
<a name="l02106"></a>02106                 <span class="keywordflow">return</span>;
<a name="l02107"></a>02107             <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a> &gt; term)
<a name="l02108"></a>02108                 <span class="keywordflow">break</span>;
<a name="l02109"></a>02109             <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;quorumMin(&amp;<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#a78554a4aaedbe99eca7dbb652b0ba355" title="Return the latest time this Server acknowledged our current term.">Server::getLastAckEpoch</a>) &gt;= epoch)
<a name="l02110"></a>02110                 <span class="keywordflow">break</span>;
<a name="l02111"></a>02111             <span class="keywordflow">if</span> (<a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a13f545c6020dd190e13d21e2577cc59b">Clock::now</a>() &gt;= stepDownAt) {
<a name="l02112"></a>02112                 <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;No broadcast for a timeout, stepping down from leader &quot;</span>
<a name="l02113"></a>02113                        <span class="stringliteral">&quot;of term %lu (converting to follower in term %lu)&quot;</span>,
<a name="l02114"></a>02114                        <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a> + 1);
<a name="l02115"></a>02115                 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a284075bb503d0b8efb9c217a257dadc5" title="Transition to being a follower.">stepDown</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a> + 1);
<a name="l02116"></a>02116                 <span class="keywordflow">break</span>;
<a name="l02117"></a>02117             }
<a name="l02118"></a>02118             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#ae6b4ac4d192b0efe25cfd5d7dd9a5558">wait_until</a>(lockGuard, stepDownAt);
<a name="l02119"></a>02119         }
<a name="l02120"></a>02120     }
<a name="l02121"></a>02121 }
<a name="l02122"></a>02122 <span class="comment"></span>
<a name="l02123"></a>02123 <span class="comment">//// RaftConsensus private methods that MUST NOT acquire the lock</span>
<a name="l02124"></a>02124 <span class="comment"></span>
<a name="l02125"></a>02125 <span class="keywordtype">void</span>
<a name="l02126"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a6313bbd5c18d255db90131471985d80e">02126</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a6313bbd5c18d255db90131471985d80e" title="Move forward commitIndex if possible.">RaftConsensus::advanceCommitIndex</a>()
<a name="l02127"></a>02127 {
<a name="l02128"></a>02128     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> != State::LEADER) {
<a name="l02129"></a>02129         <span class="comment">// getLastAgreeIndex is undefined unless we&#39;re leader</span>
<a name="l02130"></a>02130         <a class="code" href="Core_2Debug_8h.html#ad51176fec84ca79bd96163c9cb5a7c32" title="Log a WARNING message.">WARNING</a>(<span class="stringliteral">&quot;advanceCommitIndex called as %s&quot;</span>,
<a name="l02131"></a>02131                 <a class="code" href="namespaceLogCabin_1_1Core_1_1StringUtil.html#ac524b54525b06c9cf044d38746e3d0f0" title="Return a string returned from the given object&#39;s stream operator.">Core::StringUtil::toString</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a>).c_str());
<a name="l02132"></a>02132         <span class="keywordflow">return</span>;
<a name="l02133"></a>02133     }
<a name="l02134"></a>02134 
<a name="l02135"></a>02135     <span class="comment">// calculate the largest entry ID stored on a quorum of servers</span>
<a name="l02136"></a>02136     uint64_t newCommitIndex =
<a name="l02137"></a>02137         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;quorumMin(&amp;<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#ab54a3a7c21b87f7d0b93babbbbc3d00a" title="Return the largest entry ID for which this Server is known to share the same entries up to and includ...">Server::getLastAgreeIndex</a>);
<a name="l02138"></a>02138     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a> &gt;= newCommitIndex)
<a name="l02139"></a>02139         <span class="keywordflow">return</span>;
<a name="l02140"></a>02140     <span class="comment">// If we have discarded the entry, it&#39;s because we already knew it was</span>
<a name="l02141"></a>02141     <span class="comment">// committed.</span>
<a name="l02142"></a>02142     assert(newCommitIndex &gt;= <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLogStartIndex());
<a name="l02143"></a>02143     <span class="comment">// At least one of these entries must also be from the current term to</span>
<a name="l02144"></a>02144     <span class="comment">// guarantee that no server without them can be elected.</span>
<a name="l02145"></a>02145     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getEntry(newCommitIndex).term() != <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>)
<a name="l02146"></a>02146         <span class="keywordflow">return</span>;
<a name="l02147"></a>02147     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a> = newCommitIndex;
<a name="l02148"></a>02148     <a class="code" href="Core_2Debug_8h.html#a77e5c931f41ca7e1792ddfa762d38473" title="Log a VERBOSE message.">VERBOSE</a>(<span class="stringliteral">&quot;New commitIndex: %lu&quot;</span>, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a>);
<a name="l02149"></a>02149     assert(commitIndex &lt;= log-&gt;getLastLogIndex());
<a name="l02150"></a>02150     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#a66990e7e4f8fd459a7311ce86800e5e7">notify_all</a>();
<a name="l02151"></a>02151 
<a name="l02152"></a>02152     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> == State::LEADER &amp;&amp; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a> &gt;= <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;id) {
<a name="l02153"></a>02153         <span class="comment">// Upon committing a configuration that excludes itself, the leader</span>
<a name="l02154"></a>02154         <span class="comment">// steps down.</span>
<a name="l02155"></a>02155         <span class="keywordflow">if</span> (!<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;hasVote(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;localServer)) {
<a name="l02156"></a>02156             <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Newly committed configuration does not include self. &quot;</span>
<a name="l02157"></a>02157                    <span class="stringliteral">&quot;Stepping down as leader&quot;</span>);
<a name="l02158"></a>02158             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a284075bb503d0b8efb9c217a257dadc5" title="Transition to being a follower.">stepDown</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a> + 1);
<a name="l02159"></a>02159             <span class="keywordflow">return</span>;
<a name="l02160"></a>02160         }
<a name="l02161"></a>02161 
<a name="l02162"></a>02162         <span class="comment">// Upon committing a reconfiguration (Cold,new) entry, the leader</span>
<a name="l02163"></a>02163         <span class="comment">// creates the next configuration (Cnew) entry.</span>
<a name="l02164"></a>02164         <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;state == Configuration::State::TRANSITIONAL) {
<a name="l02165"></a>02165             <a class="code" href="classLogCabin_1_1Storage_1_1Log.html#a8ca64ace5d6ae6f0175186c595d4fbe0" title="The type of a log entry (the same format that&#39;s used in AppendEntries).">Log::Entry</a> entry;
<a name="l02166"></a>02166             entry.set_term(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l02167"></a>02167             entry.set_type(Protocol::Raft::EntryType::CONFIGURATION);
<a name="l02168"></a>02168             entry.set_cluster_time(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aa525cfc8dac0abdc8f744f5bd75302ae" title="Tracks the passage of &quot;cluster time&quot;.">clusterClock</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#acfeeb3627de0308d4259324b78b7d84a" title="Called by leaders to generate a new cluster time for a new log entry.">leaderStamp</a>());
<a name="l02169"></a>02169             *entry.mutable_configuration()-&gt;mutable_prev_configuration() =
<a name="l02170"></a>02170                 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;description.next_configuration();
<a name="l02171"></a>02171             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aab0f5ebde52053a9de31a575093dc098" title="Append entries to the log, set the configuration if this contains a configuration entry...">append</a>({&amp;entry});
<a name="l02172"></a>02172             <span class="keywordflow">return</span>;
<a name="l02173"></a>02173         }
<a name="l02174"></a>02174     }
<a name="l02175"></a>02175 }
<a name="l02176"></a>02176 
<a name="l02177"></a>02177 <span class="keywordtype">void</span>
<a name="l02178"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aab0f5ebde52053a9de31a575093dc098">02178</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aab0f5ebde52053a9de31a575093dc098" title="Append entries to the log, set the configuration if this contains a configuration entry...">RaftConsensus::append</a>(<span class="keyword">const</span> std::vector&lt;const Log::Entry*&gt;&amp; entries)
<a name="l02179"></a>02179 {
<a name="l02180"></a>02180     <span class="keywordflow">for</span> (<span class="keyword">auto</span> it = entries.begin(); it != entries.end(); ++it)
<a name="l02181"></a>02181         assert((*it)-&gt;term() != 0);
<a name="l02182"></a>02182     std::pair&lt;uint64_t, uint64_t&gt; range = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;append(entries);
<a name="l02183"></a>02183     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> == State::LEADER) { <span class="comment">// defer log sync</span>
<a name="l02184"></a>02184         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aa6c06993ed2a50989b453f120cd31aea" title="Flag to indicate that leaderDiskThreadMain should flush recent log writes to stable storage...">logSyncQueued</a> = <span class="keyword">true</span>;
<a name="l02185"></a>02185     } <span class="keywordflow">else</span> { <span class="comment">// sync log now</span>
<a name="l02186"></a>02186         std::unique_ptr&lt;Log::Sync&gt; sync = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;takeSync();
<a name="l02187"></a>02187         sync-&gt;wait();
<a name="l02188"></a>02188         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;syncComplete(std::move(sync));
<a name="l02189"></a>02189     }
<a name="l02190"></a>02190     uint64_t index = range.first;
<a name="l02191"></a>02191     <span class="keywordflow">for</span> (<span class="keyword">auto</span> it = entries.begin(); it != entries.end(); ++it) {
<a name="l02192"></a>02192         <span class="keyword">const</span> <a class="code" href="classLogCabin_1_1Storage_1_1Log.html#a8ca64ace5d6ae6f0175186c595d4fbe0" title="The type of a log entry (the same format that&#39;s used in AppendEntries).">Log::Entry</a>&amp; entry = **it;
<a name="l02193"></a>02193         <span class="keywordflow">if</span> (entry.type() == Protocol::Raft::EntryType::CONFIGURATION)
<a name="l02194"></a>02194             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ade5bbdec3e8ff60b7931a2682b2bb4ef" title="Ensures that &#39;configuration&#39; reflects the latest state of the log and snapshot.">configurationManager</a>-&gt;add(index, entry.configuration());
<a name="l02195"></a>02195         ++index;
<a name="l02196"></a>02196     }
<a name="l02197"></a>02197     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#a66990e7e4f8fd459a7311ce86800e5e7">notify_all</a>();
<a name="l02198"></a>02198 }
<a name="l02199"></a>02199 
<a name="l02200"></a>02200 <span class="keywordtype">void</span>
<a name="l02201"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a46bfac42c8d88437bf408de89878db10">02201</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a46bfac42c8d88437bf408de89878db10" title="Send an AppendEntries RPC to the server (either a heartbeat or containing an entry to replicate)...">RaftConsensus::appendEntries</a>(std::unique_lock&lt;Mutex&gt;&amp; lockGuard,
<a name="l02202"></a>02202                              <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html" title="Represents another server in the cluster.">Peer</a>&amp; peer)
<a name="l02203"></a>02203 {
<a name="l02204"></a>02204     uint64_t lastLogIndex = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex();
<a name="l02205"></a>02205     uint64_t prevLogIndex = peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a681aed27116449b0ec7705e85f09fd07" title="The index of the next entry to send to the follower.">nextIndex</a> - 1;
<a name="l02206"></a>02206     assert(prevLogIndex &lt;= lastLogIndex);
<a name="l02207"></a>02207 
<a name="l02208"></a>02208     <span class="comment">// Don&#39;t have needed entry: send a snapshot instead.</span>
<a name="l02209"></a>02209     <span class="keywordflow">if</span> (peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a681aed27116449b0ec7705e85f09fd07" title="The index of the next entry to send to the follower.">nextIndex</a> &lt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLogStartIndex()) {
<a name="l02210"></a>02210         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a512cff0b8e9144edb6292590d53dc971" title="Send an InstallSnapshot RPC to the server (containing part of a snapshot file to replicate).">installSnapshot</a>(lockGuard, peer);
<a name="l02211"></a>02211         <span class="keywordflow">return</span>;
<a name="l02212"></a>02212     }
<a name="l02213"></a>02213 
<a name="l02214"></a>02214     <span class="comment">// Find prevLogTerm or fall back to sending a snapshot.</span>
<a name="l02215"></a>02215     uint64_t prevLogTerm;
<a name="l02216"></a>02216     <span class="keywordflow">if</span> (prevLogIndex &gt;= <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLogStartIndex()) {
<a name="l02217"></a>02217         prevLogTerm = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getEntry(prevLogIndex).term();
<a name="l02218"></a>02218     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (prevLogIndex == 0) {
<a name="l02219"></a>02219         prevLogTerm = 0;
<a name="l02220"></a>02220     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (prevLogIndex == <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>) {
<a name="l02221"></a>02221         prevLogTerm = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5f0c55552abd43fa5b1ffe779f70fcf9" title="The term of the last entry covered by the latest good snapshot, or 0 if we have no snapshot...">lastSnapshotTerm</a>;
<a name="l02222"></a>02222     } <span class="keywordflow">else</span> {
<a name="l02223"></a>02223         <span class="comment">// Don&#39;t have needed entry for prevLogTerm: send snapshot instead.</span>
<a name="l02224"></a>02224         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a512cff0b8e9144edb6292590d53dc971" title="Send an InstallSnapshot RPC to the server (containing part of a snapshot file to replicate).">installSnapshot</a>(lockGuard, peer);
<a name="l02225"></a>02225         <span class="keywordflow">return</span>;
<a name="l02226"></a>02226     }
<a name="l02227"></a>02227 
<a name="l02228"></a>02228     <span class="comment">// Build up request</span>
<a name="l02229"></a>02229     Protocol::Raft::AppendEntries::Request request;
<a name="l02230"></a>02230     request.set_server_id(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a32b5b6a4d6ae35dcd20c8ba3e7a95de0" title="This server&#39;s unique ID.">serverId</a>);
<a name="l02231"></a>02231     request.set_term(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l02232"></a>02232     request.set_prev_log_term(prevLogTerm);
<a name="l02233"></a>02233     request.set_prev_log_index(prevLogIndex);
<a name="l02234"></a>02234 
<a name="l02235"></a>02235     <span class="comment">// Add as many as entries as will fit comfortably in the request. It&#39;s</span>
<a name="l02236"></a>02236     <span class="comment">// easiest to add one entry at a time until the RPC gets too big, then back</span>
<a name="l02237"></a>02237     <span class="comment">// the last one out.</span>
<a name="l02238"></a>02238     uint64_t numEntries = 0;
<a name="l02239"></a>02239     <span class="keywordflow">if</span> (!peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a50d0b442ca40959e135e45107a8c6c76" title="Indicates that nextIndex is still a (poor) guess: the leader should send heartbeats to save bandwidth...">forceHeartbeat</a>) {
<a name="l02240"></a>02240         <span class="keywordflow">for</span> (uint64_t index = peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a681aed27116449b0ec7705e85f09fd07" title="The index of the next entry to send to the follower.">nextIndex</a>;
<a name="l02241"></a>02241              index &lt;= lastLogIndex;
<a name="l02242"></a>02242              ++index) {
<a name="l02243"></a>02243             <span class="keyword">const</span> <a class="code" href="classLogCabin_1_1Storage_1_1Log.html#a8ca64ace5d6ae6f0175186c595d4fbe0" title="The type of a log entry (the same format that&#39;s used in AppendEntries).">Log::Entry</a>&amp; entry = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getEntry(index);
<a name="l02244"></a>02244             *request.add_entries() = entry;
<a name="l02245"></a>02245             uint64_t requestSize =
<a name="l02246"></a>02246                 Core::Util::downCast&lt;uint64_t&gt;(request.ByteSize());
<a name="l02247"></a>02247             <span class="keywordflow">if</span> (requestSize &lt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a8b367b81c3af4957007d02ec2e136275" title="Prefer to keep RPC requests under this size.">SOFT_RPC_SIZE_LIMIT</a> || numEntries == 0) {
<a name="l02248"></a>02248                 <span class="comment">// this entry fits, send it</span>
<a name="l02249"></a>02249                 <a class="code" href="Core_2Debug_8h.html#a77e5c931f41ca7e1792ddfa762d38473" title="Log a VERBOSE message.">VERBOSE</a>(<span class="stringliteral">&quot;sending entry &lt;index=%lu,term=%lu&gt;&quot;</span>,
<a name="l02250"></a>02250                         index, entry.term());
<a name="l02251"></a>02251                 ++numEntries;
<a name="l02252"></a>02252             } <span class="keywordflow">else</span> {
<a name="l02253"></a>02253                 <span class="comment">// this entry doesn&#39;t fit, discard it</span>
<a name="l02254"></a>02254                 request.mutable_entries()-&gt;RemoveLast();
<a name="l02255"></a>02255                 <span class="keywordflow">break</span>;
<a name="l02256"></a>02256             }
<a name="l02257"></a>02257         }
<a name="l02258"></a>02258     }
<a name="l02259"></a>02259     request.set_commit_index(std::min(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a>, prevLogIndex + numEntries));
<a name="l02260"></a>02260 
<a name="l02261"></a>02261     <span class="comment">// Execute RPC</span>
<a name="l02262"></a>02262     Protocol::Raft::AppendEntries::Response response;
<a name="l02263"></a>02263     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#adadb64ccb66627454e6001aca18dc801">TimePoint</a> start = <a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a13f545c6020dd190e13d21e2577cc59b">Clock::now</a>();
<a name="l02264"></a>02264     uint64_t epoch = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1ab1473657769c339579f02f7e454513" title="A logical clock used to confirm leadership and connectivity.">currentEpoch</a>;
<a name="l02265"></a>02265     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a0548ee7eb046a903349a22ff0a3c7bda" title="Returned by callRPC().">Peer::CallStatus</a> status = peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a4305e63041b96ea33cb28deaf2378b1c" title="Execute a remote procedure call on the server&#39;s RaftService.">callRPC</a>(
<a name="l02266"></a>02266                 Protocol::Raft::OpCode::APPEND_ENTRIES,
<a name="l02267"></a>02267                 request, response,
<a name="l02268"></a>02268                 lockGuard);
<a name="l02269"></a>02269     <span class="keywordflow">switch</span> (status) {
<a name="l02270"></a>02270         <span class="keywordflow">case</span> <a class="code" href="namespaceLogCabin_1_1Client.html#a4326ade2a152c568b8a7b7daafadf9b4a7324f75352386fdbcd0e25d926866ad7" title="The operation completed successfully.">Peer::CallStatus::OK</a>:
<a name="l02271"></a>02271             <span class="keywordflow">break</span>;
<a name="l02272"></a>02272         <span class="keywordflow">case</span> Peer::CallStatus::FAILED:
<a name="l02273"></a>02273             peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a8b6511933a555747a4edf9e4cb9f385c" title="The minimum time at which the next RPC should be sent.">backoffUntil</a> = start +
<a name="l02274"></a>02274                 std::chrono::milliseconds(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a8c3ec432979e19052a70bd756ebd5689" title="A candidate or leader waits this long after an RPC fails before sending another one, so as to not overwhelm the network with retries.">RPC_FAILURE_BACKOFF_MS</a>);
<a name="l02275"></a>02275             <span class="keywordflow">return</span>;
<a name="l02276"></a>02276         <span class="keywordflow">case</span> <a class="code" href="namespaceLogCabin_1_1RPC_1_1Protocol.html#a85fb11a499988e97be6f566df469a694aff3e9fbb7614ab1714ea489e399f19ea" title="The server did not like the RPC request.">Peer::CallStatus::INVALID_REQUEST</a>:
<a name="l02277"></a>02277             <a class="code" href="Core_2Debug_8h.html#ad84b0f521394f4d9214c9d185711a8c3" title="Log an ERROR message and abort the process.">PANIC</a>(<span class="stringliteral">&quot;The server&#39;s RaftService doesn&#39;t support the AppendEntries &quot;</span>
<a name="l02278"></a>02278                   <span class="stringliteral">&quot;RPC or claims the request is malformed&quot;</span>);
<a name="l02279"></a>02279     }
<a name="l02280"></a>02280 
<a name="l02281"></a>02281     <span class="comment">// Process response</span>
<a name="l02282"></a>02282 
<a name="l02283"></a>02283     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a> != request.term() || peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#afcc06ccb9c33a32eee1503aa5b1ee205" title="Set to true when thread should exit.">exiting</a>) {
<a name="l02284"></a>02284         <span class="comment">// we don&#39;t care about result of RPC</span>
<a name="l02285"></a>02285         <span class="keywordflow">return</span>;
<a name="l02286"></a>02286     }
<a name="l02287"></a>02287     <span class="comment">// Since we were leader in this term before, we must still be leader in</span>
<a name="l02288"></a>02288     <span class="comment">// this term.</span>
<a name="l02289"></a>02289     assert(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> == State::LEADER);
<a name="l02290"></a>02290     <span class="keywordflow">if</span> (response.term() &gt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>) {
<a name="l02291"></a>02291         <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Received AppendEntries response from server %lu in term %lu &quot;</span>
<a name="l02292"></a>02292                <span class="stringliteral">&quot;(this server&#39;s term was %lu)&quot;</span>,
<a name="l02293"></a>02293                 peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#ac1b2d6d134b4c41baf0220a0c6e587b7" title="The ID of this server.">serverId</a>, response.term(), <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l02294"></a>02294         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a284075bb503d0b8efb9c217a257dadc5" title="Transition to being a follower.">stepDown</a>(response.term());
<a name="l02295"></a>02295     } <span class="keywordflow">else</span> {
<a name="l02296"></a>02296         assert(response.term() == <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l02297"></a>02297         peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a3ac99d0f0a94203643ac72cf4e4c0e69" title="See getLastAckEpoch().">lastAckEpoch</a> = epoch;
<a name="l02298"></a>02298         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#a66990e7e4f8fd459a7311ce86800e5e7">notify_all</a>();
<a name="l02299"></a>02299         peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#af3115d040af27bfe093f1881fd243716" title="When the next heartbeat should be sent to the follower.">nextHeartbeatTime</a> = start +
<a name="l02300"></a>02300             std::chrono::milliseconds(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a4b4eba8076afd37eb50b234346d491dc" title="A leader sends RPCs at least this often, even if there is no data to send.">HEARTBEAT_PERIOD_MS</a>);
<a name="l02301"></a>02301         <span class="keywordflow">if</span> (response.success()) {
<a name="l02302"></a>02302             <span class="keywordflow">if</span> (peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a2af3be3d3ac5cfb2c79270d084f01e21" title="See getLastAgreeIndex().">lastAgreeIndex</a> &gt; prevLogIndex + numEntries) {
<a name="l02303"></a>02303                 <span class="comment">// Revisit this warning if we pipeline AppendEntries RPCs for</span>
<a name="l02304"></a>02304                 <span class="comment">// performance.</span>
<a name="l02305"></a>02305                 <a class="code" href="Core_2Debug_8h.html#ad51176fec84ca79bd96163c9cb5a7c32" title="Log a WARNING message.">WARNING</a>(<span class="stringliteral">&quot;lastAgreeIndex should monotonically increase within a &quot;</span>
<a name="l02306"></a>02306                         <span class="stringliteral">&quot;term, since servers don&#39;t forget entries. But it &quot;</span>
<a name="l02307"></a>02307                         <span class="stringliteral">&quot;didn&#39;t.&quot;</span>);
<a name="l02308"></a>02308             } <span class="keywordflow">else</span> {
<a name="l02309"></a>02309                 peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a2af3be3d3ac5cfb2c79270d084f01e21" title="See getLastAgreeIndex().">lastAgreeIndex</a> = prevLogIndex + numEntries;
<a name="l02310"></a>02310                 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a6313bbd5c18d255db90131471985d80e" title="Move forward commitIndex if possible.">advanceCommitIndex</a>();
<a name="l02311"></a>02311             }
<a name="l02312"></a>02312             peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a681aed27116449b0ec7705e85f09fd07" title="The index of the next entry to send to the follower.">nextIndex</a> = peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a2af3be3d3ac5cfb2c79270d084f01e21" title="See getLastAgreeIndex().">lastAgreeIndex</a> + 1;
<a name="l02313"></a>02313             peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a50d0b442ca40959e135e45107a8c6c76" title="Indicates that nextIndex is still a (poor) guess: the leader should send heartbeats to save bandwidth...">forceHeartbeat</a> = <span class="keyword">false</span>;
<a name="l02314"></a>02314 
<a name="l02315"></a>02315             <span class="keywordflow">if</span> (!peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#aa35915b9016d63af612039b1eea9c9bf" title="See isCaughtUp().">isCaughtUp_</a> &amp;&amp;
<a name="l02316"></a>02316                 peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a0b1063ab72094143e3e1acdfb531b355">thisCatchUpIterationGoalId</a> &lt;= peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a2af3be3d3ac5cfb2c79270d084f01e21" title="See getLastAgreeIndex().">lastAgreeIndex</a>) {
<a name="l02317"></a>02317                 <a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a47b51df2c5844d317d1fb74b4723e4f4">Clock::duration</a> duration =
<a name="l02318"></a>02318                     <a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a13f545c6020dd190e13d21e2577cc59b">Clock::now</a>() - peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#aee6a46284ffbb597bdaaf4171cca5b6a">thisCatchUpIterationStart</a>;
<a name="l02319"></a>02319                 uint64_t thisCatchUpIterationMs =
<a name="l02320"></a>02320                     uint64_t(std::chrono::duration_cast&lt;
<a name="l02321"></a>02321                                  std::chrono::milliseconds&gt;(duration).count());
<a name="l02322"></a>02322                 <span class="keywordflow">if</span> (uint64_t(labs(int64_t(peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#aa278a1b1f4db199d22db2077dab0bd1f">lastCatchUpIterationMs</a> -
<a name="l02323"></a>02323                                           thisCatchUpIterationMs))) &lt;
<a name="l02324"></a>02324                     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5a76d9fce7cc8e8bd69bcf059b89ad93" title="A follower waits for about this much inactivity before becoming a candidate and starting a new electi...">ELECTION_TIMEOUT_MS</a>) {
<a name="l02325"></a>02325                     peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#aa35915b9016d63af612039b1eea9c9bf" title="See isCaughtUp().">isCaughtUp_</a> = <span class="keyword">true</span>;
<a name="l02326"></a>02326                     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#a66990e7e4f8fd459a7311ce86800e5e7">notify_all</a>();
<a name="l02327"></a>02327                 } <span class="keywordflow">else</span> {
<a name="l02328"></a>02328                     peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#aa278a1b1f4db199d22db2077dab0bd1f">lastCatchUpIterationMs</a> = thisCatchUpIterationMs;
<a name="l02329"></a>02329                     peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#aee6a46284ffbb597bdaaf4171cca5b6a">thisCatchUpIterationStart</a> = <a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a13f545c6020dd190e13d21e2577cc59b">Clock::now</a>();
<a name="l02330"></a>02330                     peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a0b1063ab72094143e3e1acdfb531b355">thisCatchUpIterationGoalId</a> = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex();
<a name="l02331"></a>02331                 }
<a name="l02332"></a>02332             }
<a name="l02333"></a>02333         } <span class="keywordflow">else</span> {
<a name="l02334"></a>02334             <span class="keywordflow">if</span> (peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a681aed27116449b0ec7705e85f09fd07" title="The index of the next entry to send to the follower.">nextIndex</a> &gt; 1)
<a name="l02335"></a>02335                 --peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a681aed27116449b0ec7705e85f09fd07" title="The index of the next entry to send to the follower.">nextIndex</a>;
<a name="l02336"></a>02336         }
<a name="l02337"></a>02337     }
<a name="l02338"></a>02338     <span class="keywordflow">if</span> (response.has_server_capabilities()) {
<a name="l02339"></a>02339         <span class="keyword">auto</span>&amp; cap = response.server_capabilities();
<a name="l02340"></a>02340         <span class="keywordflow">if</span> (cap.has_min_supported_state_machine_version() &amp;&amp;
<a name="l02341"></a>02341             cap.has_max_supported_state_machine_version()) {
<a name="l02342"></a>02342             peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#acf7e796648da3e5bb1d6b87113c8bcda" title="If true, minStateMachineVersion and maxStateMachineVersion are set (although they may be stale)...">haveStateMachineSupportedVersions</a> = <span class="keyword">true</span>;
<a name="l02343"></a>02343             peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#ab2ea7f59738fe606d01cb56d35a7cb33" title="If haveStateMachineSupportedVersions is true, the smallest version of the state machine commands/beha...">minStateMachineVersion</a> = Core::Util::downCast&lt;uint16_t&gt;(
<a name="l02344"></a>02344                 cap.min_supported_state_machine_version());
<a name="l02345"></a>02345             peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#ad5d9ff4a22e88377e55b65d136f46f71" title="If haveStateMachineSupportedVersions is true, the largest version of the state machine commands/behav...">maxStateMachineVersion</a> = Core::Util::downCast&lt;uint16_t&gt;(
<a name="l02346"></a>02346                 cap.max_supported_state_machine_version());
<a name="l02347"></a>02347             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#a66990e7e4f8fd459a7311ce86800e5e7">notify_all</a>();
<a name="l02348"></a>02348         }
<a name="l02349"></a>02349     }
<a name="l02350"></a>02350 }
<a name="l02351"></a>02351 
<a name="l02352"></a>02352 <span class="keywordtype">void</span>
<a name="l02353"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a512cff0b8e9144edb6292590d53dc971">02353</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a512cff0b8e9144edb6292590d53dc971" title="Send an InstallSnapshot RPC to the server (containing part of a snapshot file to replicate).">RaftConsensus::installSnapshot</a>(std::unique_lock&lt;Mutex&gt;&amp; lockGuard,
<a name="l02354"></a>02354                                <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html" title="Represents another server in the cluster.">Peer</a>&amp; peer)
<a name="l02355"></a>02355 {
<a name="l02356"></a>02356     <span class="comment">// Build up request</span>
<a name="l02357"></a>02357     Protocol::Raft::InstallSnapshot::Request request;
<a name="l02358"></a>02358     request.set_server_id(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a32b5b6a4d6ae35dcd20c8ba3e7a95de0" title="This server&#39;s unique ID.">serverId</a>);
<a name="l02359"></a>02359     request.set_term(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l02360"></a>02360 
<a name="l02361"></a>02361     <span class="comment">// Open the latest snapshot if we haven&#39;t already. Stash a copy of the</span>
<a name="l02362"></a>02362     <span class="comment">// lastSnapshotIndex that goes along with the file, since it&#39;s possible</span>
<a name="l02363"></a>02363     <span class="comment">// that this will change while we&#39;re transferring chunks).</span>
<a name="l02364"></a>02364     <span class="keywordflow">if</span> (!peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#ad26b3c377e98b3ae5f0818b7b76908fd" title="A snapshot file to be sent to the follower, or NULL.">snapshotFile</a>) {
<a name="l02365"></a>02365         <span class="keyword">namespace </span>FS = Storage::FilesystemUtil;
<a name="l02366"></a>02366         peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#ad26b3c377e98b3ae5f0818b7b76908fd" title="A snapshot file to be sent to the follower, or NULL.">snapshotFile</a>.reset(<span class="keyword">new</span> <a class="code" href="classLogCabin_1_1Storage_1_1FilesystemUtil_1_1FileContents.html" title="Provides random access to a file.">FS::FileContents</a>(
<a name="l02367"></a>02367             <a class="code" href="namespaceLogCabin_1_1Storage_1_1FilesystemUtil.html#a1efbe54769377f1a078a38ae9513a260" title="Open a file.">FS::openFile</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a6bed133d4a5b6e69399b1dbc44f7f483" title="Where the files for the log and snapshots are stored.">storageLayout</a>.<a class="code" href="classLogCabin_1_1Storage_1_1Layout.html#a8dc98b30f53f5468d051623f04207aed" title="Contains all snapshot files for this particular server.">snapshotDir</a>, <span class="stringliteral">&quot;snapshot&quot;</span>, O_RDONLY)));
<a name="l02368"></a>02368         peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a71e8fe01080a5c648184fcada409c56a" title="The number of bytes of &#39;snapshotFile&#39; that have been acknowledged by the follower already...">snapshotFileOffset</a> = 0;
<a name="l02369"></a>02369         peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a4a814e3469c1609f999488037a01087c" title="The last log index that &#39;snapshotFile&#39; corresponds to.">lastSnapshotIndex</a> = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>;
<a name="l02370"></a>02370     }
<a name="l02371"></a>02371     request.set_last_snapshot_index(peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a4a814e3469c1609f999488037a01087c" title="The last log index that &#39;snapshotFile&#39; corresponds to.">lastSnapshotIndex</a>);
<a name="l02372"></a>02372     request.set_byte_offset(peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a71e8fe01080a5c648184fcada409c56a" title="The number of bytes of &#39;snapshotFile&#39; that have been acknowledged by the follower already...">snapshotFileOffset</a>);
<a name="l02373"></a>02373     <span class="comment">// The amount of data we can send is bounded by the remaining bytes in the</span>
<a name="l02374"></a>02374     <span class="comment">// file and the maximum length for RPCs.</span>
<a name="l02375"></a>02375     uint64_t numDataBytes = std::min(
<a name="l02376"></a>02376         peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#ad26b3c377e98b3ae5f0818b7b76908fd" title="A snapshot file to be sent to the follower, or NULL.">snapshotFile</a>-&gt;getFileLength() - peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a71e8fe01080a5c648184fcada409c56a" title="The number of bytes of &#39;snapshotFile&#39; that have been acknowledged by the follower already...">snapshotFileOffset</a>,
<a name="l02377"></a>02377         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a8b367b81c3af4957007d02ec2e136275" title="Prefer to keep RPC requests under this size.">SOFT_RPC_SIZE_LIMIT</a>);
<a name="l02378"></a>02378     request.set_data(peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#ad26b3c377e98b3ae5f0818b7b76908fd" title="A snapshot file to be sent to the follower, or NULL.">snapshotFile</a>-&gt;get&lt;<span class="keywordtype">char</span>&gt;(peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a71e8fe01080a5c648184fcada409c56a" title="The number of bytes of &#39;snapshotFile&#39; that have been acknowledged by the follower already...">snapshotFileOffset</a>,
<a name="l02379"></a>02379                                                   numDataBytes),
<a name="l02380"></a>02380                      numDataBytes);
<a name="l02381"></a>02381     request.set_done(peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a71e8fe01080a5c648184fcada409c56a" title="The number of bytes of &#39;snapshotFile&#39; that have been acknowledged by the follower already...">snapshotFileOffset</a> + numDataBytes ==
<a name="l02382"></a>02382                      peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#ad26b3c377e98b3ae5f0818b7b76908fd" title="A snapshot file to be sent to the follower, or NULL.">snapshotFile</a>-&gt;getFileLength());
<a name="l02383"></a>02383 
<a name="l02384"></a>02384     <span class="comment">// Execute RPC</span>
<a name="l02385"></a>02385     Protocol::Raft::InstallSnapshot::Response response;
<a name="l02386"></a>02386     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#adadb64ccb66627454e6001aca18dc801">TimePoint</a> start = <a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a13f545c6020dd190e13d21e2577cc59b">Clock::now</a>();
<a name="l02387"></a>02387     uint64_t epoch = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1ab1473657769c339579f02f7e454513" title="A logical clock used to confirm leadership and connectivity.">currentEpoch</a>;
<a name="l02388"></a>02388     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a0548ee7eb046a903349a22ff0a3c7bda" title="Returned by callRPC().">Peer::CallStatus</a> status = peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a4305e63041b96ea33cb28deaf2378b1c" title="Execute a remote procedure call on the server&#39;s RaftService.">callRPC</a>(
<a name="l02389"></a>02389                 Protocol::Raft::OpCode::INSTALL_SNAPSHOT,
<a name="l02390"></a>02390                 request, response,
<a name="l02391"></a>02391                 lockGuard);
<a name="l02392"></a>02392     <span class="keywordflow">switch</span> (status) {
<a name="l02393"></a>02393         <span class="keywordflow">case</span> <a class="code" href="namespaceLogCabin_1_1Client.html#a4326ade2a152c568b8a7b7daafadf9b4a7324f75352386fdbcd0e25d926866ad7" title="The operation completed successfully.">Peer::CallStatus::OK</a>:
<a name="l02394"></a>02394             <span class="keywordflow">break</span>;
<a name="l02395"></a>02395         <span class="keywordflow">case</span> Peer::CallStatus::FAILED:
<a name="l02396"></a>02396             peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a8b6511933a555747a4edf9e4cb9f385c" title="The minimum time at which the next RPC should be sent.">backoffUntil</a> = start +
<a name="l02397"></a>02397                 std::chrono::milliseconds(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a8c3ec432979e19052a70bd756ebd5689" title="A candidate or leader waits this long after an RPC fails before sending another one, so as to not overwhelm the network with retries.">RPC_FAILURE_BACKOFF_MS</a>);
<a name="l02398"></a>02398             <span class="keywordflow">return</span>;
<a name="l02399"></a>02399         <span class="keywordflow">case</span> <a class="code" href="namespaceLogCabin_1_1RPC_1_1Protocol.html#a85fb11a499988e97be6f566df469a694aff3e9fbb7614ab1714ea489e399f19ea" title="The server did not like the RPC request.">Peer::CallStatus::INVALID_REQUEST</a>:
<a name="l02400"></a>02400             <a class="code" href="Core_2Debug_8h.html#ad84b0f521394f4d9214c9d185711a8c3" title="Log an ERROR message and abort the process.">PANIC</a>(<span class="stringliteral">&quot;The server&#39;s RaftService doesn&#39;t support the &quot;</span>
<a name="l02401"></a>02401                   <span class="stringliteral">&quot;InstallSnapshot RPC or claims the request is malformed&quot;</span>);
<a name="l02402"></a>02402     }
<a name="l02403"></a>02403 
<a name="l02404"></a>02404     <span class="comment">// Process response</span>
<a name="l02405"></a>02405 
<a name="l02406"></a>02406     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a> != request.term() || peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#afcc06ccb9c33a32eee1503aa5b1ee205" title="Set to true when thread should exit.">exiting</a>) {
<a name="l02407"></a>02407         <span class="comment">// we don&#39;t care about result of RPC</span>
<a name="l02408"></a>02408         <span class="keywordflow">return</span>;
<a name="l02409"></a>02409     }
<a name="l02410"></a>02410     <span class="comment">// Since we were leader in this term before, we must still be leader in</span>
<a name="l02411"></a>02411     <span class="comment">// this term.</span>
<a name="l02412"></a>02412     assert(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> == State::LEADER);
<a name="l02413"></a>02413     <span class="keywordflow">if</span> (response.term() &gt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>) {
<a name="l02414"></a>02414         <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Received InstallSnapshot response from server %lu in &quot;</span>
<a name="l02415"></a>02415                <span class="stringliteral">&quot;term %lu (this server&#39;s term was %lu)&quot;</span>,
<a name="l02416"></a>02416                 peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#ac1b2d6d134b4c41baf0220a0c6e587b7" title="The ID of this server.">serverId</a>, response.term(), <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l02417"></a>02417         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a284075bb503d0b8efb9c217a257dadc5" title="Transition to being a follower.">stepDown</a>(response.term());
<a name="l02418"></a>02418     } <span class="keywordflow">else</span> {
<a name="l02419"></a>02419         assert(response.term() == <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l02420"></a>02420         peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a3ac99d0f0a94203643ac72cf4e4c0e69" title="See getLastAckEpoch().">lastAckEpoch</a> = epoch;
<a name="l02421"></a>02421         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#a66990e7e4f8fd459a7311ce86800e5e7">notify_all</a>();
<a name="l02422"></a>02422         peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#af3115d040af27bfe093f1881fd243716" title="When the next heartbeat should be sent to the follower.">nextHeartbeatTime</a> = start +
<a name="l02423"></a>02423             std::chrono::milliseconds(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a4b4eba8076afd37eb50b234346d491dc" title="A leader sends RPCs at least this often, even if there is no data to send.">HEARTBEAT_PERIOD_MS</a>);
<a name="l02424"></a>02424         peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a71e8fe01080a5c648184fcada409c56a" title="The number of bytes of &#39;snapshotFile&#39; that have been acknowledged by the follower already...">snapshotFileOffset</a> += numDataBytes;
<a name="l02425"></a>02425         <span class="keywordflow">if</span> (request.done()) {
<a name="l02426"></a>02426             peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a2af3be3d3ac5cfb2c79270d084f01e21" title="See getLastAgreeIndex().">lastAgreeIndex</a> = peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a4a814e3469c1609f999488037a01087c" title="The last log index that &#39;snapshotFile&#39; corresponds to.">lastSnapshotIndex</a>;
<a name="l02427"></a>02427             peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a681aed27116449b0ec7705e85f09fd07" title="The index of the next entry to send to the follower.">nextIndex</a> = peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a4a814e3469c1609f999488037a01087c" title="The last log index that &#39;snapshotFile&#39; corresponds to.">lastSnapshotIndex</a> + 1;
<a name="l02428"></a>02428             <span class="comment">// These entries are already committed if they&#39;re in a snapshot, so</span>
<a name="l02429"></a>02429             <span class="comment">// the commitIndex shouldn&#39;t advance, but let&#39;s just follow the</span>
<a name="l02430"></a>02430             <span class="comment">// simple rule that bumping lastAgreeIndex should always be</span>
<a name="l02431"></a>02431             <span class="comment">// followed by a call to advanceCommitIndex():</span>
<a name="l02432"></a>02432             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a6313bbd5c18d255db90131471985d80e" title="Move forward commitIndex if possible.">advanceCommitIndex</a>();
<a name="l02433"></a>02433             peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#ad26b3c377e98b3ae5f0818b7b76908fd" title="A snapshot file to be sent to the follower, or NULL.">snapshotFile</a>.reset();
<a name="l02434"></a>02434             peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a71e8fe01080a5c648184fcada409c56a" title="The number of bytes of &#39;snapshotFile&#39; that have been acknowledged by the follower already...">snapshotFileOffset</a> = 0;
<a name="l02435"></a>02435             peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a4a814e3469c1609f999488037a01087c" title="The last log index that &#39;snapshotFile&#39; corresponds to.">lastSnapshotIndex</a> = 0;
<a name="l02436"></a>02436         }
<a name="l02437"></a>02437     }
<a name="l02438"></a>02438 }
<a name="l02439"></a>02439 
<a name="l02440"></a>02440 <span class="keywordtype">void</span>
<a name="l02441"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a98f5665fc16c382da7a161d9c62b420c">02441</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a98f5665fc16c382da7a161d9c62b420c" title="Transition to being a leader.">RaftConsensus::becomeLeader</a>()
<a name="l02442"></a>02442 {
<a name="l02443"></a>02443     assert(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> == State::CANDIDATE);
<a name="l02444"></a>02444     <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Now leader for term %lu (appending no-op at index %lu)&quot;</span>,
<a name="l02445"></a>02445            <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>,
<a name="l02446"></a>02446            <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex() + 1);
<a name="l02447"></a>02447     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a8a1270561380477170b6c7447705d74fad70e6b07fbd29d986eab46c28b816819" title="A leader sends AppendEntries RPCs to replicate its log onto followers.">State::LEADER</a>;
<a name="l02448"></a>02448     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae3f2b58c62af497eb474046566656f67" title="The server ID of the leader for this term.">leaderId</a> = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a32b5b6a4d6ae35dcd20c8ba3e7a95de0" title="This server&#39;s unique ID.">serverId</a>;
<a name="l02449"></a>02449     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acfe558f9de36a467f22e24dbb07b38fd" title="Dumps serverId, currentTerm, state, leaderId, and votedFor to the debug log.">printElectionState</a>();
<a name="l02450"></a>02450     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a3528d66b8409ca51a4392d7c3f395d39" title="The earliest time at which timerThread should begin a new election with startNewElection().">startElectionAt</a> = TimePoint::max();
<a name="l02451"></a>02451     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a075b1f3174db6673435f31622c231d02" title="The earliest time at which RequestVote messages should be processed.">withholdVotesUntil</a> = TimePoint::max();
<a name="l02452"></a>02452 
<a name="l02453"></a>02453     <span class="comment">// Our local cluster time clock has been ticking ever since we got the last</span>
<a name="l02454"></a>02454     <span class="comment">// log entry/snapshot. Set the clock back to when that happened, since we</span>
<a name="l02455"></a>02455     <span class="comment">// don&#39;t really want to count that time (the cluster probably had no leader</span>
<a name="l02456"></a>02456     <span class="comment">// for most of it).</span>
<a name="l02457"></a>02457     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aa525cfc8dac0abdc8f744f5bd75302ae" title="Tracks the passage of &quot;cluster time&quot;.">clusterClock</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#ad5adb9f0618aeb7a7a55e1524849a8bc" title="Reset to the given cluster time, assuming it&#39;s the current time right now.">newEpoch</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aa525cfc8dac0abdc8f744f5bd75302ae" title="Tracks the passage of &quot;cluster time&quot;.">clusterClock</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#a9d1de557c99f1ad6b3b175f9d4838983" title="Invariant: this is equal to the cluster time in:">clusterTimeAtEpoch</a>);
<a name="l02458"></a>02458 
<a name="l02459"></a>02459     <span class="comment">// The ordering is pretty important here: First set nextIndex and</span>
<a name="l02460"></a>02460     <span class="comment">// lastAgreeIndex for ourselves and each follower, then append the no op.</span>
<a name="l02461"></a>02461     <span class="comment">// Otherwise we&#39;ll set our localServer&#39;s last agree index too high.</span>
<a name="l02462"></a>02462     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;forEach(&amp;<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#ad03f113b797b25406325dde9bcf78fb2" title="Begin replicating to the Server in the current term.">Server::beginLeadership</a>);
<a name="l02463"></a>02463 
<a name="l02464"></a>02464     <span class="comment">// Append a new entry so that commitment is not delayed indefinitely.</span>
<a name="l02465"></a>02465     <span class="comment">// Otherwise, if the leader never gets anything to append, it will never</span>
<a name="l02466"></a>02466     <span class="comment">// return to read-only operations (it can&#39;t prove that its committed index</span>
<a name="l02467"></a>02467     <span class="comment">// is up-to-date).</span>
<a name="l02468"></a>02468     <a class="code" href="classLogCabin_1_1Storage_1_1Log.html#a8ca64ace5d6ae6f0175186c595d4fbe0" title="The type of a log entry (the same format that&#39;s used in AppendEntries).">Log::Entry</a> entry;
<a name="l02469"></a>02469     entry.set_term(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l02470"></a>02470     entry.set_type(Protocol::Raft::EntryType::NOOP);
<a name="l02471"></a>02471     entry.set_cluster_time(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aa525cfc8dac0abdc8f744f5bd75302ae" title="Tracks the passage of &quot;cluster time&quot;.">clusterClock</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#acfeeb3627de0308d4259324b78b7d84a" title="Called by leaders to generate a new cluster time for a new log entry.">leaderStamp</a>());
<a name="l02472"></a>02472     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aab0f5ebde52053a9de31a575093dc098" title="Append entries to the log, set the configuration if this contains a configuration entry...">append</a>({&amp;entry});
<a name="l02473"></a>02473 
<a name="l02474"></a>02474     <span class="comment">// Outstanding RequestVote RPCs are no longer needed.</span>
<a name="l02475"></a>02475     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae59f81b29757ea16583034c975e952cf" title="Notify the stateChanged condition variable and cancel all current RPCs.">interruptAll</a>();
<a name="l02476"></a>02476 }
<a name="l02477"></a>02477 
<a name="l02478"></a>02478 <span class="keywordtype">void</span>
<a name="l02479"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#af98ae4ff770b37572783ee33946fb0b7">02479</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#af98ae4ff770b37572783ee33946fb0b7" title="Remove the prefix of the log that is redundant with this server&#39;s snapshot.">RaftConsensus::discardUnneededEntries</a>()
<a name="l02480"></a>02480 {
<a name="l02481"></a>02481     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLogStartIndex() &lt;= <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>) {
<a name="l02482"></a>02482         <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Removing log entries through %lu (inclusive) since &quot;</span>
<a name="l02483"></a>02483                <span class="stringliteral">&quot;they&#39;re no longer needed&quot;</span>, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>);
<a name="l02484"></a>02484         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;truncatePrefix(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a> + 1);
<a name="l02485"></a>02485         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ade5bbdec3e8ff60b7931a2682b2bb4ef" title="Ensures that &#39;configuration&#39; reflects the latest state of the log and snapshot.">configurationManager</a>-&gt;truncatePrefix(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a> + 1);
<a name="l02486"></a>02486         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#a66990e7e4f8fd459a7311ce86800e5e7">notify_all</a>();
<a name="l02487"></a>02487         <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> == State::LEADER) { <span class="comment">// defer log sync</span>
<a name="l02488"></a>02488             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aa6c06993ed2a50989b453f120cd31aea" title="Flag to indicate that leaderDiskThreadMain should flush recent log writes to stable storage...">logSyncQueued</a> = <span class="keyword">true</span>;
<a name="l02489"></a>02489         } <span class="keywordflow">else</span> { <span class="comment">// sync log now</span>
<a name="l02490"></a>02490             std::unique_ptr&lt;Log::Sync&gt; sync = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;takeSync();
<a name="l02491"></a>02491             sync-&gt;wait();
<a name="l02492"></a>02492             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;syncComplete(std::move(sync));
<a name="l02493"></a>02493         }
<a name="l02494"></a>02494     }
<a name="l02495"></a>02495 }
<a name="l02496"></a>02496 
<a name="l02497"></a>02497 uint64_t
<a name="l02498"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ab66363f61f7c6b5dbd298da6d594cca7">02498</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ab66363f61f7c6b5dbd298da6d594cca7" title="Return the term corresponding to log-&gt;getLastLogIndex().">RaftConsensus::getLastLogTerm</a>()<span class="keyword"> const</span>
<a name="l02499"></a>02499 <span class="keyword"></span>{
<a name="l02500"></a>02500     uint64_t lastLogIndex = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex();
<a name="l02501"></a>02501     <span class="keywordflow">if</span> (lastLogIndex &gt;= <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLogStartIndex()) {
<a name="l02502"></a>02502         <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getEntry(lastLogIndex).term();
<a name="l02503"></a>02503     } <span class="keywordflow">else</span> {
<a name="l02504"></a>02504         assert(lastLogIndex == <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>); <span class="comment">// potentially 0</span>
<a name="l02505"></a>02505         <span class="keywordflow">return</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5f0c55552abd43fa5b1ffe779f70fcf9" title="The term of the last entry covered by the latest good snapshot, or 0 if we have no snapshot...">lastSnapshotTerm</a>;
<a name="l02506"></a>02506     }
<a name="l02507"></a>02507 }
<a name="l02508"></a>02508 
<a name="l02509"></a>02509 <span class="keywordtype">void</span>
<a name="l02510"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae59f81b29757ea16583034c975e952cf">02510</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae59f81b29757ea16583034c975e952cf" title="Notify the stateChanged condition variable and cancel all current RPCs.">RaftConsensus::interruptAll</a>()
<a name="l02511"></a>02511 {
<a name="l02512"></a>02512     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#a66990e7e4f8fd459a7311ce86800e5e7">notify_all</a>();
<a name="l02513"></a>02513     <span class="comment">// A configuration is sometimes missing for unit tests.</span>
<a name="l02514"></a>02514     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>)
<a name="l02515"></a>02515         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;forEach(&amp;<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#af56e0aa8cbf6377047a1737c461e84e9" title="Cancel any outstanding RPCs to this Server.">Server::interrupt</a>);
<a name="l02516"></a>02516 }
<a name="l02517"></a>02517 
<a name="l02518"></a>02518 <span class="keywordtype">void</span>
<a name="l02519"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#adcbc3efddd798b87c1a659b2cf9ffd4c">02519</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#adcbc3efddd798b87c1a659b2cf9ffd4c" title="Try to read the latest good snapshot from disk.">RaftConsensus::readSnapshot</a>()
<a name="l02520"></a>02520 {
<a name="l02521"></a>02521     std::unique_ptr&lt;Storage::SnapshotFile::Reader&gt; reader;
<a name="l02522"></a>02522     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a6bed133d4a5b6e69399b1dbc44f7f483" title="Where the files for the log and snapshots are stored.">storageLayout</a>.<a class="code" href="classLogCabin_1_1Storage_1_1Layout.html#a7647c7b9c614df4aa5c5e1561dc6ad92" title="Contains all files for this particular server.">serverDir</a>.<a class="code" href="classLogCabin_1_1Storage_1_1FilesystemUtil_1_1File.html#ad90bd1b9eeb500e3edccfa8eef8fb092" title="The open file descriptor, or -1 otherwise.">fd</a> != -1) {
<a name="l02523"></a>02523         <span class="keywordflow">try</span> {
<a name="l02524"></a>02524             reader.reset(<span class="keyword">new</span> <a class="code" href="classLogCabin_1_1Storage_1_1SnapshotFile_1_1Reader.html" title="Assists in reading snapshot files from the local filesystem.">Storage::SnapshotFile::Reader</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a6bed133d4a5b6e69399b1dbc44f7f483" title="Where the files for the log and snapshots are stored.">storageLayout</a>));
<a name="l02525"></a>02525         } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::runtime_error&amp; e) { <span class="comment">// file not found</span>
<a name="l02526"></a>02526             <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;%s&quot;</span>, e.what());
<a name="l02527"></a>02527         }
<a name="l02528"></a>02528     }
<a name="l02529"></a>02529     <span class="keywordflow">if</span> (reader) {
<a name="l02530"></a>02530         <span class="comment">// Check that this snapshot uses format version 1</span>
<a name="l02531"></a>02531         uint8_t version = 0;
<a name="l02532"></a>02532         uint64_t bytesRead = reader-&gt;readRaw(&amp;version, <span class="keyword">sizeof</span>(version));
<a name="l02533"></a>02533         <span class="keywordflow">if</span> (bytesRead &lt; 1) {
<a name="l02534"></a>02534             <a class="code" href="Core_2Debug_8h.html#ad84b0f521394f4d9214c9d185711a8c3" title="Log an ERROR message and abort the process.">PANIC</a>(<span class="stringliteral">&quot;Found completely empty snapshot file (it doesn&#39;t even &quot;</span>
<a name="l02535"></a>02535                   <span class="stringliteral">&quot;have a version field)&quot;</span>);
<a name="l02536"></a>02536         } <span class="keywordflow">else</span> {
<a name="l02537"></a>02537             <span class="keywordflow">if</span> (version != 1) {
<a name="l02538"></a>02538                 <a class="code" href="Core_2Debug_8h.html#ad84b0f521394f4d9214c9d185711a8c3" title="Log an ERROR message and abort the process.">PANIC</a>(<span class="stringliteral">&quot;Snapshot format version read was %u, but this code can &quot;</span>
<a name="l02539"></a>02539                       <span class="stringliteral">&quot;only read version 1&quot;</span>,
<a name="l02540"></a>02540                       version);
<a name="l02541"></a>02541             }
<a name="l02542"></a>02542         }
<a name="l02543"></a>02543 
<a name="l02544"></a>02544         <span class="comment">// load header contents</span>
<a name="l02545"></a>02545         SnapshotMetadata::Header header;
<a name="l02546"></a>02546         std::string error = reader-&gt;readMessage(header);
<a name="l02547"></a>02547         <span class="keywordflow">if</span> (!error.empty()) {
<a name="l02548"></a>02548             <a class="code" href="Core_2Debug_8h.html#ad84b0f521394f4d9214c9d185711a8c3" title="Log an ERROR message and abort the process.">PANIC</a>(<span class="stringliteral">&quot;Couldn&#39;t read snapshot header: %s&quot;</span>, error.c_str());
<a name="l02549"></a>02549         }
<a name="l02550"></a>02550         <span class="keywordflow">if</span> (header.last_included_index() &lt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>) {
<a name="l02551"></a>02551             <a class="code" href="Core_2Debug_8h.html#ad84b0f521394f4d9214c9d185711a8c3" title="Log an ERROR message and abort the process.">PANIC</a>(<span class="stringliteral">&quot;Trying to load a snapshot that is more stale than one this &quot;</span>
<a name="l02552"></a>02552                   <span class="stringliteral">&quot;server loaded earlier. The earlier snapshot covers through &quot;</span>
<a name="l02553"></a>02553                   <span class="stringliteral">&quot;log index %lu (inclusive); this one covers through log &quot;</span>
<a name="l02554"></a>02554                   <span class="stringliteral">&quot;index %lu (inclusive)&quot;</span>,
<a name="l02555"></a>02555                   <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>,
<a name="l02556"></a>02556                   header.last_included_index());
<a name="l02557"></a>02557 
<a name="l02558"></a>02558         }
<a name="l02559"></a>02559         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a> = header.last_included_index();
<a name="l02560"></a>02560         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5f0c55552abd43fa5b1ffe779f70fcf9" title="The term of the last entry covered by the latest good snapshot, or 0 if we have no snapshot...">lastSnapshotTerm</a> = header.last_included_term();
<a name="l02561"></a>02561         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#af98e037190d928bbe2ecda31a19ca7c2" title="The cluster time of the last entry covered by the latest good snapshot, or 0 if we have no snapshot...">lastSnapshotClusterTime</a> = header.last_cluster_time();
<a name="l02562"></a>02562         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a3f14561ea354f31be363ab7f008b9961" title="The size of the latest good snapshot in bytes, or 0 if we have no snapshot.">lastSnapshotBytes</a> = reader-&gt;getSizeBytes();
<a name="l02563"></a>02563         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a> = std::max(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a>);
<a name="l02564"></a>02564 
<a name="l02565"></a>02565         <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Reading snapshot which covers log entries 1 through %lu &quot;</span>
<a name="l02566"></a>02566                <span class="stringliteral">&quot;(inclusive)&quot;</span>, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>);
<a name="l02567"></a>02567 
<a name="l02568"></a>02568         <span class="comment">// We should keep log entries if they might be needed for a quorum. So:</span>
<a name="l02569"></a>02569         <span class="comment">// 1. Discard log if it is shorter than the snapshot.</span>
<a name="l02570"></a>02570         <span class="comment">// 2. Discard log if its lastSnapshotIndex entry disagrees with the</span>
<a name="l02571"></a>02571         <span class="comment">//    lastSnapshotTerm.</span>
<a name="l02572"></a>02572         <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex() &lt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a> ||
<a name="l02573"></a>02573             (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLogStartIndex() &lt;= <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a> &amp;&amp;
<a name="l02574"></a>02574              <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getEntry(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>).term() != <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5f0c55552abd43fa5b1ffe779f70fcf9" title="The term of the last entry covered by the latest good snapshot, or 0 if we have no snapshot...">lastSnapshotTerm</a>)) {
<a name="l02575"></a>02575             <span class="comment">// The NOTICE message can be confusing if the log is empty, so</span>
<a name="l02576"></a>02576             <span class="comment">// don&#39;t print it in that case. We still want to shift the log</span>
<a name="l02577"></a>02577             <span class="comment">// start index, though.</span>
<a name="l02578"></a>02578             <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLogStartIndex() &lt;= <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex()) {
<a name="l02579"></a>02579                 <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Discarding the entire log, since it&#39;s not known to be &quot;</span>
<a name="l02580"></a>02580                        <span class="stringliteral">&quot;consistent with the snapshot that is being read&quot;</span>);
<a name="l02581"></a>02581             }
<a name="l02582"></a>02582             <span class="comment">// Discard the entire log, setting the log start to point to the</span>
<a name="l02583"></a>02583             <span class="comment">// right place.</span>
<a name="l02584"></a>02584             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;truncatePrefix(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a> + 1);
<a name="l02585"></a>02585             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;truncateSuffix(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>);
<a name="l02586"></a>02586             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ade5bbdec3e8ff60b7931a2682b2bb4ef" title="Ensures that &#39;configuration&#39; reflects the latest state of the log and snapshot.">configurationManager</a>-&gt;truncatePrefix(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a> + 1);
<a name="l02587"></a>02587             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ade5bbdec3e8ff60b7931a2682b2bb4ef" title="Ensures that &#39;configuration&#39; reflects the latest state of the log and snapshot.">configurationManager</a>-&gt;truncateSuffix(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>);
<a name="l02588"></a>02588             <span class="comment">// Clean up resources.</span>
<a name="l02589"></a>02589             <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> == State::LEADER) { <span class="comment">// defer log sync</span>
<a name="l02590"></a>02590                 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aa6c06993ed2a50989b453f120cd31aea" title="Flag to indicate that leaderDiskThreadMain should flush recent log writes to stable storage...">logSyncQueued</a> = <span class="keyword">true</span>;
<a name="l02591"></a>02591             } <span class="keywordflow">else</span> { <span class="comment">// sync log now</span>
<a name="l02592"></a>02592                 std::unique_ptr&lt;Log::Sync&gt; sync = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;takeSync();
<a name="l02593"></a>02593                 sync-&gt;wait();
<a name="l02594"></a>02594                 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;syncComplete(std::move(sync));
<a name="l02595"></a>02595             }
<a name="l02596"></a>02596             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aa525cfc8dac0abdc8f744f5bd75302ae" title="Tracks the passage of &quot;cluster time&quot;.">clusterClock</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#ad5adb9f0618aeb7a7a55e1524849a8bc" title="Reset to the given cluster time, assuming it&#39;s the current time right now.">newEpoch</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#af98e037190d928bbe2ecda31a19ca7c2" title="The cluster time of the last entry covered by the latest good snapshot, or 0 if we have no snapshot...">lastSnapshotClusterTime</a>);
<a name="l02597"></a>02597         }
<a name="l02598"></a>02598 
<a name="l02599"></a>02599         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#af98ae4ff770b37572783ee33946fb0b7" title="Remove the prefix of the log that is redundant with this server&#39;s snapshot.">discardUnneededEntries</a>();
<a name="l02600"></a>02600 
<a name="l02601"></a>02601         <span class="keywordflow">if</span> (header.has_configuration_index() &amp;&amp; header.has_configuration()) {
<a name="l02602"></a>02602             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ade5bbdec3e8ff60b7931a2682b2bb4ef" title="Ensures that &#39;configuration&#39; reflects the latest state of the log and snapshot.">configurationManager</a>-&gt;setSnapshot(header.configuration_index(),
<a name="l02603"></a>02603                                               header.configuration());
<a name="l02604"></a>02604         } <span class="keywordflow">else</span> {
<a name="l02605"></a>02605             <a class="code" href="Core_2Debug_8h.html#ad51176fec84ca79bd96163c9cb5a7c32" title="Log a WARNING message.">WARNING</a>(<span class="stringliteral">&quot;No configuration. This is unexpected, since any snapshot &quot;</span>
<a name="l02606"></a>02606                     <span class="stringliteral">&quot;should contain a configuration (they&#39;re the first thing &quot;</span>
<a name="l02607"></a>02607                     <span class="stringliteral">&quot;found in any log).&quot;</span>);
<a name="l02608"></a>02608         }
<a name="l02609"></a>02609 
<a name="l02610"></a>02610         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#a66990e7e4f8fd459a7311ce86800e5e7">notify_all</a>();
<a name="l02611"></a>02611     }
<a name="l02612"></a>02612     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLogStartIndex() &gt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a> + 1) {
<a name="l02613"></a>02613         <a class="code" href="Core_2Debug_8h.html#ad84b0f521394f4d9214c9d185711a8c3" title="Log an ERROR message and abort the process.">PANIC</a>(<span class="stringliteral">&quot;The newest snapshot on this server covers up through log index &quot;</span>
<a name="l02614"></a>02614               <span class="stringliteral">&quot;%lu (inclusive), but its log starts at index %lu. This &quot;</span>
<a name="l02615"></a>02615               <span class="stringliteral">&quot;should never happen and indicates a corrupt disk state. If you &quot;</span>
<a name="l02616"></a>02616               <span class="stringliteral">&quot;want this server to participate in your cluster, you should &quot;</span>
<a name="l02617"></a>02617               <span class="stringliteral">&quot;back up all of its state, delete it, and add the server back &quot;</span>
<a name="l02618"></a>02618               <span class="stringliteral">&quot;as a new cluster member using the reconfiguration mechanism.&quot;</span>,
<a name="l02619"></a>02619               <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLogStartIndex());
<a name="l02620"></a>02620     }
<a name="l02621"></a>02621 
<a name="l02622"></a>02622     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a66df54dcef389e690e4e94df391f8120" title="If not NULL, this is a Storage::SnapshotFile::Reader that covers up through lastSnapshotIndex.">snapshotReader</a> = std::move(reader);
<a name="l02623"></a>02623 }
<a name="l02624"></a>02624 
<a name="l02625"></a>02625 std::pair&lt;RaftConsensus::ClientResult, uint64_t&gt;
<a name="l02626"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2d3262b95e156d88b3e239397bad643e">02626</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2d3262b95e156d88b3e239397bad643e" title="Append an entry to the log and wait for it to be committed.">RaftConsensus::replicateEntry</a>(<a class="code" href="classLogCabin_1_1Storage_1_1Log.html#a8ca64ace5d6ae6f0175186c595d4fbe0" title="The type of a log entry (the same format that&#39;s used in AppendEntries).">Log::Entry</a>&amp; entry,
<a name="l02627"></a>02627                               std::unique_lock&lt;Mutex&gt;&amp; lockGuard)
<a name="l02628"></a>02628 {
<a name="l02629"></a>02629     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> == State::LEADER) {
<a name="l02630"></a>02630         entry.set_term(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l02631"></a>02631         entry.set_cluster_time(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aa525cfc8dac0abdc8f744f5bd75302ae" title="Tracks the passage of &quot;cluster time&quot;.">clusterClock</a>.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1ClusterClock.html#acfeeb3627de0308d4259324b78b7d84a" title="Called by leaders to generate a new cluster time for a new log entry.">leaderStamp</a>());
<a name="l02632"></a>02632         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aab0f5ebde52053a9de31a575093dc098" title="Append entries to the log, set the configuration if this contains a configuration entry...">append</a>({&amp;entry});
<a name="l02633"></a>02633         uint64_t index = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex();
<a name="l02634"></a>02634         <span class="keywordflow">while</span> (!<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a7f8cdeb3a67e3398cca54f23eb5022a6" title="Set to true when this class is about to be destroyed.">exiting</a> &amp;&amp; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a> == entry.term()) {
<a name="l02635"></a>02635             <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a> &gt;= index) {
<a name="l02636"></a>02636                 <a class="code" href="Core_2Debug_8h.html#a77e5c931f41ca7e1792ddfa762d38473" title="Log a VERBOSE message.">VERBOSE</a>(<span class="stringliteral">&quot;replicate succeeded&quot;</span>);
<a name="l02637"></a>02637                 <span class="keywordflow">return</span> {<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2e798f8f5febb02f25e027eccac8496aa0b5aa96f6ed35c5c9a026c47b2245850" title="Request completed successfully.">ClientResult::SUCCESS</a>, index};
<a name="l02638"></a>02638             }
<a name="l02639"></a>02639             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#aedc8162c9f0251ae3491e6bc6efbe477">wait</a>(lockGuard);
<a name="l02640"></a>02640         }
<a name="l02641"></a>02641     }
<a name="l02642"></a>02642     <span class="keywordflow">return</span> {<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2e798f8f5febb02f25e027eccac8496aaf0c9dacaac36992bfc8db3368a4128c4" title="Cannot process the request because this server is not leader or temporarily lost its leadership...">ClientResult::NOT_LEADER</a>, 0};
<a name="l02643"></a>02643 }
<a name="l02644"></a>02644 
<a name="l02645"></a>02645 <span class="keywordtype">void</span>
<a name="l02646"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5e86b884554e94732ba8b6445e0278c3">02646</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5e86b884554e94732ba8b6445e0278c3" title="Send a RequestVote RPC to the server.">RaftConsensus::requestVote</a>(std::unique_lock&lt;Mutex&gt;&amp; lockGuard, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html" title="Represents another server in the cluster.">Peer</a>&amp; peer)
<a name="l02647"></a>02647 {
<a name="l02648"></a>02648     Protocol::Raft::RequestVote::Request request;
<a name="l02649"></a>02649     request.set_server_id(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a32b5b6a4d6ae35dcd20c8ba3e7a95de0" title="This server&#39;s unique ID.">serverId</a>);
<a name="l02650"></a>02650     request.set_term(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l02651"></a>02651     request.set_last_log_term(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ab66363f61f7c6b5dbd298da6d594cca7" title="Return the term corresponding to log-&gt;getLastLogIndex().">getLastLogTerm</a>());
<a name="l02652"></a>02652     request.set_last_log_index(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLastLogIndex());
<a name="l02653"></a>02653 
<a name="l02654"></a>02654     Protocol::Raft::RequestVote::Response response;
<a name="l02655"></a>02655     <a class="code" href="Core_2Debug_8h.html#a77e5c931f41ca7e1792ddfa762d38473" title="Log a VERBOSE message.">VERBOSE</a>(<span class="stringliteral">&quot;requestVote start&quot;</span>);
<a name="l02656"></a>02656     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#adadb64ccb66627454e6001aca18dc801">TimePoint</a> start = <a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a13f545c6020dd190e13d21e2577cc59b">Clock::now</a>();
<a name="l02657"></a>02657     uint64_t epoch = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1ab1473657769c339579f02f7e454513" title="A logical clock used to confirm leadership and connectivity.">currentEpoch</a>;
<a name="l02658"></a>02658     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a0548ee7eb046a903349a22ff0a3c7bda" title="Returned by callRPC().">Peer::CallStatus</a> status = peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a4305e63041b96ea33cb28deaf2378b1c" title="Execute a remote procedure call on the server&#39;s RaftService.">callRPC</a>(
<a name="l02659"></a>02659                 Protocol::Raft::OpCode::REQUEST_VOTE,
<a name="l02660"></a>02660                 request, response,
<a name="l02661"></a>02661                 lockGuard);
<a name="l02662"></a>02662     <a class="code" href="Core_2Debug_8h.html#a77e5c931f41ca7e1792ddfa762d38473" title="Log a VERBOSE message.">VERBOSE</a>(<span class="stringliteral">&quot;requestVote done&quot;</span>);
<a name="l02663"></a>02663     <span class="keywordflow">switch</span> (status) {
<a name="l02664"></a>02664         <span class="keywordflow">case</span> <a class="code" href="namespaceLogCabin_1_1Client.html#a4326ade2a152c568b8a7b7daafadf9b4a7324f75352386fdbcd0e25d926866ad7" title="The operation completed successfully.">Peer::CallStatus::OK</a>:
<a name="l02665"></a>02665             <span class="keywordflow">break</span>;
<a name="l02666"></a>02666         <span class="keywordflow">case</span> Peer::CallStatus::FAILED:
<a name="l02667"></a>02667             peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a8b6511933a555747a4edf9e4cb9f385c" title="The minimum time at which the next RPC should be sent.">backoffUntil</a> = start +
<a name="l02668"></a>02668                 std::chrono::milliseconds(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a8c3ec432979e19052a70bd756ebd5689" title="A candidate or leader waits this long after an RPC fails before sending another one, so as to not overwhelm the network with retries.">RPC_FAILURE_BACKOFF_MS</a>);
<a name="l02669"></a>02669             <span class="keywordflow">return</span>;
<a name="l02670"></a>02670         <span class="keywordflow">case</span> <a class="code" href="namespaceLogCabin_1_1RPC_1_1Protocol.html#a85fb11a499988e97be6f566df469a694aff3e9fbb7614ab1714ea489e399f19ea" title="The server did not like the RPC request.">Peer::CallStatus::INVALID_REQUEST</a>:
<a name="l02671"></a>02671             <a class="code" href="Core_2Debug_8h.html#ad84b0f521394f4d9214c9d185711a8c3" title="Log an ERROR message and abort the process.">PANIC</a>(<span class="stringliteral">&quot;The server&#39;s RaftService doesn&#39;t support the RequestVote &quot;</span>
<a name="l02672"></a>02672                   <span class="stringliteral">&quot;RPC or claims the request is malformed&quot;</span>);
<a name="l02673"></a>02673     }
<a name="l02674"></a>02674 
<a name="l02675"></a>02675     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a> != request.term() || <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> != State::CANDIDATE ||
<a name="l02676"></a>02676         peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#afcc06ccb9c33a32eee1503aa5b1ee205" title="Set to true when thread should exit.">exiting</a>) {
<a name="l02677"></a>02677         <a class="code" href="Core_2Debug_8h.html#a77e5c931f41ca7e1792ddfa762d38473" title="Log a VERBOSE message.">VERBOSE</a>(<span class="stringliteral">&quot;ignore RPC result&quot;</span>);
<a name="l02678"></a>02678         <span class="comment">// we don&#39;t care about result of RPC</span>
<a name="l02679"></a>02679         <span class="keywordflow">return</span>;
<a name="l02680"></a>02680     }
<a name="l02681"></a>02681 
<a name="l02682"></a>02682     <span class="keywordflow">if</span> (response.term() &gt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>) {
<a name="l02683"></a>02683         <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Received RequestVote response from server %lu in &quot;</span>
<a name="l02684"></a>02684                <span class="stringliteral">&quot;term %lu (this server&#39;s term was %lu)&quot;</span>,
<a name="l02685"></a>02685                 peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#ac1b2d6d134b4c41baf0220a0c6e587b7" title="The ID of this server.">serverId</a>, response.term(), <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l02686"></a>02686         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a284075bb503d0b8efb9c217a257dadc5" title="Transition to being a follower.">stepDown</a>(response.term());
<a name="l02687"></a>02687     } <span class="keywordflow">else</span> {
<a name="l02688"></a>02688         peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#ac4a82cf70a21989f2f59505281647c3f" title="Set to true if the server has responded to our RequestVote request in the current term...">requestVoteDone</a> = <span class="keyword">true</span>;
<a name="l02689"></a>02689         peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a3ac99d0f0a94203643ac72cf4e4c0e69" title="See getLastAckEpoch().">lastAckEpoch</a> = epoch;
<a name="l02690"></a>02690         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#a66990e7e4f8fd459a7311ce86800e5e7">notify_all</a>();
<a name="l02691"></a>02691 
<a name="l02692"></a>02692         <span class="keywordflow">if</span> (response.granted()) {
<a name="l02693"></a>02693             peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Peer.html#a57b21af23dcbefa804c9c962591e5025" title="See haveVote().">haveVote_</a> = <span class="keyword">true</span>;
<a name="l02694"></a>02694             <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Got vote from server %lu for term %lu&quot;</span>,
<a name="l02695"></a>02695                    peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#ac1b2d6d134b4c41baf0220a0c6e587b7" title="The ID of this server.">serverId</a>, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l02696"></a>02696             <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;quorumAll(&amp;<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#a0651a28c215025bab21d9617b20544ff" title="Return true if this Server has awarded us its vote for this term.">Server::haveVote</a>))
<a name="l02697"></a>02697                 <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a98f5665fc16c382da7a161d9c62b420c" title="Transition to being a leader.">becomeLeader</a>();
<a name="l02698"></a>02698         } <span class="keywordflow">else</span> {
<a name="l02699"></a>02699             <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Vote denied by server %lu for term %lu&quot;</span>,
<a name="l02700"></a>02700                    peer.<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#ac1b2d6d134b4c41baf0220a0c6e587b7" title="The ID of this server.">serverId</a>, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l02701"></a>02701         }
<a name="l02702"></a>02702     }
<a name="l02703"></a>02703 }
<a name="l02704"></a>02704 
<a name="l02705"></a>02705 <span class="keywordtype">void</span>
<a name="l02706"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ac307cba21a66a55c0edc29d6e094ec7a">02706</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ac307cba21a66a55c0edc29d6e094ec7a" title="Set the timer to start a new election and notify stateChanged.">RaftConsensus::setElectionTimer</a>()
<a name="l02707"></a>02707 {
<a name="l02708"></a>02708     uint64_t ms = <a class="code" href="namespaceLogCabin_1_1Core_1_1Random.html#af8e82c49f7a898ab54ed0b18a89a5419" title="Return a random integer between start and end, inclusive.">Core::Random::randomRange</a>(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5a76d9fce7cc8e8bd69bcf059b89ad93" title="A follower waits for about this much inactivity before becoming a candidate and starting a new electi...">ELECTION_TIMEOUT_MS</a>,
<a name="l02709"></a>02709                                             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5a76d9fce7cc8e8bd69bcf059b89ad93" title="A follower waits for about this much inactivity before becoming a candidate and starting a new electi...">ELECTION_TIMEOUT_MS</a> * 2);
<a name="l02710"></a>02710     <a class="code" href="Core_2Debug_8h.html#a77e5c931f41ca7e1792ddfa762d38473" title="Log a VERBOSE message.">VERBOSE</a>(<span class="stringliteral">&quot;Will become candidate in %lu ms&quot;</span>, ms);
<a name="l02711"></a>02711     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a3528d66b8409ca51a4392d7c3f395d39" title="The earliest time at which timerThread should begin a new election with startNewElection().">startElectionAt</a> = <a class="code" href="structLogCabin_1_1Core_1_1Time_1_1MockableClock.html#a13f545c6020dd190e13d21e2577cc59b">Clock::now</a>() + std::chrono::milliseconds(ms);
<a name="l02712"></a>02712     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#a66990e7e4f8fd459a7311ce86800e5e7">notify_all</a>();
<a name="l02713"></a>02713 }
<a name="l02714"></a>02714 
<a name="l02715"></a>02715 <span class="keywordtype">void</span>
<a name="l02716"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acfe558f9de36a467f22e24dbb07b38fd">02716</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acfe558f9de36a467f22e24dbb07b38fd" title="Dumps serverId, currentTerm, state, leaderId, and votedFor to the debug log.">RaftConsensus::printElectionState</a>()<span class="keyword"> const</span>
<a name="l02717"></a>02717 <span class="keyword"></span>{
<a name="l02718"></a>02718     <span class="keyword">const</span> <span class="keywordtype">char</span>* s = NULL;
<a name="l02719"></a>02719     <span class="keywordflow">switch</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a>) {
<a name="l02720"></a>02720         <span class="keywordflow">case</span> State::FOLLOWER:
<a name="l02721"></a>02721             s = <span class="stringliteral">&quot;FOLLOWER, &quot;</span>;
<a name="l02722"></a>02722             <span class="keywordflow">break</span>;
<a name="l02723"></a>02723         <span class="keywordflow">case</span> State::CANDIDATE:
<a name="l02724"></a>02724             s = <span class="stringliteral">&quot;CANDIDATE,&quot;</span>;
<a name="l02725"></a>02725             <span class="keywordflow">break</span>;
<a name="l02726"></a>02726         <span class="keywordflow">case</span> State::LEADER:
<a name="l02727"></a>02727             s = <span class="stringliteral">&quot;LEADER,   &quot;</span>;
<a name="l02728"></a>02728             <span class="keywordflow">break</span>;
<a name="l02729"></a>02729     }
<a name="l02730"></a>02730     <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;server=%lu, term=%lu, state=%s leader=%lu, vote=%lu&quot;</span>,
<a name="l02731"></a>02731            <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a32b5b6a4d6ae35dcd20c8ba3e7a95de0" title="This server&#39;s unique ID.">serverId</a>,
<a name="l02732"></a>02732            <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>,
<a name="l02733"></a>02733            s,
<a name="l02734"></a>02734            <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae3f2b58c62af497eb474046566656f67" title="The server ID of the leader for this term.">leaderId</a>,
<a name="l02735"></a>02735            <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1add1a4497b990f9f4b053266459b59d" title="The server ID that this server voted for during this term&#39;s election, if any.">votedFor</a>);
<a name="l02736"></a>02736 }
<a name="l02737"></a>02737 
<a name="l02738"></a>02738 <span class="keywordtype">void</span>
<a name="l02739"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2d9850882643fd6df30cf42e985258be">02739</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2d9850882643fd6df30cf42e985258be" title="Transitions to being a candidate from being a follower or candidate.">RaftConsensus::startNewElection</a>()
<a name="l02740"></a>02740 {
<a name="l02741"></a>02741     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;id == 0) {
<a name="l02742"></a>02742         <span class="comment">// Don&#39;t have a configuration: go back to sleep.</span>
<a name="l02743"></a>02743         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ac307cba21a66a55c0edc29d6e094ec7a" title="Set the timer to start a new election and notify stateChanged.">setElectionTimer</a>();
<a name="l02744"></a>02744         <span class="keywordflow">return</span>;
<a name="l02745"></a>02745     }
<a name="l02746"></a>02746 
<a name="l02747"></a>02747     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae3f2b58c62af497eb474046566656f67" title="The server ID of the leader for this term.">leaderId</a> &gt; 0) {
<a name="l02748"></a>02748         <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Running for election in term %lu &quot;</span>
<a name="l02749"></a>02749                <span class="stringliteral">&quot;(haven&#39;t heard from leader %lu lately)&quot;</span>,
<a name="l02750"></a>02750                <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a> + 1,
<a name="l02751"></a>02751                <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae3f2b58c62af497eb474046566656f67" title="The server ID of the leader for this term.">leaderId</a>);
<a name="l02752"></a>02752     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> == State::CANDIDATE) {
<a name="l02753"></a>02753         <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Running for election in term %lu &quot;</span>
<a name="l02754"></a>02754                <span class="stringliteral">&quot;(previous candidacy for term %lu timed out)&quot;</span>,
<a name="l02755"></a>02755                <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a> + 1,
<a name="l02756"></a>02756                <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l02757"></a>02757     } <span class="keywordflow">else</span> {
<a name="l02758"></a>02758         <a class="code" href="Core_2Debug_8h.html#a383cf896bc43bafb5ad7ef2853696de7" title="Log a NOTICE message.">NOTICE</a>(<span class="stringliteral">&quot;Running for election in term %lu&quot;</span>,
<a name="l02759"></a>02759                <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a> + 1);
<a name="l02760"></a>02760     }
<a name="l02761"></a>02761     ++<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>;
<a name="l02762"></a>02762     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a8a1270561380477170b6c7447705d74fa53ca7845299f8205646e7037a041a0b5" title="A candidate sends RequestVote RPCs in an attempt to become a leader.">State::CANDIDATE</a>;
<a name="l02763"></a>02763     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae3f2b58c62af497eb474046566656f67" title="The server ID of the leader for this term.">leaderId</a> = 0;
<a name="l02764"></a>02764     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1add1a4497b990f9f4b053266459b59d" title="The server ID that this server voted for during this term&#39;s election, if any.">votedFor</a> = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a32b5b6a4d6ae35dcd20c8ba3e7a95de0" title="This server&#39;s unique ID.">serverId</a>;
<a name="l02765"></a>02765     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acfe558f9de36a467f22e24dbb07b38fd" title="Dumps serverId, currentTerm, state, leaderId, and votedFor to the debug log.">printElectionState</a>();
<a name="l02766"></a>02766     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ac307cba21a66a55c0edc29d6e094ec7a" title="Set the timer to start a new election and notify stateChanged.">setElectionTimer</a>();
<a name="l02767"></a>02767     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;forEach(&amp;<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#aab43402fe28b4fac77a2a53da7f7c779" title="Begin requesting the Server&#39;s vote in the current election.">Server::beginRequestVote</a>);
<a name="l02768"></a>02768     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a750be73694a5e22bffc9c62f61cbb779" title="This is used in handleInstallSnapshot when receiving a snapshot from the current leader.">snapshotWriter</a>) {
<a name="l02769"></a>02769         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a750be73694a5e22bffc9c62f61cbb779" title="This is used in handleInstallSnapshot when receiving a snapshot from the current leader.">snapshotWriter</a>-&gt;discard();
<a name="l02770"></a>02770         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a750be73694a5e22bffc9c62f61cbb779" title="This is used in handleInstallSnapshot when receiving a snapshot from the current leader.">snapshotWriter</a>.reset();
<a name="l02771"></a>02771     }
<a name="l02772"></a>02772     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97717592e5ac7db5c59591bd651deff8" title="Persist critical state, such as the term and the vote, to stable storage.">updateLogMetadata</a>();
<a name="l02773"></a>02773     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae59f81b29757ea16583034c975e952cf" title="Notify the stateChanged condition variable and cancel all current RPCs.">interruptAll</a>();
<a name="l02774"></a>02774 
<a name="l02775"></a>02775     <span class="comment">// if we&#39;re the only server, this election is already done</span>
<a name="l02776"></a>02776     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;quorumAll(&amp;<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#a0651a28c215025bab21d9617b20544ff" title="Return true if this Server has awarded us its vote for this term.">Server::haveVote</a>))
<a name="l02777"></a>02777         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a98f5665fc16c382da7a161d9c62b420c" title="Transition to being a leader.">becomeLeader</a>();
<a name="l02778"></a>02778 }
<a name="l02779"></a>02779 
<a name="l02780"></a>02780 <span class="keywordtype">void</span>
<a name="l02781"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a284075bb503d0b8efb9c217a257dadc5">02781</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a284075bb503d0b8efb9c217a257dadc5" title="Transition to being a follower.">RaftConsensus::stepDown</a>(uint64_t newTerm)
<a name="l02782"></a>02782 {
<a name="l02783"></a>02783     assert(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a> &lt;= newTerm);
<a name="l02784"></a>02784     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a> &lt; newTerm) {
<a name="l02785"></a>02785         <a class="code" href="Core_2Debug_8h.html#a77e5c931f41ca7e1792ddfa762d38473" title="Log a VERBOSE message.">VERBOSE</a>(<span class="stringliteral">&quot;stepDown(%lu)&quot;</span>, newTerm);
<a name="l02786"></a>02786         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a> = newTerm;
<a name="l02787"></a>02787         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae3f2b58c62af497eb474046566656f67" title="The server ID of the leader for this term.">leaderId</a> = 0;
<a name="l02788"></a>02788         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1add1a4497b990f9f4b053266459b59d" title="The server ID that this server voted for during this term&#39;s election, if any.">votedFor</a> = 0;
<a name="l02789"></a>02789         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97717592e5ac7db5c59591bd651deff8" title="Persist critical state, such as the term and the vote, to stable storage.">updateLogMetadata</a>();
<a name="l02790"></a>02790         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;resetStagingServers();
<a name="l02791"></a>02791         <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a750be73694a5e22bffc9c62f61cbb779" title="This is used in handleInstallSnapshot when receiving a snapshot from the current leader.">snapshotWriter</a>) {
<a name="l02792"></a>02792             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a750be73694a5e22bffc9c62f61cbb779" title="This is used in handleInstallSnapshot when receiving a snapshot from the current leader.">snapshotWriter</a>-&gt;discard();
<a name="l02793"></a>02793             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a750be73694a5e22bffc9c62f61cbb779" title="This is used in handleInstallSnapshot when receiving a snapshot from the current leader.">snapshotWriter</a>.reset();
<a name="l02794"></a>02794         }
<a name="l02795"></a>02795         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a8a1270561380477170b6c7447705d74fa589983a6c56c8a49a9dac22184a0e0e7" title="A follower does not initiate RPCs.">State::FOLLOWER</a>;
<a name="l02796"></a>02796         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acfe558f9de36a467f22e24dbb07b38fd" title="Dumps serverId, currentTerm, state, leaderId, and votedFor to the debug log.">printElectionState</a>();
<a name="l02797"></a>02797     } <span class="keywordflow">else</span> {
<a name="l02798"></a>02798         <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> != State::FOLLOWER) {
<a name="l02799"></a>02799             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a8a1270561380477170b6c7447705d74fa589983a6c56c8a49a9dac22184a0e0e7" title="A follower does not initiate RPCs.">State::FOLLOWER</a>;
<a name="l02800"></a>02800             <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acfe558f9de36a467f22e24dbb07b38fd" title="Dumps serverId, currentTerm, state, leaderId, and votedFor to the debug log.">printElectionState</a>();
<a name="l02801"></a>02801         }
<a name="l02802"></a>02802     }
<a name="l02803"></a>02803     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a3528d66b8409ca51a4392d7c3f395d39" title="The earliest time at which timerThread should begin a new election with startNewElection().">startElectionAt</a> == TimePoint::max()) <span class="comment">// was leader</span>
<a name="l02804"></a>02804         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ac307cba21a66a55c0edc29d6e094ec7a" title="Set the timer to start a new election and notify stateChanged.">setElectionTimer</a>();
<a name="l02805"></a>02805     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a075b1f3174db6673435f31622c231d02" title="The earliest time at which RequestVote messages should be processed.">withholdVotesUntil</a> == TimePoint::max()) <span class="comment">// was leader</span>
<a name="l02806"></a>02806         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a075b1f3174db6673435f31622c231d02" title="The earliest time at which RequestVote messages should be processed.">withholdVotesUntil</a> = TimePoint::min();
<a name="l02807"></a>02807     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#ae59f81b29757ea16583034c975e952cf" title="Notify the stateChanged condition variable and cancel all current RPCs.">interruptAll</a>();
<a name="l02808"></a>02808 
<a name="l02809"></a>02809     <span class="comment">// If the leader disk thread is currently writing to disk, wait for it to</span>
<a name="l02810"></a>02810     <span class="comment">// finish. We poll here because we don&#39;t want to release the lock (this</span>
<a name="l02811"></a>02811     <span class="comment">// server would then believe its writes have been flushed when they</span>
<a name="l02812"></a>02812     <span class="comment">// haven&#39;t).</span>
<a name="l02813"></a>02813     <span class="keywordflow">while</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a3f885e618c137506f3e0da0fdbe4b13d" title="Used for stepDown() to wait on leaderDiskThread without releasing mutex.">leaderDiskThreadWorking</a>)
<a name="l02814"></a>02814         usleep(500);
<a name="l02815"></a>02815 
<a name="l02816"></a>02816     <span class="comment">// If a recent append has been queued, empty it here. Do this after waiting</span>
<a name="l02817"></a>02817     <span class="comment">// for leaderDiskThread to preserve FIFO ordering of Log::Sync objects.</span>
<a name="l02818"></a>02818     <span class="comment">// Don&#39;t bother updating the localServer&#39;s lastSyncedIndex, since it</span>
<a name="l02819"></a>02819     <span class="comment">// doesn&#39;t matter for non-leaders.</span>
<a name="l02820"></a>02820     <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aa6c06993ed2a50989b453f120cd31aea" title="Flag to indicate that leaderDiskThreadMain should flush recent log writes to stable storage...">logSyncQueued</a>) {
<a name="l02821"></a>02821         std::unique_ptr&lt;Log::Sync&gt; sync = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;takeSync();
<a name="l02822"></a>02822         sync-&gt;wait();
<a name="l02823"></a>02823         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;syncComplete(std::move(sync));
<a name="l02824"></a>02824         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#aa6c06993ed2a50989b453f120cd31aea" title="Flag to indicate that leaderDiskThreadMain should flush recent log writes to stable storage...">logSyncQueued</a> = <span class="keyword">false</span>;
<a name="l02825"></a>02825     }
<a name="l02826"></a>02826 }
<a name="l02827"></a>02827 
<a name="l02828"></a>02828 <span class="keywordtype">void</span>
<a name="l02829"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97717592e5ac7db5c59591bd651deff8">02829</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97717592e5ac7db5c59591bd651deff8" title="Persist critical state, such as the term and the vote, to stable storage.">RaftConsensus::updateLogMetadata</a>()
<a name="l02830"></a>02830 {
<a name="l02831"></a>02831     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;metadata.set_current_term(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>);
<a name="l02832"></a>02832     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;metadata.set_voted_for(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1add1a4497b990f9f4b053266459b59d" title="The server ID that this server voted for during this term&#39;s election, if any.">votedFor</a>);
<a name="l02833"></a>02833     <a class="code" href="Core_2Debug_8h.html#a77e5c931f41ca7e1792ddfa762d38473" title="Log a VERBOSE message.">VERBOSE</a>(<span class="stringliteral">&quot;updateMetadata start&quot;</span>);
<a name="l02834"></a>02834     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;updateMetadata();
<a name="l02835"></a>02835     <a class="code" href="Core_2Debug_8h.html#a77e5c931f41ca7e1792ddfa762d38473" title="Log a VERBOSE message.">VERBOSE</a>(<span class="stringliteral">&quot;updateMetadata end&quot;</span>);
<a name="l02836"></a>02836 }
<a name="l02837"></a>02837 
<a name="l02838"></a>02838 <span class="keywordtype">bool</span>
<a name="l02839"></a><a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a083099431c4dd8bdb9985027a7385861">02839</a> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a083099431c4dd8bdb9985027a7385861" title="Return true if every entry that might have already been marked committed on any leader is marked comm...">RaftConsensus::upToDateLeader</a>(std::unique_lock&lt;Mutex&gt;&amp; lockGuard)<span class="keyword"> const</span>
<a name="l02840"></a>02840 <span class="keyword"></span>{
<a name="l02841"></a>02841     ++<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1ab1473657769c339579f02f7e454513" title="A logical clock used to confirm leadership and connectivity.">currentEpoch</a>;
<a name="l02842"></a>02842     uint64_t epoch = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a1ab1473657769c339579f02f7e454513" title="A logical clock used to confirm leadership and connectivity.">currentEpoch</a>;
<a name="l02843"></a>02843     <span class="comment">// schedule a heartbeat now so that this returns quickly</span>
<a name="l02844"></a>02844     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;forEach(&amp;<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#a33c58fbb1b5f1b39cfd9cd941ab2b153" title="Make the next heartbeat RPC happen soon.">Server::scheduleHeartbeat</a>);
<a name="l02845"></a>02845     <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#a66990e7e4f8fd459a7311ce86800e5e7">notify_all</a>();
<a name="l02846"></a>02846     <span class="keywordflow">while</span> (<span class="keyword">true</span>) {
<a name="l02847"></a>02847         <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a7f8cdeb3a67e3398cca54f23eb5022a6" title="Set to true when this class is about to be destroyed.">exiting</a> || <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a637ff4c51a73404603c10fb96dbd4b43" title="The server&#39;s current role in the cluster (follower, candidate, or leader).">state</a> != State::LEADER)
<a name="l02848"></a>02848             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02849"></a>02849         <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a96dd3a7dc3af639ded7aff8cd9a7cc39" title="Defines the servers that are part of the cluster.">configuration</a>-&gt;quorumMin(&amp;<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensusInternal_1_1Server.html#a78554a4aaedbe99eca7dbb652b0ba355" title="Return the latest time this Server acknowledged our current term.">Server::getLastAckEpoch</a>) &gt;= epoch) {
<a name="l02850"></a>02850             <span class="comment">// So we know we&#39;re the current leader, but do we have an</span>
<a name="l02851"></a>02851             <span class="comment">// up-to-date commitIndex yet? What we&#39;d like to check is whether</span>
<a name="l02852"></a>02852             <span class="comment">// the entry&#39;s term at commitIndex matches our currentTerm, but</span>
<a name="l02853"></a>02853             <span class="comment">// snapshots mean that we may not have the entry in our log. Since</span>
<a name="l02854"></a>02854             <span class="comment">// commitIndex &gt;= lastSnapshotIndex, we split into two cases:</span>
<a name="l02855"></a>02855             uint64_t commitTerm;
<a name="l02856"></a>02856             <span class="keywordflow">if</span> (<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a> == <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>) {
<a name="l02857"></a>02857                 commitTerm = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5f0c55552abd43fa5b1ffe779f70fcf9" title="The term of the last entry covered by the latest good snapshot, or 0 if we have no snapshot...">lastSnapshotTerm</a>;
<a name="l02858"></a>02858             } <span class="keywordflow">else</span> {
<a name="l02859"></a>02859                 assert(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a> &gt; <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a5107fe9cb372e379933531a8733ac25f" title="The latest good snapshot covers entries 1 through &#39;lastSnapshotIndex&#39; (inclusive).">lastSnapshotIndex</a>);
<a name="l02860"></a>02860                 assert(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a> &gt;= <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getLogStartIndex());
<a name="l02861"></a>02861                 assert(commitIndex &lt;= log-&gt;getLastLogIndex());
<a name="l02862"></a>02862                 commitTerm = <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#afd35bf6be1f566a9a9e0990a56093620" title="Provides all storage for this server.">log</a>-&gt;getEntry(<a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#acf4fcf7f835b8b2ac372b58ac3be5667" title="The largest entry ID for which a quorum is known to have stored the same entry as this server has...">commitIndex</a>).term();
<a name="l02863"></a>02863             }
<a name="l02864"></a>02864             <span class="keywordflow">if</span> (commitTerm == <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a678b600eff2f9cde078273547b16a08f" title="The latest term this server has seen.">currentTerm</a>)
<a name="l02865"></a>02865                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02866"></a>02866         }
<a name="l02867"></a>02867         <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a97b47be8f306bee7170912932c17ed89" title="Notified when basically anything changes.">stateChanged</a>.<a class="code" href="classLogCabin_1_1Core_1_1ConditionVariable.html#aedc8162c9f0251ae3491e6bc6efbe477">wait</a>(lockGuard);
<a name="l02868"></a>02868     }
<a name="l02869"></a>02869 }
<a name="l02870"></a>02870 
<a name="l02871"></a>02871 std::ostream&amp;
<a name="l02872"></a><a class="code" href="namespaceLogCabin_1_1Server.html#a3acf4f75c9386de36515a35177c43e82">02872</a> <a class="code" href="namespaceLogCabin_1_1Server.html#ab9983b72b5cc28f2c8dae1ce8803adad">operator&lt;&lt;</a>(std::ostream&amp; os, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2e798f8f5febb02f25e027eccac8496a">RaftConsensus::ClientResult</a> clientResult)
<a name="l02873"></a>02873 {
<a name="l02874"></a>02874     <span class="keyword">typedef</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a2e798f8f5febb02f25e027eccac8496a">RaftConsensus::ClientResult</a> ClientResult;
<a name="l02875"></a>02875     <span class="keywordflow">switch</span> (clientResult) {
<a name="l02876"></a>02876         <span class="keywordflow">case</span> ClientResult::SUCCESS:
<a name="l02877"></a>02877             os &lt;&lt; <span class="stringliteral">&quot;ClientResult::SUCCESS&quot;</span>;
<a name="l02878"></a>02878             <span class="keywordflow">break</span>;
<a name="l02879"></a>02879         <span class="keywordflow">case</span> ClientResult::FAIL:
<a name="l02880"></a>02880             os &lt;&lt; <span class="stringliteral">&quot;ClientResult::FAIL&quot;</span>;
<a name="l02881"></a>02881             <span class="keywordflow">break</span>;
<a name="l02882"></a>02882         <span class="keywordflow">case</span> ClientResult::RETRY:
<a name="l02883"></a>02883             os &lt;&lt; <span class="stringliteral">&quot;ClientResult::RETRY&quot;</span>;
<a name="l02884"></a>02884             <span class="keywordflow">break</span>;
<a name="l02885"></a>02885         <span class="keywordflow">case</span> ClientResult::NOT_LEADER:
<a name="l02886"></a>02886             os &lt;&lt; <span class="stringliteral">&quot;ClientResult::NOT_LEADER&quot;</span>;
<a name="l02887"></a>02887             <span class="keywordflow">break</span>;
<a name="l02888"></a>02888     }
<a name="l02889"></a>02889     <span class="keywordflow">return</span> os;
<a name="l02890"></a>02890 }
<a name="l02891"></a>02891 
<a name="l02892"></a>02892 std::ostream&amp;
<a name="l02893"></a><a class="code" href="namespaceLogCabin_1_1Server.html#af8e30432357d23f2ae72abced1d2613d">02893</a> <a class="code" href="namespaceLogCabin_1_1Server.html#ab9983b72b5cc28f2c8dae1ce8803adad">operator&lt;&lt;</a>(std::ostream&amp; os, <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a8a1270561380477170b6c7447705d74f" title="See state.">RaftConsensus::State</a> state)
<a name="l02894"></a>02894 {
<a name="l02895"></a>02895     <span class="keyword">typedef</span> <a class="code" href="classLogCabin_1_1Server_1_1RaftConsensus.html#a8a1270561380477170b6c7447705d74f" title="See state.">RaftConsensus::State</a> State;
<a name="l02896"></a>02896     <span class="keywordflow">switch</span> (state) {
<a name="l02897"></a>02897         <span class="keywordflow">case</span> State::FOLLOWER:
<a name="l02898"></a>02898             os &lt;&lt; <span class="stringliteral">&quot;State::FOLLOWER&quot;</span>;
<a name="l02899"></a>02899             <span class="keywordflow">break</span>;
<a name="l02900"></a>02900         <span class="keywordflow">case</span> State::CANDIDATE:
<a name="l02901"></a>02901             os &lt;&lt; <span class="stringliteral">&quot;State::CANDIDATE&quot;</span>;
<a name="l02902"></a>02902             <span class="keywordflow">break</span>;
<a name="l02903"></a>02903         <span class="keywordflow">case</span> State::LEADER:
<a name="l02904"></a>02904             os &lt;&lt; <span class="stringliteral">&quot;State::LEADER&quot;</span>;
<a name="l02905"></a>02905             <span class="keywordflow">break</span>;
<a name="l02906"></a>02906     }
<a name="l02907"></a>02907     <span class="keywordflow">return</span> os;
<a name="l02908"></a>02908 }
<a name="l02909"></a>02909 
<a name="l02910"></a>02910 } <span class="comment">// namespace LogCabin::Server</span>
<a name="l02911"></a>02911 } <span class="comment">// namespace LogCabin</span>
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
